<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Application Design with POE </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content=" Day in and day out, I write large applications in perl. I&#39;m cursed I tell you. While large scale, long-running applications in pure perl may sound fairly easy to write, they are not. Perl, beyond a certain size and..."/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/pub/2004/07/02/poeintro.html/" />
<meta property="og:title" content="Application Design with POE" />
<meta property="og:description" content=" Day in and day out, I write large applications in perl. I&#39;m cursed I tell you. While large scale, long-running applications in pure perl may sound fairly easy to write, they are not. Perl, beyond a certain size and...">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2004-07-07T07:07:07Z" />
<meta property="og:image" content="http://localhost:1313/images/_pub_2004_07_02_poeintro/111-poe.gif" />
<meta property="og:article:tag" content="poe" />
<meta property="og:article:tag" content="session" />
<meta property="og:article:tag" content="thread" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Application Design with POE</h1>
              <p class="blog-post-meta">Jul 2, 2004 by
              
              
                
                
                <a href="#author-bio-matt-cashner">Matt Cashner</a>
              
              </p>
              <img alt="" src=""/>
                

<p>Day in and day out, I write large applications in perl. I&rsquo;m cursed I tell you. While large scale, long-running applications in pure perl may sound fairly easy to write, they are not. Perl, beyond a certain size and complexity, gets really difficult to manage if one is not extremely careful. The proper choice of an application framework helps to minimize this difficulty. For many applications, apache and mod_perl make a lot of sense. This is an excellent choice for user interface applications and data display systems. However, HTML and the WWW simply don&rsquo;t make sense for many forms of long-running applications, particularly network based servers. Apache certainly isn&rsquo;t the right choice for syslog monitoring or edge host traffic analysis.</p>

<p>My framework of choice is POE. POE is a single-threaded, event driven, cooperative multitasking environment for perl. Basically, POE is an application framework in which a single threaded perl process waits for events to occur so it can act accordingly. This event loop comprises the core of a POE process.</p>

<p>If all POE offered was an event loop, there would not be much to talk about though. Nor would POE be particularly special. Several event loop modules already exist on CPAN. Event, Coro, IO::Events, and IO::Poll all offer similar functionality. However, any worthwhile application demands more than a simple set of actions.</p>

<h3 id="span-id-sessions-sessions-span"><span id="SESSIONS">SESSIONS</span></h3>

<p>POE programs begin with a &lsquo;session&rsquo;. Each session represents a cooperatively multi-tasked state machine.</p>

<pre><code>    POE::Session-&gt;create(
        inline_states =&gt; {
            _start =&gt; \&amp;start,
            _stop =&gt; \&amp;stop,

            do_something =&gt; \&amp;do_something,
        },
        heap =&gt; {
            'some' =&gt; 'data',
        },
    );
</code></pre>

<p>Sessions are slightly analogous to threads in that they have a unique runtime context and a semi-private data store (called the &ldquo;heap&rdquo;). Each session operates independently from other sessions, receiving time-slices from the POE kernel. It is important to remember that, despite the similarity to threads, all POE sessions run in the same single-threaded process.</p>

<p>Sessions provide very simple, easy to understand building blocks on which to build more complex applications. POE provides a way to give sessions names, called <em>aliases</em>, which uniquely address the session from outside the session itself. <code>$poe_kernel-&gt;alias_set($alias)</code> sets an alias for the current session. Any POE session in the process can then send events to that session using the named identifier.</p>

<pre><code>    if($door_bell) {
        $poe_kernel-&gt;post( $alias =&gt; 'pizza' );
    }
</code></pre>

<p>Remote addressing provides the ability to have a service-like model inside an application. Different sessions provide different services to the application. One session may provide DNS resolution while another provides data storage. Using commonly known names, perhaps stored in a config file, the central application becomes much smaller and easier to manage.</p>

<h3 id="span-id-components-components-span"><span id="COMPONENTS">COMPONENTS</span></h3>

<p>POE components provide an abstract api to service-like POE sessions. Rather than duplicating the session construction call and the accompanying subroutines every time you find a new use for your sessions, it is a better idea to roll all that code into a perl module.</p>

<pre><code>    package POE::Component::MyService;

    sub create {
        POE::Session-&gt;create(
            # ...
        );
    }

    sub start {
        $poe_kernel-&gt;alias_set(__PACKAGE__);
    }


    ####


    #!/usr/bin/perl
    use POE;
    use POE::Component::MyService;

    POE::Component::MyService-&gt;create();
    POE::Kernel-&gt;run();
</code></pre>

<p>The POE community has created a standard namespace of <code>POE::Component</code> for these modules. Typically they have a constructor called <code>create()</code> or <code>spawn()</code> and provide a service to the POE application via a session. Apart from these few simple rules, components are free to do whatever is necessary to fulfill their purpose. <code>POE::Component::Server::Syslog</code>, for instance, spawns a UDP listener and provides syslog data via callbacks. <code>POE::Component::RSS</code> accepts RSS content via an alias and calls specially named events to deliver data. <code>POE::Component::IRC</code> follows a similar model.</p>

<h3 id="span-id-wheels-wheels-span"><span id="WHEELS">WHEELS</span></h3>

<p>For some tasks, a full session is unnecessary. Sometimes, it makes more sense to alter the abilities of an existing session to provide the desired functionality. POE has a special namespace called <code>POE::Wheel</code> for modules which mutate or alter the abilities of the current session to provide some new functionality.</p>

<pre><code>    package POE::Wheel::MyFunction;

    sub new {
        # ...
    }

    ####

    #!/usr/bin/perl
    use POE;
    use POE::Wheel::MyFunction;

    POE::Session-&gt;create(
        #...
        foo =&gt; \&amp;foo,
    );

    POE::Kernel-&gt;run();

    sub start {
        POE::Wheel::MyFunction-&gt;new(
            FooState =&gt; 'foo'
        );
    }
</code></pre>

<p>Where components often use subroutine callbacks in the same way as <code>POE::Session</code>, wheels use local event names to provide functionality. Internally, they create wrappers around calls to these events which build the context necessary for a POE event to occur.</p>

<p>Wheels are much more complex to create, for good reason. Wheels share their entire operating context with the user&rsquo;s session but share very little of the niceties. Wheels do not have their own heap and cannot create aliases for themselves. In many ways, they are like a parasite clinging to the side of the user&rsquo;s code. As long as they don&rsquo;t get in the way and they provide a useful function, they are allowed to exist.</p>

<p>The development overhead is made up for, however, by the loss of internal POE overhead. Sessions require a certain amount of maintenance to keep running. POE checks sessions to see if they still have work to do, if there are timers or alarms outstanding for them, if they should be garbage collected, etc etc. The more sessions that exist in a system, the more that overhead grows. This overhead is especially noticeable in time sensitive applications. Wheels have none of this overhead. They piggyback on top of the user&rsquo;s session so, apart from any events they may trigger as part of their normal operation, there is no inherent internal POE overhead in using a wheel.</p>

<h3 id="span-id-filters-filters-span"><span id="FILTERS">FILTERS</span></h3>

<p>Many wheels handle incoming and outgoing data. They exist to help the user get data from some strange source (say, HTTP) into a format the user can analyze or take apart in perlish ways. <code>POE::Wheel::SocketFactory</code>, for instance, handles all the scariness of nonblocking socket creation and maintenance. For most of us, however, SocketFactory doesn&rsquo;t go far enough. I don&rsquo;t want to have to worry about pack calls or http headers or whatever other nonsense is necessary to take a transaction off the wire and make it palatable. Special modules in the <code>POE::Filter</code> namespace handle this drudgery.</p>

<pre><code>    package POE::Filter::MyData;

    sub new {
        # ...
    }

    sub put {
        # ...
    }

    sub get {
        # ...
    }
</code></pre>

<p>Filters are very simple data parsing modules. Most POE filters are limited enough to be used outside of a POE environment. They know nothing of POE or of the running POE environment. The standard interface requires three methods: <code>new()</code>, the constructor; <code>get()</code>, the input parser; and <code>put()</code> the output generator. <code>get()</code> takes a stream of data and returns parsed records, which may be hashes, arrays, objects, or anything else one might desire. <code>put()</code> takes user generated records and converts them to raw data.</p>

<h1 id="span-id-design-design-span"><span id="Design">Design</span></h1>

<p>With these four simple building blocks, POE applications can grow to meet almost any need while still being maintainable. The key is to break the application up into small chunks. This is beneficial for two main reasons: 1) the individual chunks are more easily understood by a new staff member or someone else looking at the code six months from now. 2) Smaller blocks of code spend less time &hellip; well, blocking.</p>

<p>As noted above, a POE application is a single-threaded process that pretends to perform asynchronous actions through a technique called cooperative multitasking. At any given time, only one subroutine inside a POE application is executing. If that one subroutine has a <code>sleep 60;</code> inside of it, the entire application will sleep for 60 seconds. No alarms will be triggered; no actions will occur. Smaller blocks of code mean that POE gets a chance to do other actions like cleaning up sessions that are shutting down or executing another event.</p>

<p>Even long-running for-loops can be broken down into small POE events.</p>

<pre><code>    while(@data) {
        # ... process, process
    }
</code></pre>

<p>can become</p>

<pre><code>    $poe_kernel-&gt;yield('process_data' =&gt; $_) for @data;
</code></pre>

<p>This gives POE time to read from sockets, do internal housekeeping, and so on,between each bit of processing time. If <code>@data</code> is large enough, however, this method can lead to resource depletion - spewing out 5000 events to process <code>@data</code> may get the job done and allow POE to do housekeeping, but it means that for the next 5000 event invocations, POE is doing nothing but processing that array.</p>

<p>POE&rsquo;s event queue is a FIFO (First In First Out). Events are processed in the order they are invoked. There are two major exceptions to this. Signals can trigger immediate event processing, and using <code>call()</code> instead of <code>yield()</code> or <code>post()</code> will cause immediate event processing. Beyond those two exceptions, every event happens in order, all of the time.</p>

<p>In the example above, we asked POE to push a large number of events on the queue. While POE can still read off whatever socket we&rsquo;re getting data from inbetween those <code>yield</code>s, the events triggered by that socket read will not be invoked until after we&rsquo;re done processing our giant array. We can break that pattern out very easily.</p>

<p>If we don&rsquo;t need to process <code>@data</code> in any timely fashion, we can stagger the processing out further:</p>

<pre><code>    $poe_kernel-&gt;delay_add('process_data' =&gt; $hence++ =&gt; $_) for @data;
</code></pre>

<p>This will process one chunk of <code>@data</code> every second. Not very efficient or timely but other events can take place between invocations. One second is by no means the smallest time value accepted by <code>delay_add()</code>. Use of <code>Time::HiRes</code> allows for microsecond delay values:</p>

<pre><code>    use Time::HiRes;
    use POE;
</code></pre>

<p>The use of <code>Time::HiRes</code> before importing <code>POE</code> causes POE to use <code>Time::HiRes</code>&rsquo; <code>time()</code> instead of perl&rsquo;s built-in <code>time()</code>. While <code>Time::HiRes</code> has much greater resolution on time values, it may or may not be the most accurate time keeper on your particular platform. Do your homework and make the choice that best suits your situation and needs.</p>

<h1 id="span-id-conclusion-conclusion-span"><span id="Conclusion">Conclusion</span></h1>

<p>POE is a flexible application framework appropriate for long-running large-scale perl applications. It provides standard interfaces for task abstraction and forces the coder to think about their software in smaller, more maintainable chunks.</p>

<p><a href="https://metacpan.org/pod/POE">POE is available on CPAN</a> and has a rich, community-maintained website (<a href="http://poe.perl.org">http://poe.perl.org</a>).</p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/development">development</a></div>
                
                  <div class="tag"><a href="/tags/poe">poe</a></div>
                
                  <div class="tag"><a href="/tags/session">session</a></div>
                
                  <div class="tag"><a href="/tags/thread">thread</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-matt-cashner">
  <div class="col-sm-2">
    
    <a href="/authors/matt-cashner/"><div class="circle-avatar" style="background-image:url(/images/site/avatar.png)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/matt-cashner/"><h3>Matt Cashner</h3></a>
    <p></p>
    <h5><a href="/authors/matt-cashner/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/legacy/_pub_2004_07_02_poeintro.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

