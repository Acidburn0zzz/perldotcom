<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Perl Code Kata: Testing Imports </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Want to get better at Perl? This short exercise helps you understand how modules import symbols into namespaces."/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/pub/2004/12/16/import_kata.html/" />
<meta property="og:title" content="Perl Code Kata: Testing Imports" />
<meta property="og:description" content="Want to get better at Perl? This short exercise helps you understand how modules import symbols into namespaces.">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2004-12-12T12:12:12Z" />
<meta property="og:image" content="http://localhost:1313/images/author/chromatic.jpg" />
<meta property="og:article:tag" content="code-kata" />
<meta property="og:article:tag" content="exporting" />
<meta property="og:article:tag" content="import" />
<meta property="og:article:tag" content="perl-code-kata" />
<meta property="og:article:tag" content="perl-exercises" />
<meta property="og:article:tag" content="perl-modules" />
<meta property="og:article:tag" content="perl-testing" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Perl Code Kata: Testing Imports</h1>
              <p class="blog-post-meta">Dec 16, 2004 by
              
              
                
                
                <a href="#author-bio-chromatic">chromatic</a>
              
              </p>
              <img alt="" src=""/>
                

<p><a href="/pub/2004/10/21/taint_testing_kata.html">Perl Taint Test Kata</a> introduced the idea of Perl Test Kata, small exercises designed to improve your understanding of Perl and your ability to write test-driven code. This article is the second in the series.</p>

<h3 id="import-testing-kata">Import Testing Kata</h3>

<p>Perl 5 added the ideas of namespaces and modules, making code reusable and easier to maintain. To allow convenience, it also added an importing mechanism to put code from a module into the current namespace.</p>

<p>Behind the scenes, when you <code>use</code> a module, Perl loads it from disk and, if successful, calls the special method <code>import()</code>. By convention, this generally imports functions. Much of the time, <code>import()</code> mundanely installs subroutines into the current namespace. That&rsquo;s why so many modules use Exporter to provide a default <code>import()</code>.</p>

<p>However, it&rsquo;s also a general module-loading hook that can perform many different types of manipulations. For example, <a href="https://metacpan.org/pod/Filter::Simple">Filter::Simple</a> allows the use of source filters to transform code that looks entirely unlike Perl into valid code in the using module. Other modules change their behavior depending on any arguments passed to <code>import()</code>. This includes <a href="https://metacpan.org/pod/Test::More">Test::More</a> and <a href="https://metacpan.org/pod/Test::Simple">Test::Simple</a>, which interpret their arguments as information about how many tests to run.</p>

<pre><code>use Test::More 'no_plan';

# or

use Test::More tests =&gt; 100;
</code></pre>

<p>This feature is both powerful and important. Because of its importance, it needs good tests. Because of its power and flexibility, it may seem difficult to test an <code>import()</code> well. Here are three sample implementations for you to practice testing.</p>

<h4 id="basic-exporting">Basic Exporting</h4>

<pre><code>package Basic::Exports;

use strict;

use base 'Exporter';
use vars '@EXPORT';

@EXPORT = qw( foo bar );

sub foo { 'foo' }
sub bar { 'bar' }

1;
</code></pre>

<p>The tests should check that using Basic::Exports exports <code>foo()</code> and <code>bar()</code> to the appropriate namespace and that they return the appropriate values. Another test is that the code <code>use Basic::Exports ();</code> exports <em>neither</em> function.</p>

<h4 id="optional-exports">Optional Exports</h4>

<pre><code>package Optional::Exports;

use strict;

use base 'Exporter';
use vars '@EXPORT_OK';

@EXPORT_OK = qw( foo bar baz );

sub foo { 'foo' }
sub bar { 'bar' }
sub baz { 'baz' }

1;
</code></pre>

<p>The tests should check that Optional::Exports exports nothing by default and only those functions named, if there are any.</p>

<h4 id="load-time-behavior">Load-time Behavior</h4>

<p>A few modules have curious behavior. My Pod::ToDemo behaves differently when invoked from the command line versus when used within a module. This makes it substantially more difficult to test. Rather than make you reinvent the tests there, here&rsquo;s a simpler custom <code>import()</code> that does different things based on its invocation. If invoked from the command line, it prints a message to standard output. If used from a module, it exports the same <code>foo()</code> subroutine as before.</p>

<pre><code>package Export::Weird;

use strict;

sub import
{
    my ($package, undef, $line) = caller();

    if ( $line == 0 )
    {
        print &quot;Invoked from command-line\n&quot;;
    }
    else
    {
        no strict 'refs';
        *{ $package . '::foo' } = sub { 'foo' };
    }
}

1;
</code></pre>

<p>The only really tricky test here must exercise the behavior of the module when invoked from the command line. Assume that the documentation of the module suggests invoking it via:</p>

<pre><code>$ perl -MExport::Weird -e 1
</code></pre>

<p>The next page explains some techniques for testing these examples. For best results, spend between 30 and 45 minutes working through the kata on your own before looking at the hints. For more information on how modules, <code>use</code>, and <code>require</code> work, see <code>perldoc perlmod</code> and <code>perldoc perlfunc</code>.</p>

<h3 id="tips-tricks-and-suggestions">Tips, Tricks, and Suggestions</h3>

<p>If you&rsquo;ve worked your way through writing tests for the three examples, here are the approaches I would take. They&rsquo;re not the only ways to test these examples, but they do work. First, here is some background information on what&rsquo;s happening.</p>

<h4 id="reloading">Reloading</h4>

<p>To test <code>import()</code> properly, you must understand its implications. When Perl encounters a <code>use module;</code> statement, it executes a two-step process <em>immediately</em>:</p>

<pre><code>BEGIN
{
    require module;
    module-&gt;import();
}
</code></pre>

<p>You can subvert both of these processes. To force Perl to reload a module, you can delete its entry from <code>%INC</code>. Note that all of the keys of this special hash represent pathnames in Unix format. For example, even if you use Windows or VMS or Mac OS 9 or earlier, loading Filter::Simple successfully should result in <code>%INC</code> containing a true value for the key of <code>Filter/Simple.pm</code>. (You may also want to use the <code>delete_package()</code> function of the Symbol module to clear out the namespace, though beware of the caveats there.) Now you can <code>require</code> the module again.</p>

<h4 id="re-importing">Re-importing</h4>

<p>Next, you&rsquo;ll have to call <code>import()</code> manually. It&rsquo;s a normal class method call, however, so you can provide all of the arguments as you would to a function or method call.</p>

<p>You can also switch packages, though make sure that you qualify any calls to Test::* module functions appropriately:</p>

<pre><code>package Some::Other::Package;

module-&gt;import( @args );

main::ok( 1, 'some test label' );

# or 

::ok( 1, 'some test label' );
</code></pre>

<h4 id="testing-exports">Testing Exports</h4>

<p>There are at least two techniques for checking the import of functions. One is the use of the <code>defined</code> keyword and the other is through the <code>can()</code> class method. For example, tests for Example #1 might be:</p>

<pre><code>use_ok( 'Basic::Exports' );
ok( defined &amp;foo,              'module should export foo()' )
ok( __PACKAGE__-&gt;can( 'bar' ), '... and should export bar()' );
</code></pre>

<p>To test that these are the right functions, call them as normal and check their return values.</p>

<p>By the way, the presence of the <code>__PACKAGE__</code> symbol there allows this test to take place in other namespaces. If you haven&rsquo;t imported the <code>ok()</code> test function into this namespace, remember to qualify it, import it manually, or alias it so that the test program will itself run. (It may fail, which is fine, but errors in your tests are difficult and embarrassing to fix.)</p>

<h4 id="testing-non-exports">Testing Non-Exports</h4>

<p>It&rsquo;s difficult to prove a negative conclusively, but if you reverse the condition of a test, you can have good confidence that the module hasn&rsquo;t provided anything unwanted.</p>

<pre><code>use_ok( 'Optional::Exports' );
ok( ! __PACKAGE__-&gt;can( 'foo' ),
    'module should not export foo() by default' );
</code></pre>

<p>The only tricky part of the tests here is in trying to import functions again. Call <code>import()</code> explicitly as a class method of the module. Switching packages within the test can make this easier; you don&rsquo;t have to unload the module if you do this.</p>

<h4 id="testing-weird-exports">Testing Weird Exports</h4>

<p>The easist way to test an <code>import()</code> function that relies on command-line invocation or produces weird side effects that you may not want to handle in your current program is to launch it as a separate program. There are plenty of options for this, from <code>system</code> to <code>fork</code> and <code>exec</code> to tricks with pipes and shell redirection. <a href="https://metacpan.org/pod/IPC::Open3">IPC::Open3</a> is one good approach, if you want to use it in your test suite:</p>

<pre><code>#! perl

use strict;
use warnings;

use blib;
use IPC::Open3;

use Test::More tests =&gt; 3;

use_ok( 'Export::Weird' );

my $pid = open3(
    undef, my $reader, undef,
    $^X, '-Mblib', '-MExport::Weird', '-e', '1'
);

my @out = &lt;$reader&gt;;
is( @out,                                1,
    'cli invocation should print one line' );
is( $out[0], &quot;Invoked from command-line\n&quot;,
    '... with the right message' );
</code></pre>

<p><code>$^X</code> represents the path to the Perl binary currently executing this program. The <code>-Mblib</code> switch loads the <code>blib</code> module to set <code>@INC</code> in the program appropriately. Depending on how you&rsquo;ve set up your directories and invoke this program, you may have to change this. The other commands follow the invocation scheme given in Example #3.</p>

<h3 id="conclusion">Conclusion</h3>

<p>You should now have several ideas on how to test <code>import()</code> methods of various kinds. For more details, read the tests of <a href="https://metacpan.org/pod/Pod::ToDemo">Pod::ToDemo</a> or <a href="https://metacpan.org/pod/Test::Builder">Test::Builder</a>, which play strange games to achieve good test coverage.</p>

<p>If you&rsquo;ve found a differently workable approach, I&rsquo;d like to hear from you. Also, if you have suggestions for another kata (or would like to write one), please let me know.</p>

<p><em>chromatic is the author of <a href="http://onyxneon.com/books/modern_perl/">Modern Perl</a>. In his spare time, he has been working on <a href="https://trendshare.org/how-to-invest/">helping novices understand stocks and investing</a>.</em></p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/testing">testing</a></div>
                
                  <div class="tag"><a href="/tags/code-kata">code-kata</a></div>
                
                  <div class="tag"><a href="/tags/exporting">exporting</a></div>
                
                  <div class="tag"><a href="/tags/import">import</a></div>
                
                  <div class="tag"><a href="/tags/perl-code-kata">perl-code-kata</a></div>
                
                  <div class="tag"><a href="/tags/perl-exercises">perl-exercises</a></div>
                
                  <div class="tag"><a href="/tags/perl-modules">perl-modules</a></div>
                
                  <div class="tag"><a href="/tags/perl-testing">perl-testing</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-chromatic">
  <div class="col-sm-2">
    
    <a href="/authors/chromatic/"><div class="circle-avatar" style="background-image:url(/images/author/chromatic.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/chromatic/"><h3>chromatic</h3></a>
    <p></p>
    <h5><a href="/authors/chromatic/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/legacy/_pub_2004_12_16_import_kata.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

