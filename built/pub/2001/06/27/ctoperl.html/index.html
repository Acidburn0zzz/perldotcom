<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Why Not Translate Perl to C? </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Why translating Perl to C often doesn&#39;t create faster programs"/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/pub/2001/06/27/ctoperl.html/" />
<meta property="og:title" content="Why Not Translate Perl to C?" />
<meta property="og:description" content="Why translating Perl to C often doesn&#39;t create faster programs">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2001-06-06T06:06:06Z" />
<meta property="og:image" content="http://localhost:1313/images/_pub_2001_06_27_ctoperl/111-perlc.jpg" />
<meta property="og:article:tag" content="c" />
<meta property="og:article:tag" content="compile" />
<meta property="og:article:tag" content="c-and-perl" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Why Not Translate Perl to C?</h1>
              <p class="blog-post-meta">Jun 27, 2001 by
              
              
                
                
                <a href="#author-bio-mark-jason-dominus">Mark-Jason Dominus</a>
              
              </p>
              <img alt="" src=""/>
                

<p>People often have the idea that automatically translating Perl to C and then compiling the C will make their Perl programs run faster, because &ldquo;C is much faster than Perl.&rdquo; This article explains why this strategy is unlikely to work.</p>

<h3 id="short-summary">Short Summary</h3>

<p>Your Perl program is being run by the Perl interpreter. You want a C program that does the same thing that your Perl program does. A C program to do what your Perl program does would have to do most of the same things that the Perl interpreter does when it runs your Perl program. There is no reason to think that the C program could do those things faster than the Perl interpreter does them, because the Perl interpreter itself is written in very fast C.</p>

<p>Some detailed case studies follow.</p>

<h3 id="built-in-functions">Built-In Functions</h3>

<p>Suppose your program needs to split a line into fields, and uses the Perl <code>split</code> function to do so. You want to compile this to C so it will be faster.</p>

<p>This is obviously not going to work, because the <code>split</code> function is already implemented in C. If you have the Perl source code, you can see the implementation of <code>split</code> in the file <code>pp.c</code>; it is in the function named <code>pp_split</code>. When your Perl program uses <code>split</code>, Perl calls this <code>pp_split</code> function to do the splitting. <code>pp_split</code> is written in C, and it has already been compiled to native machine code.</p>

<p>Now, suppose you want to translate your Perl program to C. How will you translate your <code>split</code> call? The only thing you can do is translate it to a call to the C <code>pp_split</code> function, or some other equivalent function that splits. There is no reason to believe that any C implementation of <code>split</code> will be faster than the <code>pp_split</code> that Perl already has. Years of work have gone into making <code>pp_split</code> as fast as possible.</p>

<p>You can make the same argument for all of Perl&rsquo;s other built-in functions, such as <code>join</code>, <code>printf</code>, <code>rand</code> and <code>readdir</code>.</p>

<p>So much for built-in functions.</p>

<h3 id="data-structures">Data Structures</h3>

<p>Why is Perl slow to begin with? One major reason is that its data structures are extremely flexible, and this flexibility imposes a speed penalty.</p>

<p>Let&rsquo;s look in detail at an important example: strings. Consider this Perl code:</p>

<pre><code>        $x = 'foo';     
        $y = 'bar';
        $x .= $y;
</code></pre>

<p>That is, we want to append <code>$y</code> to the end of <code>$x</code>. In C, this is extremely tricky. In C, you would start by doing something like this:</p>

<pre><code>        char *x = &quot;foo&quot;;
        char *y = &quot;bar&quot;;
</code></pre>

<p>Now you have a problem. You would like to insert <code>bar</code> at the end of the buffer pointed to by <code>x</code>. But you can&rsquo;t, because there is not enough room; <code>x</code> only points to enough space for four characters, and you need space for seven. (C strings always have an extra <code>nul</code> character on the end.) To append <code>y</code> to <code>x</code>, you must allocate a new buffer, and then arrange for <code>x</code> to point to the new buffer:</p>

<pre><code>        char *tmp = malloc(strlen(x) + strlen(y) + 1);
        strcpy(tmp, x);
        strcat(tmp, y);
        x = tmp;
</code></pre>

<p>This works fine if <code>x</code> is the only pointer to that particular buffer. But if some other part of the program also had a pointer to the buffer, this code does not work. Why not? Here&rsquo;s the picture of what we did:</p>

<p><strong>BEFORE:</strong></p>

<p><img src="/images/_pub_2001_06_27_ctoperl/cbef.gif" alt="" /></p>

<p>Here <code>x</code> and <code>z</code> are two variables that both contain pointers to the same buffer. We want to append <code>bar</code> to the end of the string. But the C code we used above doesn&rsquo;t quite work, because we allocated a new region of memory to hold the result, and then pointed <code>x</code> to it:</p>

<p><strong>AFTER <code>x = tmp</code>:</strong></p>

<p><img src="/images/_pub_2001_06_27_ctoperl/caft.gif" alt="" /></p>

<p>It&rsquo;s tempting to think that we should just point <code>z</code> to the new buffer also, but in practice this is impossible. The function that is doing the appending cannot know whether there is such a <code>z</code>, or where it may be. There might be 100 variables like <code>z</code> all pointing to the old buffer, and there is no good way to keep track of them so that they can all be changed when the array moves.</p>

<p>Perl does support a transparent string append operation. Let&rsquo;s see how this works. In Perl, a variable like <code>$x</code> does not point directly at the buffer. Instead, it points at a structure called an SV. (&lsquo;Scalar Value&rsquo;) The SV has the pointer to the buffer, and also some other things that I do not show:</p>

<p><strong>BEFORE <code>$x .= $y</code></strong>
<img src="/images/_pub_2001_06_27_ctoperl/pbef.gif" alt="" /></p>

<p>When you ask Perl to append <code>bar</code> to <code>$x</code>, it follows the pointers and finds that there is not enough space in the buffer. So, just as in C, it allocates a new buffer and stores the result in the new buffer. Then it fixes the pointer in the SV to point to the new buffer, and it throws away the old buffer:</p>

<p><img src="/images/_pub_2001_06_27_ctoperl/paft.gif" alt="" /></p>

<p>Now <code>$x</code> and <code>$z</code> have both changed. If there were any other variables sharing the SV, their values would have changed also. This technique is called &ldquo;double indirection,&lsquo;&rdquo; and it is how Perl can support operations like <code>.=</code>. A similar principle applies for arrays; this is how Perl can support the <code>push</code> function.</p>

<p>The flexibility comes at a price: Whenever you want to use the value of <code>$x</code>, Perl must follow two pointers to get the value: The first to find the SV structure, and the second to get to the buffer with the character data. This means that using a string in Perl takes at least twice as long as in C. In C, you follow just one pointer.</p>

<p>If you want to compile Perl to C, you have a big problem. You would like to support operations like <code>.=</code> and <code>push</code>, but C does not support these very well. There are only three solutions:</p>

<ol>
<li><p>Don&rsquo;t support <code>.=</code></p>

<p>This is a bad solution, because after you disallow all the Perl operations like <code>.=</code> and <code>push</code> what you have left is not very much like Perl; it is much more like C, and then you might as well just write the program in C in the first place.</p></li>

<li><p>Do something extremely clever</p>

<p>Cleverness is in short supply this month. <code>:)</code></p></li>

<li><p>Use a double-indirection technique in the compiled C code</p>

<p>This works, but the resulting C code will be slow, because you will have to traverse twice as many pointers each time you want to look up the value of a variable. But that is why Perl is slow! Perl is already doing the double-indirection lookup in C, and the code to do this has already been compiled to native machine code.</p></li>
</ol>

<p>So again, it&rsquo;s not clear that you are going to get any benefit from translating Perl to C. The slowness of Perl comes from the flexibility of the data structures. The code to manipulate these structures is already written in C. If you translate a Perl program to C, you have the choice of throwing away the flexibility of the data structure, in which case you are now writing C programs with C structures, or keeping the flexibility with the same speed penalty. You probably cannot speed up the data structures, because if anyone knew how to make the structures faster and still keep them flexible, they would already have made those changes in the C code for Perl itself.</p>

<h3 id="possible-future-work">Possible Future Work</h3>

<p>It should now be clear that although it might not be hard to translate Perl to C, programs probably will not be faster as a result.</p>

<p>However, it&rsquo;s possible that a sufficiently clever person could make a Perl-to-C translator that produced faster C code. The programmer would need to give hints to the translator to say how the variables were being used. For example, suppose you have an array <code>@a</code>. With such an array, Perl is ready for anything. You might do <code>$a[1000000] = 'hello';</code> or <code>$a[500] .= 'foo';</code> or <code>$a[500] /= 17;</code>. This flexibility is expensive. But suppose you know that this array will only hold integers and there will never be more than 1,000 integers. You might tell the translator that, and then instead of producing C code to manage a slow Perl array, the translator can produce</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">int a[<span style="color:#ae81ff">1000</span>];</code></pre></div>
<p>and use a fast C array of machine integers.</p>

<p>To do this, you have to be very clever and you have to think of a way of explaining to the translator that <code>@a</code> will never be bigger than 1,000 elements and will only contain integers, or a way for the translator to guess that just from looking at the Perl program.</p>

<p>People are planning these features for Perl 6 right now. For example, Larry Wall, the author of Perl, plans that you will be able to declare a Perl array as</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> int @a is dim(<span style="color:#ae81ff">1000</span>);</code></pre></div>
<p>Then a Perl-to-C translator (or Perl itself) might be able to use a fast C array of machine integers rather than a slow Perl array of SVs. If you are interested, you may want to join the perl6-internals mailing list.</p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/perl-internals">perl-internals</a></div>
                
                  <div class="tag"><a href="/tags/c">c</a></div>
                
                  <div class="tag"><a href="/tags/compile">compile</a></div>
                
                  <div class="tag"><a href="/tags/c-and-perl">c-and-perl</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-mark-jason-dominus">
  <div class="col-sm-2">
    
    <a href="/authors/mark-jason-dominus/"><div class="circle-avatar" style="background-image:url(/images/author/mjd.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/mark-jason-dominus/"><h3>Mark-Jason Dominus</h3></a>
    <p></p>
    <h5><a href="/authors/mark-jason-dominus/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/legacy/_pub_2001_06_27_ctoperl.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

