<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> My Life With Spam </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="My Life with Spam -&gt; or How I Caught the Spam and What I Did With It When I Caught it -&gt; I wrote Part 1 of this series back in October 1999 for the LinuxPlanet web site, but the..."/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/pub/2000/02/spamfilter.html/" />
<meta property="og:title" content="My Life With Spam" />
<meta property="og:description" content="My Life with Spam -&gt; or How I Caught the Spam and What I Did With It When I Caught it -&gt; I wrote Part 1 of this series back in October 1999 for the LinuxPlanet web site, but the...">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2000-02-02T02:02:02Z" />
<meta property="og:image" content="http://localhost:1313/images/author/mjd.jpg" />
<meta property="og:article:tag" content="spam" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">My Life With Spam</h1>
              <p class="blog-post-meta">Feb 9, 2000 by
              
              
                
                
                <a href="#author-bio-mark-jason-dominus">Mark-Jason Dominus</a>
              
              </p>
              <img alt="" src=""/>
                

<p>or</p>

<p>I wrote Part 1 of this series back in October 1999 for the LinuxPlanet web site, but the editors decided not to publish the rest of the series. Since then, many people have asked for the continuation. This article is Part 2.</p>

<p>Part 1 of the series discussed my early experiences with the spam problem, first on Usenet and then in my e-mail box. I talked about how to set up a mail filter program and how to have it parse incoming messages. I discussed splitting up the header into logical lines and why this is necessary. For the details and the Perl code, you can read <a href="http://www.plover.com/~mjd/perl/lp/Spam.html">the original article</a>.</p>

<p>I also talked about my filtering philosophy, which is to blacklist the domains that send me a lot of spam, and reject mail from those domains.</p>

<h1 id="span-id-domain-pattern-matching-domain-pattern-matching-span"><span id="Domain_Pattern_Matching">Domain Pattern Matching</span></h1>

<p>One way to handle domains might have been to take the <code>To:</code> address in the message and strip off the host name. However, this is impossible because a host name <em>is</em> a domain. <code>perl.com</code> is both a host name and a domain; <code>www.perl.com</code> is both a host name and a domain, and so is <code>chocolaty-goodness.www.perl.com</code>. In practice, though, it&rsquo;s easy to use a simple heuristic:</p>

<ol>
<li>Split the host name into components.</li>
<li>If the last component is <code>com</code>, <code>edu</code>, <code>gov</code>, <code>net</code>, or <code>org</code>, then the domain name is the last two components.</li>
<li>Otherwise, the domain name is the last three components</li>
</ol>

<p>The theory is that if the final component is not a generic top-level domain like <code>com</code>, it is probably a two-letter country code. Most countries imitate the generic space at the second level of their domain. For example, the United Kingdom has <code>ac.uk</code>, <code>co.uk</code>, and <code>org.uk</code> corresponding to <code>edu</code>, <code>com</code>, and <code>org</code>, so when I get mail from <code>someone@thelonious.new.ox.ac.uk</code>, I want to recognize the domain as <code>ox.ac.uk</code> (Oxford University), not <code>ac.uk</code>.</p>

<p>Of course, this is a heuristic, which is a fancy way of saying that it doesn&rsquo;t work. Many top-level domains aren&rsquo;t divided up at the third level the way I assumed. For example, the <code>to</code> domain has no organization at all, the same as the <code>com</code> domain. If I get mail from <code>hot.spama.to</code>, my program will blacklist that domain only, not realizing that it&rsquo;s part of the larger <code>spama.to</code> domain owned by the same people. So far, however, this has never come up.</p>

<p>And I didn&rsquo;t include <code>mil</code> in my list of exceptions. However, I&rsquo;ve never gotten spam from a <code>mil</code>.</p>

<p>Eventually the domain registration folks will introduce a batch of new generic top-level domains, such as <code>.firm</code> and <code>.web</code>. But they&rsquo;ve been getting ready for it since 1996; they&rsquo;re still working up to it; and I might grow old and die waiting for it to happen. (See <a href="http://www.gtld-mou.org/">http://www.gtld-mou.org/</a> for more information.)</p>

<p>For all its problems, this method has worked just fine for a long time because hardly any of the problems ever actually come up. There&rsquo;s a moral here: The world is full of terrifically over-engineered software. Sometimes you can waste a lot of time trying to find the perfect solution to a problem that only needs to be partially solved. Or as my friends at MIT used to say, ``Good enough for government work!&rdquo;</p>

<p>Here&rsquo;s the code for extracting the domain:</p>

<pre><code> 1    my ($user, $site) = $s =~ /(.*)@(.*)/;
 2    next unless $site;
 3    my @components =  split(/\./, $site);
 4    my $n_comp = ($components[-1] =~ /^edu|com|net|org|gov$/) ? 2 : 3;
 5    my $domain = lc(join '.', @components[-$n_comp .. -1]);
 6    $domain =~ s/^\.//;  # Remove leading . if there is one.
</code></pre>

<p>The sender&rsquo;s address is in <code>$s</code>. I extract the site name from the address with a simple pattern match, which is also a wonderful example of the &ldquo;good enough&rdquo; principle. Messages appear in the <code>comp.lang.perl.misc</code> newsgroup every week asking for a pattern that matches an e-mail address. The senders get a lot of very long complicated answers, or are told that it can&rsquo;t be done. And yet there it is. Sure, it doesn&rsquo;t work. Of course, if you get mail addressed to ``@&ldquo;@plover.com, it&rsquo;s going to barf. Of course, if you get source-routed mail with an address like &lt;@send.here.first:joe@send.here.afterwards,&gt; it isn&rsquo;t going to work.</p>

<p>But guess what? Those things never happen. A production mail server has to deal with these sorts of fussy details, but if my program fails to reject some message as spam because it made an overly simple assumption about the format of the mail addresses, there&rsquo;s no harm done.</p>

<p>On line 2, we skip immediately to the next address if there&rsquo;s no site name, since it now appears that this wasn&rsquo;t an address at all. Line 3 breaks the site name up into components; <code>thelonious.new.ox.ac.uk</code> is broken into <code>thelonious</code>, <code>new</code>, <code>ox</code>, <code>ac</code>, and <code>uk</code>.</p>

<p>Line 4 is the nasty heuristic: It peeks at the last component, in this case <code>uk</code>, and if it&rsquo;s one of the magic five (<code>edu</code>, <code>com</code>, <code>net</code>, <code>org</code>, or <code>gov</code>), it sets <code>$n_comp</code> to 2; otherwise to 3. <code>$n_comp</code> is going to be the number of components that are part of the domain, so the domain of <code>saul.cis.upenn.edu</code> is <code>upenn.edu</code>, and the domain of <code>thelonious.new.ox.ac.uk</code> is <code>ox.ac.uk</code>.</p>

<p>To get the last component, we subscript the component array <code>@components</code> with <code>-1</code>. <code>-1</code> as an array subscript means to get the last element of the array. Similarly, -2 means to get the next-to-last element. In this case, the last component is <code>uk</code>, which doesn&rsquo;t match the pattern, so <code>$n_comp</code> is 3.</p>

<p>On line 5, <code>-$n_comp .. -1</code> is really <code>-3 .. -1</code>, which is the list <code>-3, -2, -1</code>. We use a Perl feature called a &ldquo;list slice&rdquo; to extract just the elements -3, -2, and -1 from the <code>@components</code> array. The syntax</p>

<pre><code>        @components[(some list)]
</code></pre>

<p>invokes this feature. The list is taken to be a list of subscripts, and the elements of <code>@components</code> with those subscripts are extracted, in order. This is why you can write</p>

<pre><code>        ($year, $month, $day) = (localtime)[5,4,3];
</code></pre>

<p>to extract the year, month, and day from <code>localtime</code>, in that order&ndash;it&rsquo;s almost the same feature. Here we&rsquo;re extracting elements -3 (the third-to-last), -2 (the second-to-last), and -1 (the last) and joining them together again. If <code>$n_comp</code> had been 2, we would have gotten elements -2 and -1 only.</p>

<p>Finally, line 6 takes care of a common case in which the heuristic doesn&rsquo;t work. If we get mail from <code>alcatel.at</code>, and try to select the last three components, we&rsquo;ll get one undefined component&ndash;because there were really only two there&ndash;and the result of the join will be <code>.alcatel.at</code>, with a bogus null component on the front. Line 6 looks to see if there&rsquo;s an extra period on the front of the domain, and if so, it chops it off.</p>

<hr />

<h1 id="span-id-now-that-you-have-it-what-do-yo-now-that-you-have-it-what-do-you-do-with-it-span"><span id="Now_That_You_Have_it_What_Do_Yo">Now That You Have it, What Do You Do With it?</span></h1>

<p>I&rsquo;ve extracted the domain name. The obvious thing to do is to have a big hash with every bad domain in it, and to look this domain up in the hash to see if it&rsquo;s there. Looking things up in a hash is very fast.</p>

<p>However, that&rsquo;s not what I decided to do. Instead, I have a huge file with a <em>regex</em> in it for every bad domain, and I take the domain in question and match it against all the patterns in the file. That&rsquo;s a lot slower. A <em>lot</em> slower. Instead of looking up the domain instantaneously, it takes 0.24 seconds to match the patterns.</p>

<p>Some people might see that and complain that it was taking a thousand times as long as it should. And maybe that&rsquo;s true. But the patterns are more flexible, and what&rsquo;s a quarter of a second more or less? The mail filter handled 2,211 messages in the month of January. At 0.24 seconds each, the pattern matching is costing me less than 9 minutes per month.</p>

<p>So much for the downside. What&rsquo;s the upside? I get to use patterns. That&rsquo;s a big upside.</p>

<p>I have a pattern in my pattern file that rejects any mail from anyone who claims that their domain is all digits, such as 12345.com. That would have been impossible with a hash. I have a pattern that rejects mail from anyone with &ldquo;casino&rdquo; in their domain. That took care of spam from Planetrockcasino.com and Romancasino.com before I had ever heard of those places. Remember that I only do the pattern matching on the domain, so if someone sent me mail from <code>casino.ox.ac.uk</code>, it would get through.</p>

<p>The regexes actually do have a potential problem: The patterns are in the file, one pattern per line. Suppose I&rsquo;m adding patterns to the file and I leave a blank line by mistake. Then some mail arrives. The filter extracts the domain name of the sender and starts working through the pattern file. 0.24 seconds later, it gets to the blank line.</p>

<p>What happens when you match a string against the empty pattern? It matches, that&rsquo;s what. Every string matches the empty pattern. Since the patterns are assumed to describe mail that I <em>don&rsquo;t</em> want to receive, the letter is rejected. So is the next letter. So is every letter. Whoops.</p>

<p>It&rsquo;s tempting to say that I should just check for blank patterns and skip them if they&rsquo;re there, but that won&rsquo;t protect me against a line that has only a period and nothing else&ndash;that will also match any string.</p>

<p>Instead, here&rsquo;s what I&rsquo;ve done:</p>

<pre><code>        $MATCHLESS = &quot;qjdhqhd1!&amp;@^#^*&amp;!@#&quot;;

        if ($MATCHLESS =~ /$badsite_pat/i) {
          &amp;defer(&quot;The bad site pattern matched `$MATCHLESS', 
                  so I assume it would match anything.  Deferring...\n&quot;);
        }
</code></pre>

<p>Since the patterns are designed to identify bad domain names, none of them should match <code>qjdhqhd1!&amp;@^#^*&amp;!@#</code>. If a pattern <em>does</em> match that string, it probably also matches a whole lot of other stuff that it shouldn&rsquo;t. In that case, the program assumes that the pattern file is corrupt, and defers the delivery. This means that it tells <code>qmail</code> that it isn&rsquo;t prepared to deliver the mail at the present time, and that <code>qmail</code> should try again later on. <code>qmail</code> will keep trying until it gets through or until five days have elapsed, at which point it gives up and bounces the message back to the sender. Chances are that I&rsquo;ll notice that I&rsquo;m not getting any mail sometime before five days have elapsed, look in the filter log file, and fix the pattern file. As <code>qmail</code> retries delivery, the deferred messages will eventually arrive.</p>

<p>Deferring a message is easy when your mailer is <code>qmail</code>. Here&rsquo;s the <code>defer</code> subroutine in its entirety:</p>

<pre><code>        sub defer {
          my $msg = shift;
          carp $msg;
          exit 111;
        }
</code></pre>

<p>When <code>qmail</code> sees the 111 exit status from the filter program, it interprets it as a request to defer delivery. (Similarly, 100 tells <code>qmail</code> that there was a permanent failure and it should bounce the message back to the sender immediately. The normal status of 0 means that delivery was successful.)</p>

<p>I would still be in trouble if I installed <code>com</code> as a pattern in the pattern file, because it matches more domains than it should, but the <code>MATCHLESS</code> test doesn&rsquo;t catch it. But unlike the blank line problem, it&rsquo;s never come up, so I&rsquo;ve decided to deal with it when it arises.</p>

<hr />

<h1 id="span-id-c-received-lines-received-lines-span"><span id="C_Received_Lines">&lsquo;Received:&rsquo; Lines</span></h1>

<p>In addition to filtering the <code>From:</code>, <code>Reply-To:</code>, and envelope sender addresses, I also look through the list of forwarding hosts for bad domains. The <code>From:</code> and <code>Reply-To:</code> headers are easy to forge: The sender can put whatever they want in those fields and spammers usually do. But the <code>Received:</code> fields are a little different. When computer A sends a message to computer B, the <em>receiving</em> computer B adds a <code>Received:</code> header to the message, recording who it is, when it received the message, and from whom. If the message travels through several computers, there will be several received lines, with the earliest one at the bottom of the header and the later ones added above it. Here&rsquo;s a typical set of <code>Received:</code> lines:</p>

<pre><code>1   Received: (qmail 7131 invoked by uid 119); 22 Feb 1999 22:01:59 -0000

2   Received: (qmail 7124 invoked by uid 119); 22 Feb 1999 22:01:58 -0000

3   Received: (qmail 7119 invoked from network); 22 Feb 1999 22:01:53 -0000

4   Received: from renoir.op.net (root@209.152.193.4)

5   by plover.com with SMTP; 22 Feb 1999 22:01:53 -0000

6   Received: from pisarro.op.net (root@pisarro.op.net [209.152.193.22]) 
    by renoir.op.net (o1/$Revision:1.18 $) with ESMTP id RAA24909 
    for &lt;mjd@mail.op.net&gt;; Mon, 22 Feb 1999 17:01:48 -0500 (EST)

7   Received: from linc.cis.upenn.edu (LINC.CIS.UPENN.EDU [158.130.12.3])
    by pisarro.op.net 
   (o2/$Revision: 1.1 $) with ESMTP id RAA12310 for 
   &lt;mjd@op.net&gt;; Mon, 22 Feb 1999 17:01:45 -0500(EST)

8   Received: from saul.cis.upenn.edu (SAUL.CIS.UPENN.EDU [158.130.12.4])

9   by linc.cis.upenn.edu (8.8.5/8.8.5) with ESMTP id QAA15020

10  for &lt;mjd@op.net&gt;; Mon, 22 Feb 1999 16:56:20 -0500 (EST)

11  Received: from mail.cucs.org (root@cucs-a252.cucs.org [207.25.43.252])

12  by saul.cis.upenn.edu (8.8.5/8.8.5) with ESMTP id QAA09203
13  for &lt;mjd@saul.cis.upenn.edu&gt;; Mon, 22 Feb 1999 16:56:19 -0500 (EST)

14  Received: from localhost.cucs.org ([192.168.1.223])

15  by mail.cucs.org (8.8.5/8.8.5) with SMTP id QAA06332

16  for &lt;mjd@saul.cis.upenn.edu&gt;; Mon, 22 Feb 1999 16:54:11 -0500
</code></pre>

<p>This is from a message that someone sent to <code>mjd@saul.cis.upenn.edu</code>, an old address of mine. Apparently the sender&rsquo;s mail client, in <code>localhost.cucs.org</code>, initially passed the message to the organization&rsquo;s mail server, <code>mail.cucs.org</code>. The mail server then added the lines 14-16 to the message header.</p>

<p>The mail server then delivered the message to <code>saul.cis.upenn.edu</code> over the Internet. <code>saul</code> added lines 11-13. Notice that the time on line 13 is 128 seconds after the time on line 13. This might mean that the message sat on <code>mail.cucs.org</code> for 128 seconds before it was delivered to <code>saul</code>, or it might mean that the two computers&rsquo; clocks are not properly synchronized.</p>

<p>When the mail arrived on <code>saul</code>, the mailer there discovered that I have a <code>.forward</code> file there directing delivery to <code>mjd@op.net</code>. <code>saul</code> needed to forward the message to <code>mjd@op.net</code>. However, most machines in the University of Pennsylvania CIS department do not deliver Internet mail themselves. Instead, they forward all mail to a departmental mail hub, <code>linc</code>, which takes care of delivering all the mail outside the organization. Lines 8-10 were added by <code>linc</code> when the mail was delivered to it by <code>saul</code>.</p>

<p><code>linc</code> looked up <code>op.net</code> in the domain name service and discovered that the machine <code>pisarro.op.net</code> was receiving mail for the <code>op.net</code> domain. Line 7 was added by <code>pisarro</code> when it received the mail from <code>linc</code>.</p>

<p>I don&rsquo;t know why <code>pisarro</code> then delivered the message to <code>renoir</code>, but we know that it did, because line 6 says so.</p>

<p><code>qmail</code> on <code>plover.com</code> added lines 4-5 when the mail was delivered from <code>renoir</code>. Then the final three lines, 1-3, were added by <code>qmail</code> for various local deliveries to <code>mjd</code>, then <code>mjd-filter</code> (which runs my spam filter), and finally, <code>mjd-filter-deliver</code>, which is the address that actually leads to my mailbox.</p>

<p>What can we learn from all this? The <code>Received:</code> lines have a record of every computer that the message passed through on its way to being delivered. And unlike the <code>From:</code> and <code>Reply-To:</code> lines, it really does record where the message has been.</p>

<p>Suppose the original sender, at <code>localhost.cucs.org</code> had wanted to disguise the message&rsquo;s origin. Let&rsquo;s call him Bob. Bob cannot prevent <code>cucs.org</code> from being mentioned in the message header. Why? Because there it is in line 11. Line 11 was put there by <code>saul.cis.upenn.edu</code>, not by Bob, who has no control over computers in the <code>upenn.edu</code> domain.</p>

<p>Bob can try to confuse the issue by <em>adding</em> spurious <code>Received:</code> lines, but he can&rsquo;t prevent the other computers from adding the correct ones.</p>

<p>Now, when spammers send spam, they often forge the <code>From:</code> and the <code>Reply-To:</code> lines so that people don&rsquo;t know who they are and can&rsquo;t come and kill them. But they can&rsquo;t forge the <code>Received:</code> lines because it&rsquo;s another computer that puts those in. So when we&rsquo;re searching for domains to check against the list of bad domain patterns, we should look through the <code>Received:</code> lines too.</p>

<p>The difficulty with that is that there&rsquo;s no standard for what a <code>Received:</code> line should look like or what should be in it, and every different mailer does its own thing. You can see this in the example above. We need a way to go over the <code>Received:</code> lines and look for things that might be domains. This is just the sort of thing that Perl regexes were designed for.</p>

<p><code>1  sub forwarders { 2    return @forwarders if @forwarders; 3    4     @forwarders =  5  grep { /[A-Za-z]/ } ($H{'Received'} =~ m/(?:[\w-]+\.)+[\w-]+/g); 6  7   @forwarders = grep      { !/(\bplover\.com|\bcis\.upenn\.edu|\bpobox\.com|\bop\.net)$/i }     @forwarders; 8  9   foreach $r (@forwarders) { 10    $r{lc $r} = 1; 11     } 12  13   @forwarders = keys %r; 14  15   return @forwarders; 16     }</code></p>

<p>The message header has already been parsed and placed into the <code>%H</code> hash. <code>$H{Received}</code> contains the concatenation of all the <code>Received</code> lines in the whole message. The purpose of the <code>forwarders()</code> function is to examine <code>$H{Received}</code>, extract all the domain names it can find, and place them in the array <code>@forwarders</code>.</p>

<p>Lines 4-5 are the heart of this process. Let&rsquo;s look a little more closely.</p>

<pre><code>        $H{'Received'} =~ m/(?:[\w-]+\.)+[\w-]+/g
</code></pre>

<p>This does a pattern match in the <code>Received:</code> lines. <code>[\w-]</code> looks for a single letter, digit, underscore, or hyphen, while <code>[\w-]+</code> looks for a sequence of such characters, such as <code>saul</code> or <code>apple-gunkies</code>. This is a domain component. <code>[\w-]+\.</code> looks for a domain component followed by a period, like <code>saul.</code> or <code>apple-gunkies.</code>.</p>

<p>Ignore the <code>?:</code> for the time being. Without it, the pattern is <code>([\w-]+\.)+[\w-]+</code>, which means a domain component followed by a period, then another domain component followed by another period, and so on, and ending with a domain component and no period. So this is a pattern that will match something that looks like a domain.</p>

<p>The <code>/g</code> modifier on the match instructs Perl to find <em>all</em> matching substrings and to return a list of them. Perl will look through the <code>Received:</code> headers, pulling out all the things that look like domains, making them into a list, and returning the list of domains.</p>

<p>Another example of this feature:</p>

<pre><code>$s = &quot;Timmy is 7 years old and he lives at 350 Beacon St. 
Boston, MA 02134&quot; @numbers = ($s =~ m/\d+/g);
</code></pre>

<p>Now <code>@numbers</code> contains (7, 350, 02134).</p>

<p>I still haven&rsquo;t explained that <code>?:</code>. I have to confess to a lie. Perl only returns the list of matching substrings if the pattern contains no parentheses. If the pattern contains parentheses, the parentheses cause part of the string to be captured into the special <code>$1</code> variable, and the match returns a list of the <code>$1</code>s instead of a list of the entire matching substrings. If I&rsquo;d done</p>

<pre><code>&quot;saul.cis.upenn.edu plover.com&quot; =~ m/([\w-]+\.)+[\w-]+/g
</code></pre>

<p>instead, I would have gotten the list <code>(&quot;saul.cis.upenn.&quot;,    &quot;plover.&quot;)</code>, which are the <code>$1</code>&rsquo;s, because the <code>com</code> parts match the final <code>[\w-]+</code>, which is not in parentheses. The <code>?:</code> in the real pattern is nothing more than a switch to tell Perl not to use <code>$1</code>; . Since <code>$1</code> isn&rsquo;t being used, we get the default behavior, and the match returns a list of everything that matched.</p>

<pre><code>  4   @forwarders = 
  5   grep { /[A-Za-z]/ } ($H{'Received'} =~ m/(?:[\w-]+\.)+[\w-]+/g);
</code></pre>

<p>The pattern match generates a list of things that might be domains. The list initially looks like:</p>

<pre><code>  renoir.op.net 209.152.193.4
  plover.com
  pisarro.op.net pisarro.op.net 209.152.193.22 renoir.op.net 1.18 mail.op.net
  linc.cis.upenn.edu LINC.CIS.UPENN.EDU 158.130.12.3 pisarro.op.net 1.1 op.net
  saul.cis.upenn.edu SAUL.CIS.UPENN.EDU 158.130.12.4
  linc.cis.upenn.edu 8.8.5 8.8.5
  op.net
  mail.cucs.org cucs-a252.cucs.org 207.25.43.252
  saul.cis.upenn.edu 8.8.5 8.8.5
  saul.cis.upenn.edu
  localhost.cucs.org 192.168.1.223
  mail.cucs.org 8.8.5 8.8.5
  saul.cis.upenn.edu
</code></pre>

<p>As you can see, it contains a lot of junk. Most notably, it contains several occurrences of <code>8.8.5</code>, because the <code>upenn.edu</code> mailer was Sendmail version 8.8.5. There are also some IP addresses that we won&rsquo;t be able to filter, and some other things that look like version numbers. The <code>grep</code> filters this list of items and passes through only those that contain at least one letter, discarding the entirely numeric ones.</p>

<p><code>@forwarders</code> is now</p>

<pre><code>  renoir.op.net
  plover.com
  pisarro.op.net pisarro.op.net renoir.op.net mail.op.net
  linc.cis.upenn.edu LINC.CIS.UPENN.EDU pisarro.op.net op.net
  saul.cis.upenn.edu SAUL.CIS.UPENN.EDU
  linc.cis.upenn.edu
  op.net
  mail.cucs.org cucs-a252.cucs.org
  saul.cis.upenn.edu
  saul.cis.upenn.edu
  localhost.cucs.org
  mail.cucs.org
  saul.cis.upenn.edu
</code></pre>

<p>The rest of the function is just a little bit of cleanup. Line 7 discards several domain names that aren&rsquo;t worth looking at because they appear so often:</p>

<p>``</p>

<pre><code>7  @forwarders = grep { !/(\bplover\.com|\bcis\.upenn\.edu|\bpobox\.com|\bop\.net)$/i }
   @forwarders;
</code></pre>

<p>Plover.com is my domain, and it&rsquo;s going to appear in all my mail, so there&rsquo;s no point in checking it. I worked at the University of Pennsylvania for four and a half years, and I get a lot of mail forwarded from there, so there&rsquo;s no point in checking <code>cis.upenn.edu</code> domains either. Similarly, I subscribe to the Pobox.com lifetime e-mail forwarding service, and I get a lot of mail forwarded through there. <code>op.net</code> is my ISP domain name, which handles mail for me when Plover is down. Line 7 discards all these domains from the <code>@forwarders</code> list, leaving only the following:</p>

<pre><code>       mail.cucs.org cucs-a252.cucs.org
       localhost.cucs.org
       mail.cucs.org
</code></pre>

<p>Lines 9-13 now discard duplicate items, using a common Perl idiom:</p>

<pre><code> 9     foreach $r (@forwarders) {
 10       $r{lc $r} = 1;
 11     }
 12
 13     @forwarders = keys %r;
</code></pre>

<p>We use the remaining items as keys in a hash. Since a hash can&rsquo;t have the same key twice, the duplicate <code>mail.cucs.org</code> has no effect on the hash, which ends up with the keys, <code>mail.cucs.org</code>, <code>cucs-a252.cucs.org</code> and <code>localhost.cucs.org</code>. The values associated with these keys are each &ldquo;1,&rdquo; which doesn&rsquo;t matter. When we ask Perl for a list of keys on line 13, we get each key exactly once.</p>

<p>Finally, line 15 returns the list of forwarders to whomever needed it.</p>

<p>There&rsquo;s one little thing I didn&rsquo;t discuss:</p>

<pre><code>  2       return @forwarders if @forwarders;
</code></pre>

<p>The first thing the function does is check to see if it&rsquo;s already processed the <code>Received:</code> lines and the computer <code>@forwarders</code>. If so, it returns the list without computing it over again. That way I can just call <code>forwarders()</code> anywhere in my program that I need a list of forwarders, without worrying that I might be doing the same work more than once; the <code>forwarders()</code> function guarantees to return immediately after the first time I call it.</p>

<hr />

<h1 id="span-id-more-to-come-more-to-come-span"><span id="More_to_Come">More to Come</span></h1>

<p>Because of the long delay, I&rsquo;ll repeat the quiz from the first article: What&rsquo;s wrong with this header line?</p>

<pre><code>Received: from login_2961.sayme2.net (mail.sayme2.net[103.12.210.92])
by sayme2.net (8.8.5/8.7.3) with SMTP id XAA02040
for creditc@aoI.net;  Thu, 28 August 1997 15:51:23 -0700 (EDT)
</code></pre>

<p>The story&rsquo;s not over. In the next article, I&rsquo;ll talk about some other rules I used to filter the spam; one of them would have thrown out messages when it saw a line like the one above. Another one throws out mail when there&rsquo;s no <code>To:</code> line in the message&ndash;a likely sign of bulk mail.</p>

<p>I&rsquo;ll also tell a cautionary tale of how I might have lost a lot of money because my system worked too well, and how I found out that sometimes, you <em>want</em> to get unsolicited bulk mail.</p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/email">email</a></div>
                
                  <div class="tag"><a href="/tags/spam">spam</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-mark-jason-dominus">
  <div class="col-sm-2">
    
    <a href="/authors/mark-jason-dominus/"><div class="circle-avatar" style="background-image:url(/images/author/mjd.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/mark-jason-dominus/"><h3>Mark-Jason Dominus</h3></a>
    <p></p>
    <h5><a href="/authors/mark-jason-dominus/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/legacy/_pub_2000_02_spamfilter.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

