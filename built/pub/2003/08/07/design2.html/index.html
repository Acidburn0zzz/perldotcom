<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Perl Design Patterns, Part 2 </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content=" This is the second in a series of articles which form one Perl programmer&#39;s response to the book, Design Patterns (also known as the Gang of Four book or simply as GoF, because four authors wrote it). As I..."/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/pub/2003/08/07/design2.html/" />
<meta property="og:title" content="Perl Design Patterns, Part 2" />
<meta property="og:description" content=" This is the second in a series of articles which form one Perl programmer&#39;s response to the book, Design Patterns (also known as the Gang of Four book or simply as GoF, because four authors wrote it). As I...">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2003-08-08T08:08:08Z" />
<meta property="og:image" content="http://localhost:1313/images/site/avatar.png" />
<meta property="og:article:tag" content="design-patterns" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Perl Design Patterns, Part 2</h1>
              <p class="blog-post-meta">Aug 7, 2003 by
              
              
                
                
                <a href="#author-bio-phil-crow">Phil Crow</a>
              
              </p>
              <img alt="" src=""/>
                

<p>This is the second in a series of articles which form one Perl programmer&rsquo;s response to the book, <em>Design Patterns</em> (also known as the Gang of Four book or simply as GoF, because four authors wrote it).</p>

<p>As I showed in the <a href="/pub/2003/06/13/design1.html">first article</a>, Perl provides the best patterns in its core and many others are modules which ship with Perl or are available from CPAN. There I considered Iterator (<code>foreach</code>), Decorator (pipes and list filters), Flyweight (<code>Memoize.pm</code>), and Singleton (bless an object in a <code>BEGIN</code> block).</p>

<p>People into patterns often talk about how knowing patterns makes describing designs easier. The parenthetical comments in the last sentence show how Perl takes this to new heights by including the patterns internally.</p>

<p>This article continues my treatment by considering patterns which rely on data containers and/or code references (which are also called callbacks). Before showing the patterns let me explain these terms.</p>

<h4 id="span-id-data-containers-data-containers-span"><span id="data_containers">Data Containers</span></h4>

<p>I use data containers to mean any reference that holds a data structure. Arrays and hashes are common data containers, but hashes of lists of hashes storing things are more interesting. Careful use of these structure containers can often eliminate the need for objects.</p>

<p>Here&rsquo;s a concrete example. Suppose I want a phone list. I might use a container like this:</p>

<pre><code>    my $phone_list = {
        'phil' =&gt; [
            { type =&gt; 'home',  number =&gt; '555-0001' },
            { type =&gt; 'pager', number =&gt; '555-1000' },
        ],
        'frank' =&gt; [
            { type =&gt; 'cell',  number =&gt; '555-9012' },
            { type =&gt; 'pager', number =&gt; '555-5678' },
            { type =&gt; 'home',  number =&gt; '555-1234' },
        ],
    };
</code></pre>

<p>This container is housed in a hash. Its keys are names; its values are phone numbers. The numbers are listed in the order the person would like them used. (Call Frank on his cell phone first, then try his pager. If all else fails, use his home phone.)</p>

<p>To use this structure I might do the following:</p>

<pre><code>    #!/usr/bin/perl
    use strict; use warnings;

    my $phone_list = {
        'Phil' =&gt; [
            { type =&gt; 'home',  number =&gt; '555-0001' },
            { type =&gt; 'pager', number =&gt; '555-1000' },
        ],
        'Frank' =&gt; [
            { type =&gt; 'cell',  number =&gt; '555-9012' },
            { type =&gt; 'pager', number =&gt; '555-5678' },
            { type =&gt; 'home',  number =&gt; '555-1234' },
        ],
    };

    my $person = shift or die &quot;usage: $0 person\n&quot;;

    foreach my $number (@{$phone_list-&gt;{$person}}) {
        print &quot;$number-&gt;{type} $number-&gt;{number}\n&quot;;
    }
</code></pre>

<p>Here, the user supplies the name of the person he or she wants to reach as a command line argument which I store as <code>$person</code>. I then loop through all the phone numbers for that person, printing the type and number.</p>

<p>Of course, in practice your data would live outside your script. The example just shows what one data container can hold.</p>

<p>If you need to use a structure made of data nodes, you can often avoid the need for a node object by using a data container instead. Object Oriented programming proponents would probably want me to make an object for each person. In that object they might even want me to store an object for each phone type in some cumbersome list container. My advice: don&rsquo;t give in to pedants. Even in Java, I can build a structure like the one above (though not as easily). Doing so is often wise. Objects work better in more complex situations.</p>

<h4 id="span-id-what-s-a-code-reference-what-s-a-code-reference-span"><span id="what's_a_code_reference">What&rsquo;s a Code Reference?</span></h4>

<p>A code reference is like any reference in Perl, but what it points to is a subroutine you can call. For instance, I could write:</p>

<pre><code>    my $doubler = sub { return 2 * $_[0]; };
</code></pre>

<p>Then later in my program I would call that routine as:</p>

<pre><code>    my $doubled = &amp;$doubler(5);  # $doubled is now 10
</code></pre>

<p>This example is contrived. But it lets you see the basic syntax of code references. If you assign a sub to a variable, you receive a code reference by the grace of Perl. To call the sub stored in the reference put an <code>&amp;</code> in front of the variable which stores it. This is like we do for other references, as in this standard hash walker:</p>

<pre><code>    foreach my $key (keys %$hash_reference) { ... }
</code></pre>

<p>The <code>&amp;</code> is the sigil (or funny character) for subroutines, just like <code>@</code> and <code>%</code> are the sigils for arrays and hashes.</p>

<p>Many patterns in GoF and outside it can be implemented well in Perl with code references. Languages which don&rsquo;t provide code references are missing an important type.</p>

<p>Having explained these tools, I&rsquo;m ready to show you some patterns which use them.</p>

<h3 id="span-id-strategy-strategy-span"><span id="strategy">Strategy</span></h3>

<p>When you want to select from a series of choices for how something should be done, you need a strategy scheme. For example, you might want to sort based on a comparison function. Each time you sort, you should be able to specify the order strategy.</p>

<p>Since Perl has code references, we can easily implement the strategy pattern without bloating our code base with a proliferation of classes whose sole purpose is to provide one function.</p>

<p>Here&rsquo;s an example with the built-in sort:</p>

<pre><code>    sort { lc($a) cmp lc($b) } @items
</code></pre>

<p>This sorts without regard to case. Notice how <code>sort</code> is receiving the function directly in the call. Though we could do this for our own functions, it is more common to take a reference to the function as a required positional parameter.</p>

<p>Suppose, for example, that we want to list all files in the current directory, or any of its subdirectories, with some property. There are two pieces to this task: (1) Scan down the directory tree for all the entries, and (2) Test each file to see if it meets the criterion. Ideally we would like to separate these tasks so we can reuse them independently (for instance scanning a directory tree is more common than any particular criterion). We will make the criterion a strategy executed by the directory scanner.</p>

<pre><code>    #!/usr/bin/perl
    use strict; use warnings;

    my @files = find_files(\&amp;is_hidden, &quot;.&quot;);
    local $&quot; = &quot;\n&quot;;
    print &quot;@files\n&quot;;

    sub is_hidden {
        my $file = shift;
        $file    =~ s!.*/!!;
        return 0 if ($file =~ /^\./);
        return 1;
    }

    sub find_files {
        my $callback = shift;
        my $path     = shift;
        my @retval;

        push   @retval, $path if &amp;$callback($path);
        return @retval unless (-d $path);

        # identify children
        opendir DIR, $path or return;
        my @files = readdir DIR;
        closedir DIR;

        # visit each child
        foreach my $file (@files) {
            next if ($file =~ /^\.\.?$/);  # skip . and ..
            push @retval, find_files(&quot;$path/$file&quot;, $callback);
        }

        return @retval;
    }
</code></pre>

<p>To understand this example, start with the initial call to <code>find_files</code>. It passes two arguments. The first is a code reference. Note the syntax. As I pointed out in the introduction, to let Perl know I mean a subroutine, I put the <code>&amp;</code> sigil in front of <code>is_hidden</code>. To make a reference to that routine (instead of calling it immediately), I put a backslash in front, just as I would to take any other kind of reference.</p>

<p>When I use the callback in <code>find_files</code>, <code>$callback</code> has the reference to the code. To dereference it I put the <code>&amp;</code> sigil in front of it.</p>

<p>The <code>find_files</code> subroutine takes a path where the search begins and a code reference called <code>$callback</code>. At each invocation, it stores the path in the return list, if callback returns true for that path. This allows you to reuse <code>find_files</code> for many applications, changing only the callback subroutine to change the outcome. This is the strategy pattern, but without the hassle of subclassing the <code>find_files</code> abstract base class and overriding the criterion method.</p>

<p>In <code>find_files</code>, I use recursion to descend the directory tree and its subtrees. First, I call the callback to see if the current path should go into the output. Then the real routine begins. What the callback does makes no difference to this routine. Any true or false value is OK with <code>find_files</code>.</p>

<p>The recursion stops if the file is not a directory. At that point the list is immediately returned. (It could be empty or have the current path in it, depending on the callback&rsquo;s return value.) Otherwise, all the files and subdirectories in the current path are read into <code>@files</code>. Each of those entries is scanned by the recursive call to find_files (unless the file is . or .., which would create endless recursion). Whatever the recursive call to <code>find_files</code> returns, it is pushed onto the end of the final output. When all children have been visited, <code>@result</code> is returned to the caller.</p>

<p>The CPAN module <code>File::Find</code> robustly solves the problem approached quickly in my example above. It relies on exactly this kind of function callback.</p>

<p>The Strategy Pattern uses a callback to perform a single task that varies from use to use. The next pattern uses a series of callbacks to implement the steps of an algorithm.</p>

<h3 id="span-id-template-method-template-method-span"><span id="template_method">Template Method</span></h3>

<p>In some calculations the steps are known, but what the steps do is not. For example, computing charges for a rental might involve three steps:</p>

<ol>
<li>Calculate amount due from rates.</li>
<li>Calculate taxes.</li>
<li>Add these together.</li>
</ol>

<p>Yet different rentals might have different schemes for calculating the amount due from rates, and different jurisdictions usually have different tax schemes. A template method can implement the outline, deferring to callers for the individual schemes.</p>

<pre><code>    package Calc;
    use strict; use warnings;

    sub calculate {
        my $class     = shift;   # discarded
        my $data      = shift;
        my $rate_calc = shift;   # a code ref
        my $tax_calc  = shift;   # also a code ref

        my $rate      = &amp;$rate_calc($data);
        my $taxes     = &amp;$tax_calc($data, $rate);
        my $answer    = $rate + $taxes;
    }
</code></pre>

<p>Here the caller supplies a data reference (probably to a hash or object) together with two code references which are used as callbacks. Each callback must expect the data reference as its first parameter. The <code>tax_calc</code> code reference also receives the amount due from the rate calculator. This allows it to use a percentage of the amount together with information in the data reference.</p>

<p>A caller might look like this:</p>

<pre><code>    #!/usr/bin/perl
    use strict; use warnings;

    use Calc;

    my $rental = {
        days_used    =&gt; 5,
        day_rate     =&gt; 19.95,
        tax_rate     =&gt; .13,
    };

    my $amount_owed = Calc-&gt;calculate($rental, \&amp;rate_calc, \&amp;taxes);
    print &quot;You owe $amount_owed\n&quot;;

    sub rate_calc {
        my $data = shift;
        return $data-&gt;{days_used} * $data-&gt;{day_rate};
    }

    sub taxes {
        my $data     = shift;  # discarded
        my $subtotal = shift;

        return $data-&gt;{tax_rate} * $subtotal;
    }
</code></pre>

<p>I made this contrived caller so you can see the calling sequence. The data here is a simple hash. To save exporting from <code>Calc</code>, I made calculate a class method, so I call it through its class. In the call, I pass a reference to my data hash and references to the two calculation routines.</p>

<p>This can be made more complex if you like. One could even make a full-blown class hierarchy of calculators, allowing callers to select the one they want. This example is about as simple as I could make the template method pattern.</p>

<p>Another approach to templates is to have the caller place methods in the template package. This approach amounts to an implementation of mixins a la Ruby. Here&rsquo;s a sample that is more object oriented.</p>

<pre><code>    package Calc;

    sub calculate {
        my $self = shift;
        my $rate = $self-&gt;calculate_rate();
        my $tax  = $self-&gt;calculate_tax($rate);
        return $rate + $tax;
    }

    1;
</code></pre>

<p>The whole module is really only the template method. To use it, you have to code <code>calculate_rate</code> and <code>calculate_tax</code> methods, or your script will die. Here&rsquo;s a particular implementation of the scheme:</p>

<pre><code>    package CalcDaily;
    package Calc;
    use strict; use warnings;

    sub new {
        my $class = shift;
        my $self  = {
            days_used    =&gt; shift,
            day_rate     =&gt; shift,
            tax_rate     =&gt; shift,
        };
        return bless $self, $class;
    }

    sub calculate_rate {
        my $data = shift;
        return $data-&gt;{days_used} * $data-&gt;{day_rate};
    }

    sub calculate_tax {
        my $data     = shift;  # discarded
        my $subtotal = shift;

        return $data-&gt;{tax_rate} * $subtotal;
    }

    1;
</code></pre>

<p>Note that I added a constructor and two methods to the <code>Calc</code> package in a different source file. This is perfectly legal and occasionally useful. By doing this, the template is totally isolated. It doesn&rsquo;t even know what sort of data will be stored in the objects of its own type. That does mean that only one <code>Calc</code> subtype can be used at a time. If that&rsquo;s a problem for you, do the standard thing: have <code>Calc</code> call methods on objects in some separate hierarchy.</p>

<p>There are two package statements at the top of the file, this is on purpose. The first one tells people (and crawlers) that this is the <code>CalcDaily</code> package which rightfully belongs in <code>CalcDaily.pm</code>, not the original <code>Calc</code>, which belongs in <code>Calc.pm</code>.</p>

<p>Finally, here&rsquo;s the caller, which is only slightly modified:</p>

<pre><code>    #!/usr/bin/perl
    use strict; use warnings;
    use Calc;
    use CalcDaily;

    my $rental      = Calc-&gt;new(5, 19.95, .13);
    my $amount_owed = $rental-&gt;calculate();
    print &quot;You owe $amount_owed\n&quot;;
</code></pre>

<p>This technique is similar to the one used in the debugger architecture for Perl. To make my own debugger, I need a name for it. I might choose <code>PhilDebug.pm</code>. Then I have to make a file with that name in a Devel directory which is in my <code>@INC</code> list. The first line in the file should be (but doesn&rsquo;t have to be):</p>

<pre><code>    package Devel::PhilDebug;
</code></pre>

<p>This allows the CPAN indexer to properly catalog my module.</p>

<p>The base package for debuggers is fixed as <code>DB</code>. Perl expects to call the <code>DB</code> function in that package. So all together it might look something like this:</p>

<pre><code>    package Devel::PhilDebug;
    package DB;

    sub DB {
        my @info = caller(0);
        print &quot;@info\n&quot;;
    }

    1;
</code></pre>

<p>Any script will use this debugger if it is invoked as:</p>

<pre><code>    perl -d:PhilDebug script
</code></pre>

<p>Each time the debugger notices that a new statement is about to start, it first calls <code>DB::DB</code>. This is a very powerful example of plug-and-play.</p>

<p>It is not usually wise to pollute foreign classes with your own code. Yet, Perl permits this, because it is sometimes highly useful. There seems to be a theme here:</p>

<p><strong>Don&rsquo;t rule out dangerous things. Just avoid them, unless you have a good reason to use them.</strong></p>

<p>The Strategy and Template patterns use code references to allow the caller to adjust the behavior of an algorithm. The template I showed used a data container to hold rental information. The next pattern makes more use of data containers.</p>

<h3 id="span-id-builder-builder-span"><span id="builder">Builder</span></h3>

<p>Many structures external to your program should be represented with composites (like trees or the data container in the introduction) inside your program. There are two fundamentally different ways to represent these structures. For an object-oriented way to compose such structures see the Composite Pattern in GoF (which I will discuss in my next article).</p>

<p>Here we&rsquo;ll look at how to build a composite structure in a hash of hashes. You might rather build the objected-oriented version. Which you choose should depend on the complexity of the data and the methods to act on it. If data and methods are simple, you should probably use the hash structure. It will be faster, have built-in support, and be more familiar to Perl programmers who might need to maintain your code. If the complexities are large, you should use full-blown objects. They make the structure easier to understand for object-oriented programmers and provide more code-based documentation than simple hashes.</p>

<p>So, hashes are superior structures for simple to moderately complex data. To see how to build a hash structure consider an example: visualizing an outline. For simplicity, I&rsquo;ll represent the outline purely through indentation (not with Roman or other numerals). Here&rsquo;s an example outline:</p>

<pre><code>    Grocery Store
        Milk
        Juice
        Butcher
            Thin sliced ham
            Chuck roast
        Cheese
    Cleaners
    Home Center
        Door
        Lock
        Shims
</code></pre>

<p>This outline describes a theoretical shopping trip. I want to represent it internally in my program so I can play with it. (One of my favorite games is turning outlines into pictures, see below.)</p>

<p>Instead of a full-blown object, I&rsquo;ll use a little hash-based data container for each node in the tree. Each node will keep track of three things:</p>

<ol>
<li>Name</li>
<li>Level</li>
<li>Children (a list of other nodes)</li>
</ol>

<p>To keep track of who is a child of whom, I&rsquo;ll use a stack of these nodes. The node on the top of the stack is usually the parent of the next line of input. To show my method, I&rsquo;ll intersperse comments with the script. At the bottom of this section the script appears in one piece.</p>

<pre><code>    #!/usr/bin/perl
    use strict; use warnings;
</code></pre>

<p>These lines are always a good idea.</p>

<pre><code>    my $root = {
        name     =&gt; &quot;ROOT&quot;,
        level    =&gt; -1,
        children =&gt; [],
    };
</code></pre>

<p>This is the root node. It&rsquo;s a hash reference containing the three keys mentioned earlier. The root node is special. Since it isn&rsquo;t in the file, I give it an artificial name and a level that is lower than anyone else&rsquo;s. (In a moment, we will see that levels in the input will be zero or positive.) Initially the list of children is empty.</p>

<pre><code>    my @stack;
    push @stack, $root;
</code></pre>

<p>The stack will keep track of the ancestry of each new node. For starters it needs the root node, which won&rsquo;t ever be popped, because it is an ancestor of all the nodes.</p>

<pre><code>    while (&lt;&gt;) {
        /^(\s*)(.*)/;
        my $indentation = length $1 if defined ($1);
        my $name        = $2;
</code></pre>

<p>To read the file, I chose a magic <code>while</code>. For each line there will be two parts: the indentation (the leading spaces) and the name (the rest of the line). The regular expression captures any leading space into <code>$1</code> and everything else (except the new line) into <code>$2</code>. The length of the indentation is the important part, the bigger this is the more ancestors the node has. Lines starting at the margin have an indentation of 0 (which is why the <code>ROOT</code> has a level of -1).</p>

<pre><code>        while ($indentation &lt;= $stack[-1]{level}) {
            pop @stack;
        }
</code></pre>

<p>This loop handles ancestry. It pops the stack, until the node on top of the stack is the parent of the new node. Think of an example. When <code>Home Center</code> comes along, <code>Cleaners</code> and <code>ROOT</code> are on the stack. <code>Home Center</code>&rsquo;s level is 0 (it&rsquo;s at the margin), so is <code>Cleaners</code>&rsquo;. Thus, <code>Cleaners</code> is popped (since 0 &lt;= 0). Then only <code>ROOT</code> remains, so popping stops (0 is not &lt;= -1).</p>

<pre><code>        my $node = {
            name     =&gt; $name,
            level    =&gt; $indentation,
            children =&gt; [],
        };
</code></pre>

<p>This builds a new node for the current line. It&rsquo;s name and level are set. We haven&rsquo;t seen any children yet, but I make room for them in an empty list.</p>

<pre><code>        push @{$stack[-1]{children}}, $node;
</code></pre>

<p>This line adds the new node to its parent&rsquo;s list of children. Remember that the parent is sitting on top of the stack. The top of the stack is <code>$stack[-1]</code> or the last element in the array.</p>

<pre><code>        push @stack, $node;
    }
</code></pre>

<p>This pushes the new node onto the stack, in case it has children. The closing brace ends the magic <code>while</code> loop. For simplicity, I chose to display the output with <code>Data::Dumper</code>:</p>

<pre><code>    use Data::Dumper; print Dumper($root);
</code></pre>

<p>Running this shows the tree (sideways) on standard out.</p>

<p>Here&rsquo;s the whole code without interruption:</p>

<pre><code>    #!/usr/bin/perl
    use strict; use warnings;

    my $root = {
        name     =&gt; &quot;ROOT&quot;,
        level    =&gt; -1,
        children =&gt; [],
    };

    my @stack;
    push @stack, $root;

    while (&lt;&gt;) {
        /^(\s*)(.*)/;
        my $indentation = length $1;
        my $name        = $2;
        while ($indentation &lt;= $stack[-1]{level}) {
            pop @stack;
        }
        my $node = {
            name     =&gt; $name,
            level    =&gt; $indentation,
            children =&gt; [],
        };
        push @{$stack[-1]{children}}, $node;
        push @stack, $node;
    }

    use Data::Dumper; print Dumper($root);
</code></pre>

<p>I promised to explain how structures like the one above can be turned into pictures. The CPAN module <code>UML::Sequence</code> builds a structure similar to the one shown here. It then uses that to generate a UML Sequence diagram of the steps in SVG (Scalable Vector Graphics) format. That format can be converted with standard tools like Batik to PNG or JPEG. In practice the outlines which I turn into pictures represent call sequences for programs. Perl can even generate the outline by running the program. See <code>UML::Sequence</code> for more details.</p>

<p>When you have some interesting structured input, a builder might help make a good internal structure. One high value builder is <code>XML::DOM</code>. Another with a slightly different approach is <code>XML::Twig</code>. It is not coincidental that XML parsers are really builders, as XML files are non-binary trees.</p>

<h3 id="span-id-interpreter-interpreter-span"><span id="interpreter">Interpreter</span></h3>

<p>If you haven&rsquo;t looked in GoF yet, start with the interpreter pattern. Laughter is good for the soul. The person who taught me patterns in Java did not even know why this pattern would not work in practice. He had heard it was somewhat slow, but he wasn&rsquo;t sure. Well I&rsquo;m sure.</p>

<p>Luckily for us, Perl has alternatives. These range from quick and dirty to full blown. Here&rsquo;s the litany covered with examples below:</p>

<ul>
<li><code>split</code></li>
<li><code>eval</code>&lsquo;ing Perl code</li>
<li><code>Config::Auto</code></li>
<li><code>Parse::RecDescent</code></li>
</ul>

<p>Since we already have a language we like (that&rsquo;s Perl for those who haven&rsquo;t been paying attention), interpreting is limited to small languages that do something for us. Usually these turn out to be configuration files, so I will focus on those. (See the builder section above if a tree can represent your data file.)</p>

<h4 id="span-id-splitting-splitting-span"><span id="splitting">Splitting</span></h4>

<p>The easiest route involves <code>split</code>. Suppose I have a config file which uses <code>variable=value</code> settings. Comments and blanks should be ignored, all other lines should have a variable, value pair. That&rsquo;s easy:</p>

<pre><code>    sub parse_config {
        my $file = shift;
        my %answer;

        open CONFIG, &quot;$file&quot; or die &quot;Couldn't read config file $file: $!\n&quot;;
        while (&lt;CONFIG&gt;) {
            next if (/^#|^\s*$/);  # skip blanks and comments
            my ($variable, $value) = split /=/;
            $answer{$variable} = $value;
        }
        close CONFIG;

        return %answer;
    }
</code></pre>

<p>This subroutine expects a config file name. It opens and reads that file. Inside the magic <code>while</code> loop the regex rejects lines which start with &lsquo;#&rsquo; and those which contain only whitespace. All other lines are split on &lsquo;=&rsquo;. The variables become keys in the <code>%answer</code> hash. When all the lines are read, the caller gets the hash back.</p>

<p>You could go much further along these lines, but see below for those who&rsquo;ve gone before you (see especially <code>Config::Auto</code>).</p>

<h4 id="span-id-evaluating-perl-code-evaluating-perl-code-span"><span id="evaluating_perl_code">Evaluating Perl Code</span></h4>

<p>My current favorite way to bring configuration information into a Perl program is to specify the config file in Perl. So, I might have a config file like this:</p>

<pre><code>    our $db_name = &quot;projectdb&quot;;
    our $db_pass = &quot;my_special_password_no_one_will_think_of&quot;;
    our %personal = (
        name    =&gt; &quot;Phil Crow&quot;,
        address =&gt; &quot;philcrow2000@yahoo.com&quot;,
    );
</code></pre>

<p>To use this in a Perl program all I have to do is eval it:</p>

<pre><code>    ...
    open CONFIG, &quot;config.txt&quot; or die &quot;couldn't...\n&quot;;
    my $config = join &quot;&quot;, &lt;CONFIG&gt;;
    close CONFIG;

    eval $config;
    die &quot;Couldn't eval your config: $@\n&quot; if $@;
    ...
</code></pre>

<p>To read the file, I open it, then use join to put the angle read operator in list context. This lets me bring the whole file into a scalar. Once it&rsquo;s in (and the file is closed for tidiness), I just eval the string I read. I need to check <code>$@</code> to make sure the file was good Perl. After that, I&rsquo;m ready to use the values just as if they appeared in the program originally.</p>

<h4 id="span-id-config-auto-for-those-who-can-t-be-bothered-config-auto-for-those-who-can-t-be-bothered-span"><span id="config::auto__for_those_who_can't_be_bothered">Config::Auto &ndash; For Those Who Can&rsquo;t be Bothered</span></h4>

<p>If you&rsquo;re too lazy to write your own config handler, or if you have lots of configs outside your control, <code>Config::Auto</code> may be for you. Basically, it takes a file and guesses how to turn it into a config hash. (It can even guess the name of your config file). Using it is easy (if it works):</p>

<pre><code>    #!/usr/bin/perl
    use strict; use warnings;

    use Config::Auto;

    my $config = Config::Auto::parse(&quot;your.config&quot;);
    ...
</code></pre>

<p>What ends up in <code>$config</code> depends on what your config file looks like (shock). For files which use <code>variable=value</code> pairs, you get what you expect, which is exactly what the first example above generates for the same input. It is possible to specify a config file that <code>Config::Auto</code> cannot understand (shock and amazement).</p>

<h4 id="span-id-real-hackers-use-parse-recdescent-real-hackers-use-parse-recdescent-span"><span id="real_hackers_use_parse::recdescent">Real Hackers Use Parse::RecDescent</span></h4>

<p>If the file you need to parse is complex, consider <code>Parse::RecDescent</code>. It implements a clever top/down parser scheme. To use it, you specify a grammar. (You remember grammars, don&rsquo;t you? If not, see below.) It builds a parser from your grammar. You feed text to the parser. It does whatever the grammar specifies in its actions.</p>

<p>To give you a feel for how this works, I&rsquo;ll parse small Roman numerals. The program below takes numbers from the keyboard and translates them from Roman numerals to decimal integers, so XXIX becomes 29.</p>

<pre><code>    #!/usr/bin/perl
    use strict; use warnings;

    use Parse::RecDescent;

    my $grammar = q{
        Numeral : TenList FiveList OneList /\Z/
                    { $item[1] + $item[2] + $item[3]; }
                | /quit/i { exit(0); }
                | &lt;error&gt;

        TenList : Ten(3)                  { 30            }
                | Ten(2) OptionalNine     { 20 + $item[2] }
                | Ten OptionalNine        { 10 + $item[2] }
                | OptionalNine            { $item[1]      }

        OptionalNine : One Ten { 9 }
                     |         { 0 }

        FiveList : One Five { 4 }
                 | Five     { 5 }
                 |          { 0 }

        OneList : /(I{0,3})/i { length $1 }

        Ten : /X/i

        Five : /V/i

        One : /I/i
};
</code></pre>

<p>my $parse = new Parse::RecDescent($grammar);</p>

<p>while (&lt;&gt;) { chomp; my $value = $parse-&gt;Numeral($_); print ``value: $value\n&rdquo;; }</p>

<p>As you can see <code>$grammar</code> takes up most of the space in this program. The rest is pretty simple. Once I receive the parser from the <code>Parse::RecDescent</code> constructor, I just call its Numeral method repeatedly.</p>

<p>So what does the grammar mean? Let&rsquo;s start at the top. Grammars are built from rules. The rule for a Numeral (the Roman kind) says:</p>

<pre><code>    A Numeral takes the form of one of these choices
        a TenList then a FiveList then a OneList then the end of the string
        OR
        the word quit in any case (not a Numeral, but a way to quit)
        OR
        anything else, which is an error
</code></pre>

<p>We&rsquo;ll see what TenList and its friends are shortly. The code after the first choice is called an action. If the rule matches a possibility, it performs that possibility&rsquo;s action. So if a valid Numeral is seen, the action is executed. This particular action adds up the values TenList, FiveList, and OneList have accumulated. The items are numbered starting with 1, so TenList&rsquo;s value is in <code>$item[1]</code>, etc.</p>

<p>How does TenList get a value? Well, when Numeral starts matching, it looks first for a valid TenList. There are four choices:</p>

<pre><code>    A TenList takes the form of one of these choices
        three Tens
        OR
        two Tens then an OptionalNine
        OR
        a Ten then an OptionalNine
        OR
        an OptionalNine
</code></pre>

<p>These choices are tried in order. A Ten is simply an upper- or lower-case X (see the Ten rule). The result of an action is the result of its last statement. So, if there are three tens, the TenList returns 30. If there are two tens, it returns 20 plus whatever OptionalNine returned.</p>

<p>The Roman numeral IX is our 9. I call this an OptionalNine. (The names are completely arbitrary.) So after zero, one, or two X&rsquo;s, there can be an IX which adds 9 to the total. If there is no IX, the OptionalNine will match the empty rule. That consumes no text from the input and returns zero according to its action.</p>

<p>Roman numerals are a lot more complex than my little grammar can handle. For starters, by my calendar, we&rsquo;re now in the year MMIII. There are no M&rsquo;s in my grammar. Further, some Romans thought that IIIIII was perfectly valid. In my grammar three is the limit for all repetitions, and only I and X can repeat. Further, reductions can only take one away. So, IIX is not eight, it&rsquo;s invalid. This grammar can recognize any normalized Roman numeral up to 38. Feel free to expand it.</p>

<p><code>Parse::RecDescent</code> is not as fast as a yacc-generated parser, but it is easier to use. See the documentation in the distribution for more information, especially the tutorial which originally appeared in The Perl Journal.</p>

<p>If you look at what&rsquo;s inside the parser (say with <code>Data::Dumper</code>) you might think this actually implements the interpreter pattern. After all, it makes a tree of objects from the grammar. Look closer and you will see the key difference. All of the objects in the tree are members of classes of like <code>Parse::RecDescent::Action</code>, which were written by Damian Conway when he wrote the module. In the GoF interpreter pattern we are expected to build a class for each non-terminal in the grammar (above those classes would be Numeral, ReducedTen, etc.). Thus, the tree node types are different for each grammar.</p>

<p>This difference has two implications: (1) it makes the <code>RecDescent</code> parser generator simpler and (2) it&rsquo;s result faster.</p>

<h3 id="span-id-summary-summary-span"><span id="summary">Summary</span></h3>

<p>In this installment we have seen how to use code references to implement the Strategy and Template Method patterns. We even saw how to force our code into someone else&rsquo;s class. Builder turns text into an internal structure, which most Interpreters also do. Those structures can often be simple combinations of hashes, lists, and scalars. If what you need to read is simpler, use split or <code>Config::Auto</code>. If it is more complex, use <code>Parse::RecDescent</code>. If that won&rsquo;t do it fast enough, you might need one of the yaccs.</p>

<p>Next time I will look at patterns which actually rely on objects.</p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/development">development</a></div>
                
                  <div class="tag"><a href="/tags/design-patterns">design-patterns</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-phil-crow">
  <div class="col-sm-2">
    
    <a href="/authors/phil-crow/"><div class="circle-avatar" style="background-image:url(/images/site/avatar.png)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/phil-crow/"><h3>Phil Crow</h3></a>
    <p></p>
    <h5><a href="/authors/phil-crow/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/legacy/_pub_2003_08_07_design2.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

