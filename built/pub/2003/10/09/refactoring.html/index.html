<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> A Refactoring Example </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content=" About a year ago, a person asked the Fun With Perl mailing list about some code they had written to do database queries. It&#39;s important to note that this person was posting from an .it address; why will become..."/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/pub/2003/10/09/refactoring.html/" />
<meta property="og:title" content="A Refactoring Example" />
<meta property="og:description" content=" About a year ago, a person asked the Fun With Perl mailing list about some code they had written to do database queries. It&#39;s important to note that this person was posting from an .it address; why will become...">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2003-10-10T10:10:10Z" />
<meta property="og:image" content="http://localhost:1313/images/_pub_2003_10_09_refactoring/111-refactoring.gif" />
<meta property="og:article:tag" content="faster" />
<meta property="og:article:tag" content="optimization" />
<meta property="og:article:tag" content="perl" />
<meta property="og:article:tag" content="refactoring" />
<meta property="og:article:tag" content="speed" />
<meta property="og:article:tag" content="style-guides" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">A Refactoring Example</h1>
              <p class="blog-post-meta">Oct 9, 2003 by
              
              
                
                
                <a href="#author-bio-michael-schwern">Michael Schwern</a>
              
              </p>
              <img alt="" src=""/>
                

<p>About a year ago, a person asked the <a href="http://www.technofile.org/technofile/depts/mlists/fwp.html">Fun With Perl</a> mailing list about some code they had written to do database queries. It&rsquo;s important to note that this person was posting from an .it address; why will become apparent later. The code was reading records in from a text file and then doing a series of queries based on that information. They wanted to make it faster.</p>

<p>Here&rsquo;s his code:</p>

<pre><code>open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($riga=&lt;INPUT&gt;){
$nump++;
chop($riga);
$pagina[$nump] = $riga;

$sth= $dbh-&gt;prepare(&quot;SELECT count(*) FROM lognew WHERE
pageid='$pagina[$nump]' and data&gt;='$startdate'&quot;);
$sth-&gt;execute;
$totalvisit[$nump] = $sth-&gt;fetchrow_array();

$sth = $dbh-&gt;prepare(&quot;SELECT count(*) FROM lognew WHERE
(pageid='$pagina[$nump]' and data='$dataoggi')&quot;);
$sth-&gt;execute;
$totalvisittoday[$nump] = $sth-&gt;fetchrow_array();

 $sth = $dbh-&gt;prepare(&quot;SELECT count(*) FROM lognew WHERE
(pageid='$pagina[$nump]' and data='$dataieri')&quot;);
$sth-&gt;execute;
$totalyvisit[$nump] = $sth-&gt;fetchrow_array();

 $sth= $dbh-&gt;prepare(&quot;SELECT count(*) FROM lognew WHERE
(pageid='$pagina[$nump]' and data&lt;='$fine30gg' and data&gt;='$inizio30gg')&quot;);
$sth-&gt;execute;
$totalmvisit[$nump] = $sth-&gt;fetchrow_array();

 }
</code></pre>

<p>I decided that rather than try to read through this code and figure out what it&rsquo;s doing and how to make it faster, I&rsquo;d clean it up first. Clean it up <strong>before</strong> you figure out how it works? Yes, using a technique called <em>Refactoring</em>.</p>

<h3 id="refactoring">Refactoring?</h3>

<p>In his book, Martin Fowler defines Refactoring as <em>&ldquo;the process of changing a software system in such a way that it does not alter the external behavior of the code yet improves its internal structure.&rdquo;</em> In other words, you clean up your code but don&rsquo;t change what it does.</p>

<p>Refactoring can be as simple as changing this code:</p>

<pre><code>$exclamation = 'I like '.$pastry.'!';
</code></pre>

<p>To this:</p>

<pre><code>$exclamation = &quot;I like $pastry!&quot;;
</code></pre>

<p>Still does the same thing, but it&rsquo;s easier to read.</p>

<p>It&rsquo;s important to note that I don&rsquo;t need to know anything about the contents of <code>$pastry</code> or how <code>$exclamation</code> is used. The change is completely self-contained and does not affect surrounding code or change what it does. This is Refactoring.</p>

<p>On the principle of &ldquo;show me don&rsquo;t tell me,&rdquo; rather than talk about it, we&rsquo;ll dive right into refactoring our bit of code.</p>

<h3 id="fix-the-indentation">Fix the Indentation</h3>

<p>Your first impulse when faced with a hunk of code slammed against the left margin is to indent it. This is our first refactoring.</p>

<pre><code>open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $sth= $dbh-&gt;prepare(&quot;SELECT count(*) FROM lognew WHERE
                         pageid='$pagina[$nump]' and data&gt;='$startdate'&quot;);
    $sth-&gt;execute;
    $totalvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare(&quot;SELECT count(*) FROM lognew WHERE
                          (pageid='$pagina[$nump]' and data='$dataoggi')&quot;);
    $sth-&gt;execute;
    $totalvisittoday[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare(&quot;SELECT count(*) FROM lognew WHERE
                          (pageid='$pagina[$nump]' and data='$dataieri')&quot;);
    $sth-&gt;execute;
    $totalyvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth= $dbh-&gt;prepare(&quot;SELECT count(*) FROM lognew WHERE
                         (pageid='$pagina[$nump]' and data&lt;='$fine30gg' 
                         and data&gt;='$inizio30gg')&quot;);
    $sth-&gt;execute;
    $totalmvisit[$nump] = $sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Already it looks better. We can see that we&rsquo;re iterating over a file, performing some SELECTs on each line and shoving the results into a bunch of arrays.</p>

<h3 id="a-single-simple-change">A Single, Simple Change</h3>

<p>One of the most important principles of Refactoring is that you work in small steps. This re-indentation is a single step. And part of this single step includes running the test suite, logging the change, and checking it into CVS.</p>

<p>Checking into CVS after something this simple? Yes. Many programmers ask the question, &ldquo;When should I check in?&rdquo; When you&rsquo;re refactoring it&rsquo;s simple: check in when you&rsquo;ve done one refactoring and have tested that it works. Our re-indentation is one thing; we test that it works and check it in.</p>

<p>This may seem excessive, but it prevents us from entangling two unrelated changes together. By doing one change at a time we know that any new bugs were introduced by that one change. Also, you will often decide in the middle of a refactoring that it&rsquo;s not such a good idea. When you&rsquo;ve checked in at every one you can simply rollback to the last version rather than having to undo it by hand. Convenient, and you&rsquo;re sure no stray bits of your aborted change are hanging around.</p>

<p>So our procedure for doing a proper refactoring is:</p>

<ul>
<li>Make one logical change to the code.</li>
<li>Make sure it passes tests.</li>
<li>Log and check in.</li>
</ul>

<h3 id="big-refactorings-from-small">Big Refactorings from Small</h3>

<p>The goal of this refactoring is to make the code go faster. One of the simplest ways to do achieve that is to pull necessary code out of the loop. Preparing four new statements in every iteration of the loop seems really unnecessary. We&rsquo;d like to pull those <code>prepare()</code> statements out of the loop. This is a refactoring. To achieve this larger refactoring, a series of smaller refactorings must be done.</p>

<h3 id="use-bind-variables">Use Bind Variables</h3>

<p>Each time through the loop, a new set of SQL statements is created based on the line read in. But they&rsquo;re all basically the same, just the data is changing. If we could pull that data out of the statement we&rsquo;d be closer to our goal of pulling the <code>prepare()</code>s out of the loop.</p>

<p>So my next refactoring pulls variables out of the SQL statements and replaces them with placeholders. Then the data is bound to the statement using bind variables. This means we&rsquo;re now <code>prepare()</code>ing the same statements every time through the loop.</p>

<p>Before refactoring:</p>

<pre><code>$sth= $dbh-&gt;prepare(&quot;SELECT count(*) FROM lognew WHERE
                     pageid='$pagina[$nump]' and data&gt;='$startdate'&quot;);
$sth-&gt;execute;
</code></pre>

<p>After refactoring:</p>

<pre><code>$sth= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                     pageid=? and data&gt;=?');
$sth-&gt;execute($pagina[$nump], $startdate);
</code></pre>

<p>Bind variables also protect against a naughty user from trying to slip some extra SQL into your program via the data you read in. As a side-effect of our code cleanup, we&rsquo;ve closed a potential security hole.</p>

<pre><code>open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $sth= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                         pageid=? and data&gt;=?');
    $sth-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                          (pageid=? and data=?)');
    $sth-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = $sth-&gt;fetchrow_array();

    $sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                          (pageid=? and data=?)');
    $sth-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = $sth-&gt;fetchrow_array();

    $sth= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                         (pageid=? and data&lt;=? and data&gt;=?)');
    $sth-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = $sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="split-a-poorly-reused-variable">Split a Poorly Reused Variable</h3>

<p>The next stumbling block to pulling the <code>prepare()</code> statements out of the loop is that they all use the same variable, <code>$sth</code>. We&rsquo;ll have to change it so they all use different variables. While we&rsquo;re at it, we&rsquo;ll name those statement handles something more descriptive of what the statement does. Since at this point we haven&rsquo;t figured out what the statements do, we can base the name on the array it gets assigned to.</p>

<p>While we&rsquo;re at it, throw in some <code>my()</code> declarations to limit the scope of these variables to just the loop.</p>

<pre><code>open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    my $totalvisit_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                                        pageid=? and data&gt;=?');
    $totalvisit_sth-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = $totalvisit_sth-&gt;fetchrow_array();

    my $totalvisittoday_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                             (pageid=? and data=?)');
    $totalvisittoday_sth-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = $totalvisittoday_sth-&gt;fetchrow_array();

    my $totalyvisit_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                         (pageid=? and data=?)');
    $totalyvisit_sth-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = $totalyvisit_sth-&gt;fetchrow_array();

    my $totalmvisit_sth= $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                        (pageid=? and data&lt;=? and data&gt;=?)');
    $totalmvisit_sth-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="getting-better-all-the-time">Getting Better All the Time</h3>

<p>The new names are better, but they&rsquo;re not great. This is ok. Naming is something people often get hung up on. One can spend hours wracking their brains thinking of the perfect name for a variable or a function. If you can think of a better one than what&rsquo;s there right now, use it. The beauty of Refactoring is you an always improve upon it later.</p>

<p>This is an important lesson of Refactoring. Voltare said, &ldquo;the best is the enemy of the good&rdquo;. We often get so wound up trying to make code <em>great</em> that we fail to improve it at all. In refactoring, it&rsquo;s not so important to make your code great in one leap, just a little better all the time (it&rsquo;s a little known fact John Lennon was into Refactoring.) These small improvements will build up into a clean piece of code, with less bugs, more surely than a large-scale code cleanup would.</p>

<h3 id="pull-code-out-of-the-loop">Pull Code Out of the Loop</h3>

<p>Now it&rsquo;s a simple cut and paste to pull the four <code>prepare()</code> statements out of the loop.</p>

<pre><code>my $totalvisit_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE 
                                    pageid=? and data&gt;=?');

my $totalvisittoday_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                         (pageid=? and data=?)');

my $totalyvisit_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                     (pageid=? and data=?)');

my $totalmvisit_sth = $dbh-&gt;prepare('SELECT count(*) FROM lognew WHERE
                                     (pageid=? and data&lt;=? and data&gt;=?)');

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $totalvisit_sth-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalyvisit_sth-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = $totalyvisit_sth-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Already the code is looking better. With the SQL separated, the inner workings of the loop are much less daunting.</p>

<p>Test. Log. Check in.</p>

<h3 id="a-place-to-stop">A Place to Stop</h3>

<p>Remember our goal, to make this code run faster. By pulling the <code>prepare()</code> statements outside the loop we&rsquo;ve likely achieved this goal. Additionally, it still does exactly what it did before even though we still don&rsquo;t fully understand what that is. If this were a real project, you&rsquo;d do some benchmarking to see if the code is fast enough and move on to another task.</p>

<p>Since this is an example, I&rsquo;ll continue with more refactorings with the goal of clarifying the code further and figuring out what it does.</p>

<p>Keep in mind that after every refactoring the code still does <em>exactly what it did before</em>. This means we can stop choose to stop after any refactoring. If a more pressing task suddenly pops up we can pause our refactoring work and attend to that feeling confident we didn&rsquo;t leave any broken code lying around.</p>

<h3 id="reformat-sql-for-better-readability">Reformat SQL for Better Readability</h3>

<p>In order to make sense of the code, we have to make sense of the SQL. The simplest way to better understand the SQL is to put it into a clearer format.</p>

<p>The three major parts of an SQL SELECT statement are:</p>

<ul>
<li>The rows (ie. <code>SELECT count(*)</code>)</li>
<li>The table (ie. <code>FROM lognew</code>)</li>
<li>The predicate (ie. <code>WHERE pageid = ...</code>)</li>
</ul>

<p>I&rsquo;ve chosen a new format that highlights these parts.</p>

<p>I&rsquo;ve also removed some unnecessary parenthesis because they just serve to clutter things up rather than disambiguate an expression.</p>

<p>I&rsquo;ve also decided to change the quoting style from single quotes to a here-doc. It would have also been okay to use <code>q{}</code>.</p>

<pre><code>my $totalvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $totalvisittoday_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $totalyvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $totalmvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $totalvisit_sth-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalyvisit_sth-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = $totalyvisit_sth-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="remove-redundancy">Remove Redundancy</h3>

<p>With the SQL in a more readable format, some commonalities become clear.</p>

<ul>
<li>All the statements are doing a <code>count(*)</code>.</li>
<li>They&rsquo;re all using the <code>lognew</code> table</li>
<li>They&rsquo;re all looking for a certain <code>pageid</code>.</li>
</ul>

<p>In fact, <code>$totalvisittoday_sth</code> and <code>$totalyvisit_sth</code> are exactly the same! Let&rsquo;s eliminate one of them, doesn&rsquo;t matter which, we&rsquo;re going to rename them in a moment anyway. <code>$totalyvisit_sth</code> goes away, making sure to change all references to it to <code>$totalvisittoday_sth</code>.</p>

<pre><code>my $totalvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $totalvisittoday_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $totalmvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($riga=&lt;INPUT&gt;){
    $nump++;
    chop($riga);
    $pagina[$nump] = $riga;

    $totalvisit_sth-&gt;execute($pagina[$nump], $startdate);
    $totalvisit[$nump] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pagina[$nump], $dataoggi);
    $totalvisittoday[$nump] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pagina[$nump], $dataieri);
    $totalyvisit[$nump] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($pagina[$nump], $fine30gg, $inizio30gg);
    $totalmvisit[$nump] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="fix-conflicting-styles">Fix Conflicting Styles</h3>

<p>Now the only difference between the statements is the choice of <code>data</code> ranges.</p>

<p>Using the variables are passed into each statement we can make some more deductions. Let&rsquo;s have a look&hellip;</p>

<ul>
<li><code>$startdate</code></li>
<li><code>$dataoggi</code></li>
<li><code>$dataieri</code></li>
<li><code>$fine30gg, $inizio30gg</code></li>
</ul>

<p><em>One of these things is not like the other.</em> What&rsquo;s <code>$startdate</code> doing there? Everything else is talking about &lsquo;data&rsquo;. What&rsquo;s &lsquo;ieri&rsquo;? &lsquo;oggi&rsquo;? Remember, the programmer who submitted this code is Italian. Maybe the names are in Italian. Grabbing an <a href="http://dictionaries.travlang.com/ItalianEnglish/">Italian-English dictionary</a> we find out that &lsquo;data&rsquo; is Italian for &lsquo;date&rsquo;! Now it makes sense, this code was probably originally written in English, then worked on by an Italian (or vice-versa).</p>

<p>This code has committed a cardinal stylistic sin. It uses two different languages for naming variables. Not just different languages, languages which have different meanings for the same words. Taken out of context, we can&rsquo;t know if <code>$data</code> represents a hunk of facts or &ldquo;Thursday.&rdquo;</p>

<p>Since the styles conflict, one of them has to go. Since I don&rsquo;t speak Italian, I&rsquo;m going to translate it into English.</p>

<p>Pulling out our Italian-to-English dictionary&hellip;</p>

<ul>
<li>&ldquo;riga&rdquo; is &ldquo;line&rdquo;</li>
<li>&ldquo;pagina&rdquo; is &ldquo;page&rdquo;</li>
<li>&ldquo;nump&rdquo; is probably short for &ldquo;numero pagina&rdquo; which is &ldquo;page number&rdquo;</li>
<li>&ldquo;data&rdquo; is &ldquo;date&rdquo;</li>
<li>&ldquo;oggi&rdquo; is &ldquo;today&rdquo;</li>
<li>&ldquo;ieri&rdquo; is &ldquo;yesterday&rdquo;</li>
<li>&ldquo;inizio&rdquo; is &ldquo;start&rdquo;</li>
<li>&ldquo;fine&rdquo; is &ldquo;end&rdquo;</li>
<li>&ldquo;gg&rdquo; is probably short for &ldquo;giorni&rdquo; which is &ldquo;days&rdquo;

<ul>
<li>&ldquo;fine30gg&rdquo; would then be &ldquo;the end of 30 days&rdquo;</li>
<li>&ldquo;inizio30gg&rdquo; would be &ldquo;the beginning of 30 days&rdquo;</li>
</ul></li>
</ul>

<p>It would be a straightforward matter of a bunch of search-and-replaces in any good editor but for one snag, the SQL column &lsquo;data.&rsquo; We&rsquo;d like to change this to its English &lsquo;date&rsquo;, but databases are very global with possibly lots of other programs using it. So we can&rsquo;t change the column name without breaking other code. While in a well-organized programming shop you might have the ability to find all the code which uses your database, we won&rsquo;t assume we have that luxury here. For the moment then, we&rsquo;ll leave that be and deal with it in a separate refactoring.</p>

<pre><code>my $totalvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $totalvisittoday_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $totalmvisit_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($line=&lt;INPUT&gt;){
    $page_num++;
    chop($line);
    $pages[$page_num] = $line;

    $totalvisit_sth-&gt;execute($pages[$page_num], $start_date);
    $totalvisit[$page_num] = $totalvisit_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pages[$page_num], $today);
    $totalvisittoday[$page_num] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalvisittoday_sth-&gt;execute($pages[$page_num], $yesterday);
    $totalyvisit[$page_num] = $totalvisittoday_sth-&gt;fetchrow_array();

    $totalmvisit_sth-&gt;execute($pages[$page_num], $end_of_30_days,
                                                 $start_of_30_days);
    $totalmvisit[$page_num] = $totalmvisit_sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="better-names">Better Names</h3>

<p>With decent variable names in place, the purpose of the program becomes <strong>much</strong> clearer. This is a program to calculate the number of visits to a page for various date ranges. Based on this new information we can give the statement handles and the arrays they put data into better names.</p>

<p>Looking at the SQL we see we&rsquo;ve got:</p>

<ul>
<li>One to get all the visits up to a single day.</li>
<li>One to get the visits for a certain date.</li>
<li>One to get the visits for a range of dates.</li>
</ul>

<p>A good set of new names would be:</p>

<ul>
<li>daily</li>
<li>up to</li>
<li>range</li>
</ul>

<p>Also, Total Visits is too long. We could shorten that to just Visits, or even shorter to Hits.</p>

<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($line=&lt;INPUT&gt;){
    $page_num++;
    chop($line);
    $pages[$page_num] = $line;

    $hits_upto_sth-&gt;execute($pages[$page_num], $start_date);
    $totalvisit[$page_num] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($pages[$page_num], $today);
    $totalvisittoday[$page_num] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($pages[$page_num], $yesterday);
    $totalyvisit[$page_num] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($pages[$page_num], $end_of_30_days,
                                                $start_of_30_days);
    $totalmvisit[$page_num] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="changing-global-variable-names">Changing Global Variable Names</h3>

<p>The array names need work, too. Currently, they&rsquo;re rather ambiguous. <code>@totalyvisit</code>, what does the <em>y</em> mean? Looking at each variable name and the variables that got passed to <code>execute()</code> to produce it&hellip;</p>

<ul>
<li><code>@totalvisit</code> comes up to a <code>$start_date</code>. So that can be <code>@hits_upto</code></li>
<li><code>@totalvisittoday</code> comes from <code>$today</code> and is pretty obvious. <code>@hits_today</code></li>
<li><code>@totalyvisit</code> comes from <code>$yesterday</code> so &lsquo;y&rsquo; must be for &lsquo;yesterday&rsquo;. <code>@hits_yesterday</code></li>
<li><code>@totalmvisit</code> comes from the range produced by the $start_of_30_days and the $end_of_30_days. So &rsquo;m&rsquo; must be &lsquo;month&rsquo;. <code>@hits_monthly</code></li>
</ul>

<!-- -->

<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($line=&lt;INPUT&gt;){
    $page_num++;
    chop($line);
    $pages[$page_num] = $line;

    $hits_upto_sth-&gt;execute($pages[$page_num], $start_date);
    $hits_upto[$page_num] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($pages[$page_num], $today);
    $hits_today[$page_num] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($pages[$page_num], $yesterday);
    $hits_yesterday[$page_num] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($pages[$page_num], $end_of_30_days,
                                                $start_of_30_days);
    $hits_monthly[$page_num] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Test&hellip; uh-oh, test failed!</p>

<p>There&rsquo;s something <strong>very</strong> different about this change compared to the others. The variables we changed were <em>not</em> declared in our little code block. Likely they&rsquo;re used in other parts of the code, such as our test which caused it to break.</p>

<p>In the Real World, we would be sure to <strong>replace all occurrences of the variable</strong>. The simplest way to do this is to use your editor to perform a search and replace rather than doing it by your all too fallible hands. If it could be used over a set of files, grepping through those files for all occurrences of it and changing those as well would be necessary.</p>

<pre><code># If you don't have rgrep, grep -r does the same thing.
rgrep '[@$]totalvisit' /path/to/your/project
</code></pre>

<p>I do this so often that I&rsquo;ve taken to calling grep -r, &lsquo;Refactoring Grep&rsquo;. Other languages who&rsquo;s syntax is &ndash; ummm &ndash; not as inspired as Perl&rsquo;s, such as Java, C++ and Python, have tools for doing this sort of thing automatically. Because of the complexity of Perl&rsquo;s syntax, we still have to do it mostly by hand, though there are some efforts underway to rectify this.</p>

<p>Changing the array names in our test as well we get them to pass.</p>

<p>Log. Check in.</p>

<h3 id="improve-overly-generic-names">Improve Overly Generic Names</h3>

<p>Continuing with our variable name improvements, we&rsquo;re left with the last few unimproved names. Let&rsquo;s start with <code>$line</code>.</p>

<p>Since we can see clearly that <code>$line = &lt;INPUT&gt;</code>, calling the variable &lsquo;line&rsquo; tells us nothing new. A better name might be what each line contains. Looking at how the line is used we see <code>$pages[$page_num] = $line</code> and how that is then used in the SQL. It&rsquo;s a page id.</p>

<p>But it doesn&rsquo;t make much sense to put a page id into an array called <code>@pages</code>. It doesn&rsquo;t contain pages, it contains <code>@page_ids</code>.</p>

<p>What about <code>$page_num</code>? It doesn&rsquo;t contain a page number, it contains the line number of the file we&rsquo;re reading in. Or more conventionally, an <code>$index</code> or <code>$idx</code>.</p>

<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &lt;= ? AND 
       data   &gt;= ?
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chop($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_ids[$idx], $start_date);
    $hits_upto[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $today);
    $hits_today[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $yesterday);
    $hits_yesterday[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_ids[$idx], $end_of_30_days,
                                                   $start_of_30_days);
    $hits_monthly[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="fixing-odd-interfaces">Fixing Odd Interfaces</h3>

<p>What&rsquo;s wrong with this picture?</p>

<pre><code>$hits_range_sth-&gt;execute($page_ids[$idx], $end_of_30_days,
                                               $start_of_30_days);
</code></pre>

<p>Isn&rsquo;t it a little odd to specify a date range with the end first? Sure is. It also guarantees someone is going to get it backwards. Reverse it. Don&rsquo;t forget the SQL, too.</p>

<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chop($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_ids[$idx], $start_date);
    $hits_upto[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $today);
    $hits_today[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $yesterday);
    $hits_yesterday[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_ids[$idx], $start_of_30_days,
                                                   $end_of_30_days);
    $hits_monthly[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="s-chop-chomp">s/chop/chomp/</h3>

<p>Now that we&rsquo;ve stared at the code for a while, you might have noticed the use of <code>chop()</code>. Using <code>chop()</code> to strip a newline is asking for portability problems, so let&rsquo;s fix it by using <code>chomp()</code>.</p>

<p>Technically this <em>isn&rsquo;t</em> a refactoring since we altered the behavior of the code by fixing the bug. But using <code>chop()</code> where you meant <code>chomp()</code> is such a common mistake we&rsquo;ll make it an honorary refactoring.</p>

<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chomp($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_ids[$idx], $start_date);
    $hits_upto[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $today);
    $hits_today[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $yesterday);
    $hits_yesterday[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_ids[$idx], $start_of_30_days,
                                                   $end_of_30_days,);
    $hits_monthly[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="collect-related-variables-into-hashes">Collect Related Variables into Hashes</h3>

<p>The common prefix <code>hits_</code> is a dead giveaway that much of the data in this code is related. Related variables should be grouped together into a single structure, probably a hash to make the relation obvious and allow them to be passed around to subroutines more easily. Its easier to move around one hash than four arrays.</p>

<p>I&rsquo;ve decided to collect together all the <code>@hit_</code> arrays into a single hash <code>%hits</code> since they&rsquo;ll probably be used together parts of the program. If this code snippet represents a function it means I can return one hash reference rather than four array refs. It also makes future expansion easier, rather than returning an additional array it simply becomes another key in the hash.</p>

<p>Before.</p>

<pre><code>$hits{upto}[$idx] = $hits_upto_sth-&gt;fetchrow_array();
</code></pre>

<p>After.</p>

<pre><code>$hits_upto[$idx]  = $hits_upto_sth-&gt;fetchrow_array();
</code></pre>

<p>It&rsquo;s interesting to note what a small, natural change this is. Circumstantial evidence that this is a good refactoring.</p>

<p>As before, since these arrays are global data, we must be sure to change them everywhere. This includes the tests.</p>

<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chomp($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_ids[$idx], $start_date);
    $hits{upto}[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $today);
    $hits{today}[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_ids[$idx], $yesterday);
    $hits{yesterday}[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_ids[$idx], $start_of_30_days,
                                                   $end_of_30_days,);
    $hits{monthly}[$idx] = $hits_range_sth-&gt;fetchrow_array();
}

close (INPUT);
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="when-not-to-refactor">When Not to Refactor</h3>

<p>The statement handles are also related, but I&rsquo;m not going to collect them together into a hash. The statement handles are short-lived lexicals, they&rsquo;re never likely to be passed around. Their short scope and grouping within the code makes their relationship obvious. The design would not be improved by the refactoring.</p>

<p>Refactoring is not a set of rules to be slavishly followed, it&rsquo;s a collection of tools. And like any other tool you must carefully consider when and when not to use it. Since collecting the statement handles together doesn&rsquo;t improve the design, I won&rsquo;t do it.</p>

<h3 id="eliminate-unnecessary-longhand">Eliminate Unnecessary Longhand</h3>

<p>Boy, we sure use <code>$page_ids[$idx]</code> a lot. It&rsquo;s the current page ID. But don&rsquo;t we have a variable for that?</p>

<p>Replace all the unnecessary array accesses and just use the more concise and descriptive <code>$page_id</code>.</p>

<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chomp($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_id, $start_date);
    $hits{upto}[$idx] = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $today);
    $hits{today}[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $yesterday);
    $hits{yesterday}[$idx] = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_id, $start_of_30_days,
                                       $end_of_30_days,);
    $hits{monthly}[$idx] = $hits_range_sth-&gt;fetchrow_array();
}
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="rearrange-data-structures-to-fit-their-use">Rearrange Data Structures to Fit Their Use</h3>

<p>Currently, <code>%hits</code> is accessed by the order the page ID was read out of the file. Well, that doesn&rsquo;t seem very useful at all. Its purpose seems to be for listing the page counts in exactly the same order as you read them in. Even then you need to iterate through <code>@page_ids</code> simultaneously because no where in <code>%hits</code> is the page ID stored.</p>

<p>Consider a common operation, looking up the hit counts for a given page ID. You have to iterate through the whole list of page IDs to do it.</p>

<pre><code>foreach my $idx (0..$#page_ids) {
    if( $page_ids[$idx] eq $our_page_id ) {
        print &quot;Hits for $our_page_id today: $hits{today}[$idx]\n&quot;;
        last;
    }
}
</code></pre>

<p>Cumbersome. A much better layout would be a hash keyed on the page ID.</p>

<pre><code>$hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();
</code></pre>

<p>Now we can directly access the data for a given page ID. If necessary, we can still list the hits in the same order they were read in by iterating through <code>@page_ids</code>.</p>

<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($page_id=&lt;INPUT&gt;){
    $idx++;
    chomp($page_id);
    $page_ids[$idx] = $page_id;

    $hits_upto_sth-&gt;execute($page_id, $start_date);
    $hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $today);
    $hits{today}{$page_id} = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $yesterday);
    $hits{yesterday}{$page_id} = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_id, $start_of_30_days,
                                       $end_of_30_days,);
    $hits{monthly}{$page_id} = $hits_range_sth-&gt;fetchrow_array();
}
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="eliminate-unnecessary-variables">Eliminate Unnecessary Variables</h3>

<p>Now that <code>%hits</code> is no longer ordered by how it was read in, <code>$idx</code> isn&rsquo;t used much anymore. It&rsquo;s only used to stick <code>$page_id</code> onto the end of <code>@page_ids</code>, but we can do that with <code>push</code>.</p>

<p>This is minor but little things build up to cause big messes.</p>

<pre><code>my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($page_id=&lt;INPUT&gt;){
    chomp($page_id);
    push @page_ids, $page_id;

    $hits_upto_sth-&gt;execute($page_id, $start_date);
    $hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $today);
    $hits{today}{$page_id} = $hits_daily_sth-&gt;fetchrow_array();

    $hits_daily_sth-&gt;execute($page_id, $yesterday);
    $hits{yesterday}{$page_id} = $hits_daily_sth-&gt;fetchrow_array();

    $hits_range_sth-&gt;execute($page_id, $start_of_30_days,
                                       $end_of_30_days,);
    $hits{monthly}{$page_id} = $hits_range_sth-&gt;fetchrow_array();
}
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="pull-logical-chunks-out-into-functions">Pull Logical Chunks Out into Functions</h3>

<p>Our final refactoring is one of the most common and most useful.</p>

<p>Let&rsquo;s assume that we need to generate page counts somewhere else in the code. Rather than repeat the code to do this, we want to put it in a subroutine so it can be reused. One subroutine for each statement.</p>

<p>In order to do this, start by identifying the code that would go into the routine.</p>

<pre><code>$hits_upto_sth-&gt;execute($page_id, $start_date);
$hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();
</code></pre>

<p>Then wrap a subroutine around it.</p>

<pre><code>sub hits_upto {
    $hits_upto_sth-&gt;execute($page_id, $start_date);
    $hits{upto}{$page_id} = $hits_upto_sth-&gt;fetchrow_array();
}
</code></pre>

<p>Now look at all the variables used.</p>

<p><code>$hits_upto_sth</code> is a global (well, file-scoped lexical) and is defined entirely outside the function. We can keep using it in our subroutine in the same way we are now.</p>

<p><code>$hits{upto}{$page_id}</code> is receiving the result of the calculation. It contains the return value. So it goes outside the function to receive the return value. Where its assignment was, we put a <code>return</code>.</p>

<pre><code>sub hits_upto {
    $hits_upto_sth-&gt;execute($page_id, $start_date);
    return $hits_upto_sth-&gt;fetchrow_array();
}
</code></pre>

<p><code>$page_id</code> and <code>$start_date</code> vary from call to call. These are our function arguments.</p>

<pre><code>sub hits_upto {
    my($page_id, $start_date) = @_;
    $hits_upto_sth-&gt;execute($page_id, $start_date);
    return $hits_upto_sth-&gt;fetchrow_array();
}
</code></pre>

<p>Finally, rename things in a more generic manner. This is a subroutine for calculating the number of hits up to a certain date. Instead of <code>$start_date</code> which was specific to one calculation, we&rsquo;d call it <code>$date</code>.</p>

<pre><code>sub hits_upto {
    my($page_id, $date) = @_;
    $hits_upto_sth-&gt;execute($page_id, $date);
    return $hits_upto_sth-&gt;fetchrow_array();
}
</code></pre>

<p>And that&rsquo;s our new subroutine, does the same thing as the original code. Then it&rsquo;s a simple matter to use it in the code.</p>

<pre><code>    $hits{upto}{$page_id} = hits_upto($page_id, $start_date);


my $hits_upto_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*)
FROM   lognew 
WHERE  pageid =  ? AND 
       data   &gt;= ?
SQL

my $hits_daily_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid = ? AND 
       data   = ?
SQL

my $hits_range_sth = $dbh-&gt;prepare(&lt;&lt;'SQL');
SELECT count(*) 
FROM   lognew 
WHERE  pageid =  ? AND
       data   &gt;= ? AND
       data   &lt;= ? 
SQL

open (INPUT, &quot;&lt; $filepageid&quot;) || &amp;file_open_error(&quot;$filepageid&quot;);

while ($page_id=&lt;INPUT&gt;){
    chomp($page_id);
    push @page_ids, $page_id;

    $hits{upto}{$page_id}      = hits_upto($page_id, $start_date);
    $hits{today}{$page_id}     = hits_daily($page_id, $today);
    $hits{yesterday}{$page_id} = hits_daily($page_id, $yesterday);
    $hits{monthly}{$page_id}   = hits_range($page_id, $start_of_30_days,
                                                        $end_of_30_days,);
}

sub hits_upto {
    my($page_id, $date) = @_;
    $hits_upto_sth-&gt;execute($page_id, $date);
    return scalar $hits_upto_sth-&gt;fetchrow_array();
}

sub hits_daily {
    my($page_id, $date) = @_;
    $hits_daily_sth-&gt;execute($page_id, $date);
    return scalar $hits_daily_sth-&gt;fetchrow_array();
}

sub hits_range {
    my($page_id, $start, $end) = @_;
    $hits_range_sth-&gt;execute($page_id, $start, $end);
    return scalar $hits_range_sth-&gt;fetchrow_array();
}
</code></pre>

<p>Test. Log. Check in.</p>

<h3 id="undo">Undo.</h3>

<p>Some may balk at putting that small of a snippet of code into a subroutine like that. There are definite performance concerns about adding four subroutine calls to a loop. But I&rsquo;m not worried about that at all.</p>

<p>One of the beauties of Refactoring is that it&rsquo;s reversible. Refactorings don&rsquo;t change how the program works. We can reverse any of these refactorings and the code will work exactly the same. If a refactoring turns out to be a bad idea, undo it. Logging each refactoring in version control makes the job even easier.</p>

<p>So if it turns out moving the executes into their own functions causes a performance problem the change can easily be undone.</p>

<h3 id="done">Done?</h3>

<p>At this point, things are looking pretty nice. The code is well structured, readable, and efficient. The variables are sensibly named. The data is organized in a fairly flexible manner.</p>

<p>It&rsquo;s good enough. This is not to say that there&rsquo;s not more that could be done, but we don&rsquo;t need to. And Refactoring is about doing as much redesign as you need instead of what you might need.</p>

<h3 id="refactoring-and-the-swiss-army-knife">Refactoring and the Swiss Army Knife</h3>

<p>As programmers we have a tendency towards over-design. We like to design our code to deal with any possible situation that might arise, since it was hard to change the design later. This is known as Big Design Up Front (BDUF). It&rsquo;s like one of those <a href="http://www.victorinox.com/newsite/en/produkte/neu/inhalt2.cfm?pid=1-6795-XLT">enormous Swiss Army Knives with 50 functions</a>. Most of the time all you need is <a href="http://www.victorinox.com/newsite/en/produkte/neu/inhalt2.cfm?pid=2-2363">a knife with something to open your beer with and then maybe pick your teeth afterwards</a> but you never know. So you over-engineer because it&rsquo;s hard to improve it later. If it never gets used then a lot of effort has been wasted.</p>

<p>Refactoring turns design on its ear. Now you can continually evolve your design as needed. There&rsquo;s no longer a need to write for every possible situation up front so you can focus on just what you need right now. If you need more flexibility later, you can add that flexibility through refactoring. It&rsquo;s like having a Swiss Army knife that you can add tools to as you need them.</p>

<h3 id="further-reference">Further Reference</h3>

<ul>
<li><a href="http://groups.google.com/groups?th=11b4e3caaafb9849&amp;seekm=20021005063711.GE15102%40ool-18b93024.dyn.optonline.net#link1">The original thread on Fun With Perl</a></li>
<li>The <a href="http://www.c2.com/cgi/wiki?WelcomeVisitors">Portland Pattern Repository</a> answers the question &ndash; <a href="http://www.c2.com/cgi/wiki?WhatIsRefactoring">WhatIsRefactoring?</a></li>
<li><a href="http://www.amazon.com/exec/obidos/tg/detail/-/0201485672">The Refactoring Book</a> by <a href="http://www.martinfowler.com">Martin Fowler</a></li>
</ul>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/development">development</a></div>
                
                  <div class="tag"><a href="/tags/faster">faster</a></div>
                
                  <div class="tag"><a href="/tags/optimization">optimization</a></div>
                
                  <div class="tag"><a href="/tags/perl">perl</a></div>
                
                  <div class="tag"><a href="/tags/refactoring">refactoring</a></div>
                
                  <div class="tag"><a href="/tags/speed">speed</a></div>
                
                  <div class="tag"><a href="/tags/style-guides">style-guides</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-michael-schwern">
  <div class="col-sm-2">
    
    <a href="/authors/michael-schwern/"><div class="circle-avatar" style="background-image:url(/images/author/michael-schwern.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/michael-schwern/"><h3>Michael Schwern</h3></a>
    <p></p>
    <h5><a href="/authors/michael-schwern/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/legacy/_pub_2003_10_09_refactoring.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

