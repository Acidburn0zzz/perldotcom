<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Stopping Spam with SpamAssassin </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content=" I receive a lot of spam; an absolute massive bucket load of spam. I received more than 100 pieces of spam in the first three days of this month. I receive so much spam that Hormel Foods sends trucks..."/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/pub/2002/03/06/spam.html/" />
<meta property="og:title" content="Stopping Spam with SpamAssassin" />
<meta property="og:description" content=" I receive a lot of spam; an absolute massive bucket load of spam. I received more than 100 pieces of spam in the first three days of this month. I receive so much spam that Hormel Foods sends trucks...">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2002-03-03T03:03:03Z" />
<meta property="og:image" content="http://localhost:1313/images/_pub_2002_03_06_spam/111-spam.gif" />
<meta property="og:article:tag" content="spam-vipul-s-spamassassin" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Stopping Spam with SpamAssassin</h1>
              <p class="blog-post-meta">Mar 6, 2002 by
              
              
                
                
                <a href="#author-bio-simon-cozens">Simon Cozens</a>
              
              </p>
              <img alt="" src=""/>
                

<p>I receive a lot of spam; an absolute massive bucket load of spam. I received more than 100 pieces of spam in the first three days of this month. I receive so much spam that <a href="http://www.spam.com/">Hormel Foods</a> sends trucks to take it away. And I&rsquo;m convinced that things are getting worse. We&rsquo;re all being bombarded with junk mail more than ever these days.</p>

<p>Well, a couple of days ago, I reached my breaking point, and decided that the <a href="/pub/2001/07/17/mailfiltering.html">simple mail filtering</a> I had in place up until now just wasn&rsquo;t up to the job. It was time to call in an assassin.</p>

<h3 id="spamassassin">SpamAssassin</h3>

<p><a href="http://www.spamassassin.org">SpamAssassin</a> is a rule-based spam identification tool. It&rsquo;s written in Perl, and there are several ways of using it: You can call a client program, <code>spamassassin</code>, and have it determine whether a given message is likely to be spam; you can do essentially the same thing but use a client/server approach so that your client isn&rsquo;t always loading and parsing the rules each time mail comes; or, finally, you can use a Perl module interface to filter spam from a Perl program.</p>

<p>SpamAssassin is extremely configurable; you can select which rules you want to use, change the way the rules contribute to a piece of mail&rsquo;s &ldquo;spam score,&rdquo; and add your own rules. We&rsquo;ll look at some of these features later in the article. First, how do we get SpamAssassin installed and start using it?</p>

<p>If you&rsquo;re using Debian Linux or one of the BSDs, then this couldn&rsquo;t be easier: just install the appropriate package using <code>apt</code> or the ports tree respectively. (The BSD port is called <code>p5-Mail-SpamAssassin</code>)</p>

<p>Those less fortunate will have to <a href="http://www.spamassassin.org/released/Mail-SpamAssassin-2.11.tar.gz">download</a> the latest version of SpamAssassin, and install it themselves.</p>

<h3 id="vipul-s-razor">Vipul&rsquo;s Razor</h3>

<p>SpamAssassin uses a variety of ways for testing whether an e-mail is spam, ranging from simple textual checks on the headers or body and detecting missing or misleading headers to network-based checks such as <a href="http://www.orbz.org">relay blackhole lists</a> and an interesting distributed system called <a href="http://razor.sourceforge.net/">Vipul&rsquo;s Razor</a>.</p>

<p>Vipul&rsquo;s Razor takes advantage of the fact that spam is, by its nature, distributed in bulk. Hence, a lot of the spam that you see, I&rsquo;m also going to see at some point. If there were a big clearing-house where you could report spam and I could see if my incoming mail matches what you&rsquo;ve already reported, then I could have a guaranteed way of determining whether a given mail is spam. Vipul&rsquo;s Razor is that clearing-house.</p>

<p>Why is it a Razor? Because it&rsquo;s a collaborative system, its strength is directly derived from the quality of its database, which comes back to the way it&rsquo;s used by the likes of you and me. If end-users report lots of real spam, the Razor gets better; if the database gets &ldquo;poisoned&rdquo; by lots of false or misleading reports, then the efficiency of the whole system drops.</p>

<p>Just like any other spam detection mechanism, Razor isn&rsquo;t perfect. There are two points particularly worth noting. First, while it tries to completely avoid false positives (saying something&rsquo;s spam when it isn&rsquo;t) by requiring that spam be reported, it doesn&rsquo;t do anything about false negatives (saying something&rsquo;s not spam when it is) because it only knows about the mail in its database.</p>

<p>Second, spammers, like all other primitive organisms, are constantly evolving. Vipul&rsquo;s Razor only works for spam that is delivered in bulk without modification. Spam that is &ldquo;personalized&rdquo; by the addition of random spaces, letters or the name of the recipient, will produce a different signature that won&rsquo;t match similar spam messages in the Razor database.</p>

<p>Nevertheless, the Razor is an excellent addition to the spam fighter&rsquo;s arsenal, since when it marks something as spam, you can be almost positive it&rsquo;s correct. And just like SpamAssassin, it&rsquo;s all pure Perl. <code>Mail::Audit</code> has long supported a Razor plugin, but now we can move to calling Razor as part of a more comprehensive mail filtering system based on SpamAssasin and <code>Mail::Audit</code></p>

<p>Installing Vipul&rsquo;s Razor is similar to installing SpamAssassin. Debian and BSD users have packages called &ldquo;razor&rdquo; and &ldquo;razor-clients,&rdquo; respectively; and the rest of the world can download and install from the <a href="http://razor.sourceforge.net">home page</a>. SpamAssassin will detect whether Razor is available and, by default, use it if so.</p>

<h3 id="assassinating-spam-with-mail-audit-the-easy-way">Assassinating Spam With Mail::Audit : The Easy Way</h3>

<p>So this is the part you&rsquo;ve all been waiting for. How do we use these things to trap spam? For those of you who aren&rsquo;t familiar with <code>Mail::Audit</code>, the idea is simple: just like with <code>procmail</code>, you write recipes that determine what happens to your mail. However, in the case of <code>Mail::Audit</code>, you specify the recipe in Perl. For instance, here&rsquo;s a recipe to move all mail sent to <code>perl5-porters@perl.org</code> to another folder:</p>

<pre><code>    use Mail::Audit;
    my $mail = Mail::Audit-&gt;new();
    if ($mail-&gt;from =~ /perl5-porters\@perl.org/) {
        $mail-&gt;accept(&quot;p5p&quot;);
    }
    $mail-&gt;accept();
</code></pre>

<p>For more details on how to construct mail filters with <code>Mail::Audit</code>, see my <a href="/pub/2001/07/17/mailfiltering.html">previous article</a>.
Plugging SpamAssassin into your filters couldn&rsquo;t be simpler. First of all, you absolutely need the latest version of <a href="https://metacpan.org/pod/Mail::Audit">Mail::Audit</a>. Nothing earlier than 2.1 will do! Now write a filter like this:</p>

<pre><code>    use Mail::Audit;
    use Mail::SpamAssassin;
    my $mail = Mail::Audit-&gt;new();

    ... the rest of your rules here ...

    my $spamtest = Mail::SpamAssassin-&gt;new();
    my $status = $spamtest-&gt;check($mail);

    if ($status-&gt;is_spam ()) {
        $status-&gt;rewrite_mail() };
        $mail-&gt;accept(&quot;spam&quot;);
    }
    $mail-&gt;accept();
</code></pre>

<p>As you might be able to guess, the important thing here is the calls to <code>check</code> and <code>is_spam</code>. <code>check</code> produces a &ldquo;status object&rdquo; that we can query and use to manipulate the e-mail. <code>is_spam</code> tells us whether the mail has exceeded the number of &ldquo;spam points&rdquo; required to flag an e-mail as spam.
The <code>rewrite_mail</code> method adds some headers and rewrites the subject line to include the distinctive string &ldquo;*****SPAM******&rdquo;. The additional headers explain why the e-mail was flagged as spam. For instance:</p>

<pre><code>X-Spam-Status: Yes, hits=6.1 required=5.0
tests=SUBJ_HAS_Q_MARK,REPLY_TO_EMPTY,SUBJ_ENDS_IN_Q_MARK version=2.1
</code></pre>

<p>This message had a question mark in the subject, an empty reply-to, and the subject ended in a question mark. The mail wasn&rsquo;t actually spam, but this goes to prove that the technique isn&rsquo;t perfect. Nevertheless, since installing the spam filter, I&rsquo;ve only seen about 10 false positives, and zero false negatives. I&rsquo;m happy enough with this solution.
One important point to remember, however, is where in the course of your filtering you should call SpamAssassin&rsquo;s checks. For instance, you want to do so after your mailing list filtering, because mail sent to mailing lists may have munged headers that might confuse SpamAssassin. However, this means that spam sent to mailing lists might slip through the net. Experiment, and find the best solution for your own e-mail patterns.</p>

<h3 id="assassinating-spam-without-mail-audit">Assassinating Spam Without Mail::Audit</h3>

<p>Of course, there are times when it might not be suitable to use <code>Mail::Audit</code> or you may not want to. Since SpamAssassin is provided as a command line tool as well as a set of Perl modules, it&rsquo;s easy enough to integrate it in whatever mail filtering solution you use.</p>

<p>For instance, here&rsquo;s a procmail recipe that calls out to <code>spamassassin</code> to filter out spam:</p>

<pre><code>:0fw
| spamassassin -P

:0:
* ^X-Spam-Status: Yes
spambox
</code></pre>

<p>For the speed-conscious, you can run the <code>spamd</code> daemon and replace calls to <code>spamassassin</code> with <code>spamc</code>; be aware that this is a TCP/IP daemon that you may want to firewall from the rest of the world.
Another approach is to call <code>spamassassin</code> in your mail transport agent, meaning that spam is filtered out before it even attempts to be delivered to you. There&rsquo;s a Sendmail <a href="http://savannah.gnu.org/projects/spamass-milt/">milter</a> library available that allows you to use SpamAssassin, and similar tricks for Exim and other MTAs are available.</p>

<h3 id="assassinating-spam-with-mail-audit-more-complex-operations">Assassinating Spam With Mail::Audit : More Complex Operations</h3>

<p>The <code>Mail::SpamAssassin</code> module has many other methods you can use to manipulate e-mail. For instance, if you&rsquo;ve identified something as definitely being spam, then you can use</p>

<pre><code>    $spamtest-&gt;report_as_spam($mail);
</code></pre>

<p>to report it to Vipul&rsquo;s Razor. (Take note of this: As we&rsquo;ve mentioned above, the efficiency of the Razor database comes from the fact that e-mails in it are confirmed as spam by a human. Adding false positives to the database would degrade its usefulness for everyone. Only submit mail that you&rsquo;ve confirmed personally.)
If you&rsquo;re finding that mail checking is taking too long because SpamAssassin is having to contact the various network-based blacklists and databases, then you can instruct it to only perform &ldquo;local&rdquo; checking:</p>

<pre><code>    $spamtest = Mail::SpamAssassin-&gt;new({local_tests_only =&gt; 1});
</code></pre>

<p>There is a wealth of other options available. See the <code>Mail::SpamAssassin</code> documentation for more details, and happy assassinating!</p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/email">email</a></div>
                
                  <div class="tag"><a href="/tags/spam-vipul-s-spamassassin">spam-vipul-s-spamassassin</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-simon-cozens">
  <div class="col-sm-2">
    
    <a href="/authors/simon-cozens/"><div class="circle-avatar" style="background-image:url(/images/author/simon-cozens.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/simon-cozens/"><h3>Simon Cozens</h3></a>
    <p></p>
    <h5><a href="/authors/simon-cozens/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/legacy/_pub_2002_03_06_spam.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

