<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Independently Parsing Perl </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content=" A few years into my programming career, I found myself involved in a somewhat unusual web project for an enormous global IT company. Due to some odd platform issues, we could write the intranet half of the project only..."/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/pub/2005/06/09/ppi.html/" />
<meta property="og:title" content="Independently Parsing Perl" />
<meta property="og:description" content=" A few years into my programming career, I found myself involved in a somewhat unusual web project for an enormous global IT company. Due to some odd platform issues, we could write the intranet half of the project only...">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2005-06-06T06:06:06Z" />
<meta property="og:image" content="http://localhost:1313/images/_pub_2005_06_09_ppi/111-ppi.gif" />
<meta property="og:article:tag" content="editors" />
<meta property="og:article:tag" content="parser" />
<meta property="og:article:tag" content="refactoring" />
<meta property="og:article:tag" content="ppi" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Independently Parsing Perl</h1>
              <p class="blog-post-meta">Jun 9, 2005 by
              
              
                
                
                <a href="#author-bio-adam-kennedy">Adam Kennedy</a>
              
              </p>
              <img alt="" src=""/>
                

<p>A few years into my programming career, I found myself involved in a somewhat unusual web project for an enormous global IT company. Due to some odd platform issues, we could write the intranet half of the project <em>only</em> in Perl and the almost-identical public internet half <em>only</em> in Java.</p>

<p>In my efforts to pick up enough Java to help my Perl code interoperate with the code from the Java guys, I stumbled on a relatively new editor with the rather expansive name of JetBrains IntelliJ IDEA.</p>

<p>What a joy! It quite simply made learning Java an absolute pleasure, with comprehensive tab completion, light and simple API docs, easy exploration of the mountain of Java classes, and unobtrusive indicators showing me my mistakes and offering to fix them. In short, it had lots of brains and a fast, clean user interface.</p>

<h3 id="where-is-intelliperl">Where Is IntelliPerl?</h3>

<p>Although I only needed it heavily for a few months, it&rsquo;s been my gold standard ever since, and my definition of what a &ldquo;great&rdquo; editor should be. I install every new Perl editor and IDE I come across in the hope that Perl might one day get an editor half as good as what Java has had for years.</p>

<p>These great editors are spreading. Java is now up to one and a half (Eclipse is nearly great but still seems not quite &ldquo;effortless&rdquo; enough about what it does). Dreamweaver gave HTML people their great editor years ago, and I&rsquo;ve heard that Python may now have something that qualifies.</p>

<p>Interestingly, these great editors seem to share one major thing in common.</p>

<h3 id="how-to-build-a-great-editor">How to Build a Great Editor</h3>

<p>Rather than relying on the language&rsquo;s parser to examine code, great editors seem to implement special parsers of their own. These parsers treat a file less like code and more like a generic document (that just also happens to be code).</p>

<p>It&rsquo;s a key distinction, and one that provides two critical capabilities.</p>

<p>First, it creates a &ldquo;round-trip&rdquo; capability, parsing a file into an internal model and back out again without moving a single white space character out of place. Even if parts of a file are broken or badly formatted, you can still change other parts of the file and save it correctly without it changing anything you don&rsquo;t alter.</p>

<p>Second, it makes the parser extremely safe and error-tolerant. Any code open in an editor is there for a reason&ndash;generally because it isn&rsquo;t finished yet, is broken, or needs changing. A document parser can hit a problem, flag it, stumble for a character or so until it finds something it recognizes, and then continue on.</p>

<p>Parsing as code is an entirely different task, and one often unsuited to these type of faults.</p>

<p>For example, take the following.</p>

<pre><code>print &quot;Hello World!\n&quot;;

}

MyModule-&gt;foobar;
</code></pre>

<p>For an editor using Perl itself to understand this code, it&rsquo;s game over once it hits the naked closing brace, because the code is invalid. Without knowledge of what is below the brace, you lose all of the intelligence that needs the parser: syntax highlighting, module checking, helpful tips, the lot.</p>

<p>It&rsquo;s just simply not a reasonable way to build an editor, where a file can be both unfinished and have dozens of bugs.</p>

<h3 id="building-a-document-parser-for-perl">Building a Document Parser for Perl</h3>

<p>Even without an editor to put it in (yet), a document parser for Perl would be extraordinarily useful for all sorts of tasks. At the time, though, all I really wanted was a really accurate HTML syntax highlighter.</p>

<p>Some time in early 2002, I was bored one afternoon and had a first stab at the problem. The result was pretty predictable, given patterns I&rsquo;ve seen in others trying the same thing. It was A) based on regular expressions, and B) useless for anything even remotely interesting.</p>

<p>Between then and the start of The Perl Foundation grant in December 2004, I&rsquo;ve spent a day or so a month on the problem, rewriting and throwing away code. I&rsquo;ve junked two tokenizers, one lexer, an analysis package, three syntax highlighters, an obfuscation package, a quote engine, and half of the classes in the current object tree.</p>

<p>Now, finally, <a href="https://metacpan.org/pod/PPI">PPI</a> is complete, bar some minor features and testing. It is 100 percent round-trip safe, and it&rsquo;s been stress tested against the 38,000 (non-Acme) modules in CPAN, handling all but 28 of the most broken and bizarre.</p>

<h3 id="what-does-it-do">What Does It Do?</h3>

<p>PPI should be the basis for any task where you need to parse, analyze or manipulate Perl, and it finally provides a platform for doing these tasks to their full potential. This covers a huge range of possible tasks; far too many to cover in any depth here.</p>

<p>For this article, I want to demonstrate how PPI can improve existing tools that currently only do a very basic job, when there is the potential for so much more.</p>

<p>One of these is part of the PAR application-packaging module. When PAR bundles a module into the internal include directory, it tries to reduce the size of the modules by stripping out POD. Of course, what would be better would be to strip out <em>everything</em> that is excess and cut PAR file sizes even more.</p>

<p>This is a form of compression, but given the potential confusion in using something like &ldquo;Compress::Perl&rdquo; as a name, I&rsquo;m picking my own term. I hereby anoint the term &ldquo;Squish&rdquo;. A squished module occupies as little space as possible, having had redundant characters removed. It will be extremely small, although it might look a little &ldquo;squished&rdquo; to look at :)</p>

<h3 id="perl-squish">Perl::Squish</h3>

<p>Rather than showing you the final project, I prefer to show the process of squishing a single module.</p>

<pre><code># Where is File::Spec on our system?
use Class::Inspector;
my $filename = Class::Inspector-&gt;resolved_filename( 'File::Spec' );

# Load File::Spec as a document
use PPI;
my $Document = PPI::Document-&gt;new( $filename );
</code></pre>

<p>Everything you do with PPI starts and finishes with <a href="https://metacpan.org/pod/PPI::Document">PPI::Document</a> objects. If you find yourself using the lexer directly, you are probably doing something wrong.</p>

<p>Where can I start cutting out the fat? For starters, many core modules have an <code>__END__</code> section.</p>

<pre><code># Get the (one and only) __END__ section
my $End = $Document-&gt;find_first( 'Statement::End' );

# Delete it from the document
$End-&gt;delete if $End;
</code></pre>

<p>PPI provides a set of search methods that you can use on any element that has children. <code>find_first</code> is a safe guess, because there can only be one <code>__END__</code> section. The search methods actually take <code>&amp;wanted</code> functions like <a href="https://metacpan.org/pod/File::Find">File::Find</a>, so <code>'Statement::End'</code> is really syntactic sugar for:</p>

<pre><code>sub wanted {
    my ($Document, $Element) = @_;
    $Element-&gt;isa('PPI::Statement::End');
}
</code></pre>

<p>Of course, there&rsquo;s a faster way to do the same thing. The <code>prune</code> method finds and immediately deletes all elements that match a particular condition.</p>

<pre><code># Delete all comments and POD
$Document-&gt;prune( 'Token::Pod' );
$Document-&gt;prune( 'Token::Comment' );
</code></pre>

<p>For a more serious example, here&rsquo;s how to strip the non-compulsory braces from <code>-&gt;method()</code>:</p>

<pre><code># Remove useless braces
$Document-&gt;prune( sub {
    my $Braces = $_[1];
    $Braces-&gt;isa('PPI::Structure::List')      or return '';
    $Braces-&gt;children == 0                    or return '';
    my $Method = $Braces-&gt;sprevious_sibling   or return '';
    $Method-&gt;isa('PPI::Token::Word')          or return '';
    $Method-&gt;content !~ /:/                   or return '';
    my $Operator = $Method-&gt;sprevious_sibling or return '';
    $Operator-&gt;isa('PPI::Token::Operator')    or return '';
    $Operator-&gt;content eq '-&gt;'                or return '';
    return 1;
    } );
</code></pre>

<p>It&rsquo;s a little bit wordy, but is relatively straightforward to write. Just add conditions and discard as you go. You can get other elements, calculate anything or call sub-searches.</p>

<p>When you have finished, be sure to save the file.</p>

<pre><code># Save the file
$Document-&gt;save( &quot;$filename.squish&quot; );
</code></pre>

<h3 id="wrapping-it-all-up">Wrapping It All Up</h3>

<p>All you need to do now is is wrap it all up in some typical module boilerplate.</p>

<pre><code>package Perl::Squish;

use strict;
use PPI;

our $VERSION = '0.01';

# Squish a file in place
# Perl::Squish-&gt;file( $filename )
sub file {
    my ($class, $file) = @_;
    my $Document = PPI::Document-&gt;new( $file ) or return undef;
    $class-&gt;document( $Document ) or return undef;
    $Document-&gt;save( $file );
}

# Squish a document object
# Perl::Squish-&gt;document( $Document );
sub document {
    my ($squish, $Document) = @_;

    # Remove the stuff we did earlier
    $Document-&gt;prune('Statement::End');
    $Document-&gt;prune('Token::Comment');
    $Document-&gt;prune('Token::Pod');

    $Document-&gt;prune( sub {
        my $Braces = $_[1];
        $Braces-&gt;isa('PPI::Structure::List')      or return '';
        $Braces-&gt;elements == 0                    or return '';
        my $Method = $Braces-&gt;sprevious_sibling   or return '';
        $Method-&gt;isa('PPI::Token::Word')          or return '';
        $Method-&gt;content !~ /:/                   or return '';
        my $Operator = $Method-&gt;sprevious_sibling or return '';
        $Operator-&gt;isa('PPI::Token::Operator')    or return '';
        $Operator-&gt;content eq '-&gt;'                or return '';
        return 1;
        } );

    # Let's also do some whitespace cleanup
    my @whitespace = $Document-&gt;find('Token::Whitespace');
    foreach ( @whitespace ) {
        $_-&gt;{content} = $_-&gt;{content} =~ /\n/ ? &quot;\n&quot; : &quot; &quot;;
    }

    1;
}

1;
</code></pre>

<p>Finally, the last step is to wrap it all up as a proper module. You can see the finished product prettied up with PPI&rsquo;s syntax highlighter at <a href="http://ali.as/CPAN/Squish.html">CPAN::Squish</a>. I&rsquo;ve added a few additional small features to the basic code described above, but you get the idea. See also <a href="https://metacpan.org/pod/Perl::Squish">Perl::Squish</a> for more details.</p>

<p>In 15 minutes, I&rsquo;ve knocked together a pretty simple module that dramatically improves on what you could do <em>without</em> something like PPI. Now imagine the hard things it makes possible.</p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/tooling">tooling</a></div>
                
                  <div class="tag"><a href="/tags/editors">editors</a></div>
                
                  <div class="tag"><a href="/tags/parser">parser</a></div>
                
                  <div class="tag"><a href="/tags/refactoring">refactoring</a></div>
                
                  <div class="tag"><a href="/tags/ppi">ppi</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-adam-kennedy">
  <div class="col-sm-2">
    
    <a href="/authors/adam-kennedy/"><div class="circle-avatar" style="background-image:url(/images/author/adam-kennedy.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/adam-kennedy/"><h3>Adam Kennedy</h3></a>
    <p></p>
    <h5><a href="/authors/adam-kennedy/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/legacy/_pub_2005_06_09_ppi.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

