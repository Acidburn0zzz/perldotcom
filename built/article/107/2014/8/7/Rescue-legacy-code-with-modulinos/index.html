<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Rescue legacy code with modulinos </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="How the modules-as-programs pattern provides a development path for scripts"/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/article/107/2014/8/7/Rescue-legacy-code-with-modulinos/" />
<meta property="og:title" content="Rescue legacy code with modulinos" />
<meta property="og:description" content="How the modules-as-programs pattern provides a development path for scripts">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2014-08-08T08:08:08Z" />
<meta property="og:image" content="http://localhost:1313/images/107/thumb_A5A75EBE-1DCE-11E4-98FE-791D03099C34.png" />
<meta property="og:article:tag" content="module" />
<meta property="og:article:tag" content="package" />
<meta property="og:article:tag" content="modulino" />
<meta property="og:article:tag" content="caller" />
<meta property="og:article:tag" content="main" />
<meta property="og:article:tag" content="test_more" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Rescue legacy code with modulinos</h1>
              <p class="blog-post-meta">Aug 7, 2014 by
              
              
                
                
                <a href="#author-bio-brian-d-foy">brian d foy</a>
              
              </p>
              <img alt="" src="/images/107/A5A75EBE-1DCE-11E4-98FE-791D03099C34.png"/>
                

<p>As businesses grow, they move into situations they didn&rsquo;t anticipate and often have problems other businesses would love to have. Under rapid growth their codebase struggles to keep up. I&rsquo;ve seen more bad code making money than I&rsquo;ve seen good code making money, and it&rsquo;s an exciting situation to fix. Modulinos have been a nice trick for me to move standalone programs toward a testable and manageable CPAN-like distribution.</p>

<p>Modulinos isn&rsquo;t an idea that I invented, but it&rsquo;s something I popularized. I first got the idea from a talk by <a href="http://blog.plover.com">Mark Jason Dominus</a> and the <a href="https://github.com/Perl/perl5/blob/blead/lib/diagnostics.pm">diagnostics</a> module, written by Tom Christiansen way back in 1995. In this article I&rsquo;ll talk a little about the trick, but more about why and how I&rsquo;ve used it.</p>

<p>The trick involves using <a href="https://perldoc.perl.org/functions/caller.html">caller</a> to decide how a Perl file should act depending on how it&rsquo;s loaded. When run from the command line, it acts like a program, but when loaded as a module, it doesn&rsquo;t run anything while still making its subroutines and packages available. In the second edition of <a href="http://www.masteringperl.org/">Mastering Perl</a>, I expanded this a bit to check for the presence of a test harness so it could run methods that start with <code>test_</code>, a Python feature I&rsquo;ve liked.</p>

<p>You can see the basic structure in <a href="https://metacpan.org/pod/Modulino::Test">Modulino::Test</a>, part of the <a href="https://metacpan.org/release/Modulino-Demo">Modulino::Demo</a> distribution:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">package</span> Modulino::Test;
<span style="color:#66d9ef">use</span> utf8;
<span style="color:#66d9ef">use</span> strict;
<span style="color:#66d9ef">use</span> warnings;

<span style="color:#66d9ef">use</span> v5<span style="color:#ae81ff">.10</span>;

<span style="color:#66d9ef">our</span> $VERSION <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0.10_01&#39;</span>;

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">_running_under_tester</span> { <span style="color:#f92672">!!</span> $ENV{CPANTEST} }

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">_running_as_app</span> { <span style="color:#f92672">!</span> defined scalar caller(<span style="color:#ae81ff">1</span>) }

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">_loaded_as_module</span> { defined scalar caller(<span style="color:#ae81ff">1</span>); }

<span style="color:#66d9ef">my</span> $method <span style="color:#f92672">=</span> <span style="color:#66d9ef">do</span> {
        <span style="color:#66d9ef">if</span>( _running_under_tester()   ) { <span style="color:#e6db74">&#39;test&#39;</span> }
    <span style="color:#66d9ef">elsif</span>( _loaded_as_module()       ) { undef  }
    <span style="color:#66d9ef">elsif</span>( _running_as_app()            ) { <span style="color:#e6db74">&#39;run&#39;</span>  }
    <span style="color:#66d9ef">else</span>                                { undef }
    };

__PACKAGE__<span style="color:#f92672">-&gt;</span>$method(@ARGV) <span style="color:#66d9ef">if</span> defined $method;

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">test</span> { <span style="color:#f92672">...</span> }
<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">run</span>  { <span style="color:#f92672">...</span> }</code></pre></div>
<p>I originally wrote about modulinos in <a href="http://www.perlmonks.org/index.pl?node_id=396759">How a script becomes a module</a> on Perlmonks, and that&rsquo;s where I first used the term. I might have even invented in while creating that post. I expanded it a little bit for <a href="http://www.drdobbs.com/scripts-as-modules/184416165">Scripts as Modules</a> for <em>The Perl Journal</em> (now swallowed as <em>Dr. Dobbs Journal</em>).</p>

<p>At the time, I was doing quite a bit of work to translate legacy codebases into something more manageable. Instead of rewriting everything, I created paths to better behavior with immediate results. Part of this path is testing the existing codebase so I could recreate it, bugs and rough edges included, in the next part. Moving standalone scripts to libraries or modules is a big part of that; I have to maintain the program behavior, but I want to unit test its innards.</p>

<p>I have quite a bit of fun organizing a messy and (previously) unmanaged codebase. A little work makes a big difference and gives quick gains. From there it&rsquo;s an easy path toward adding tests. It&rsquo;s part of my motivation for <a href="https://metacpan.org/pod/App::scriptdist">scriptdist</a>, which I wrote about in <a href="http://www.drdobbs.com/web-development/automating-distributions-with-scriptdist/184416112">Automating Distributions with scriptdist</a>. Given a stand-alone program, I used that tool to build a distribution around it and include the test files. The program file stays the same, but once wrapped in the distribution goodness, I can start the transformation. Even if this code will never make it to CPAN, I can still use all the CPAN tools by making it look like a CPAN distribution.</p>

<h3 id="converting-a-script-to-a-modulino">Converting a script to a modulino</h3>

<p>Suppose I start with a script. Here&rsquo;s a short one:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/perl</span>

<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Hello World!\n&#34;</span>;</code></pre></div>
<p>Even this simple program has problems (we never have trouble finding faults with programs; it&rsquo;s almost bloodsport in some parts!). I can&rsquo;t change where the output goes and it&rsquo;s hard-coded to use English.</p>

<p>My first step is to make this a program that behaves the same but has a different structure. Larry designed Perl to do away with the <code>main</code> subroutine required by many other languages, but I bring it back:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/perl</span>

__PACKAGE__<span style="color:#f92672">-&gt;</span>run();

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">run</span> {
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Hello World!\n&#34;</span>;
    }</code></pre></div>
<p>The <code>__PACKAGE__</code> token is a compiler directive that refers to the current package. It calls the <code>run</code> subroutine, which operates the same as it introduces a new scope. Some black magic and weird idioms might break, but, for the most part, this should (a dangerous word!) run the same. At this point, I&rsquo;m probably also introducing this legacy codebase to source control, so a small change with no new behavior makes for a good first patch to a new branch.</p>

<p>This program is now mostly a module and it has the distribution structure that allows me to test it. I can start to create acceptance tests (end-to-end, or some other label even) since I haven&rsquo;t had a way to reach into the code itself. These form the basis of the regression tests I can use to check the new code against the original code.</p>

<p>When I&rsquo;m satisfied that the new code works, I can make more changes. This is where the modulino idea comes in. I want to test the code without automatically executing the code in <code>run</code>. I can use the <code>caller</code> trick; I don&rsquo;t execute the code if there&rsquo;s a higher level in the call stack (a program would be at the top):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/perl</span>

__PACKAGE__<span style="color:#f92672">-&gt;</span>run() <span style="color:#66d9ef">unless</span> caller;

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">run</span> {
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Hello World!\n&#34;</span>;
    }</code></pre></div>
<p>That&rsquo;s another small change in the actual code, but a significant change in behavior. I can get to the code in a test program:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> Test::More;

subtest <span style="color:#e6db74">&#39;load program&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> {
    require_ok( <span style="color:#e6db74">&#39;scripts/program.pl&#39;</span> );
    };

subtest <span style="color:#e6db74">&#39;test innards&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> {
    ok( defined <span style="color:#f92672">&amp;</span>run, <span style="color:#e6db74">&#39;Run subroutine is defined&#39;</span> );
    };

done_testing();</code></pre></div>
<p>From there the path forward is more clear. I can add a package statement to the program and start to refactor the <code>run</code>, using the test best practices I know. Soon the development morphs into module maintenance and its history as a standalone program doesn&rsquo;t matter anymore. As I go through the process, I&rsquo;ve also set the eventual maintainers on the right path.</p>

<p><em>Cover image <a href="https://creativecommons.org/licenses/by/4.0/">©</a> <a href="https://www.flickr.com/photos/deia/321829326/in/photolist-ursDu-71wk9y-nYpsHQ-e3P2i9-e1TW4-32LHXt-e4bYT8-e4bYNV-e4hB2m-e4hB5Y-69pxDc-7YWXJX-cwAfvs-e1TUY-4zkBG7-dcyLpA-aj8HAk-ajbu5L-ajbuh7-94j7Df-94jsgo-d9QS9u-dcyJAE-dcyHcT-bavZfB-2nPfVE-52nPvi-RBuWd-4tpcsD-55P2hs-4WaC4T-7w6TC-9FUUPM-94jwv1-8ohTWP-94g9Ep-6ijaiB-94jpgQ-94jcQd-94gcw8-94jveU-94jy93-94g6v8-94j9nu-94jmud-dh1bAe-dcyJoM-dcyJNK-duC43R-dcyK6z">Andréia Bohner</a>, the image has been digitally altered.</em></p>

<p><br />
<em>This article was originally posted on <a href="http://perltricks.com">PerlTricks.com</a>.</em></p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/development">development</a></div>
                
                  <div class="tag"><a href="/tags/module">module</a></div>
                
                  <div class="tag"><a href="/tags/package">package</a></div>
                
                  <div class="tag"><a href="/tags/modulino">modulino</a></div>
                
                  <div class="tag"><a href="/tags/caller">caller</a></div>
                
                  <div class="tag"><a href="/tags/main">main</a></div>
                
                  <div class="tag"><a href="/tags/test_more">test_more</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-brian-d-foy">
  <div class="col-sm-2">
    
    <a href="/authors/brian-d-foy/"><div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/brian-d-foy/"><h3>brian d foy</h3></a>
    <p><a href="http://www.pair.com/~comdog/">brian d foy</a> is a Perl trainer and writer, and a senior editor at Perl.com. He&rsquo;s the author of <a href="https://www.masteringperl.org">Mastering Perl</a>, <a href="https://leanpub.com/mojo_web_clients">Mojolicious Web Clients</a>, <a href="https://leanpub.com/learning_perl_exercises">Learning Perl Exercises</a>, and co-author of <a href="https://www.programmingperl.org">Programming Perl</a>, <a href="https://www.learning-perl.com">Learning Perl</a>, <a href="https://www.intermediateperl.com">Intermediate Perl</a> and <a href="https://www.effectiveperlprogramming.com">Effective Perl Programming</a>.</p>
    <h5><a href="/authors/brian-d-foy/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/article/rescue-legacy-code-with-modulinos.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

