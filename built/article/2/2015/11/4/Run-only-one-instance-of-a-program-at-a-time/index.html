<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Run only one instance of a program at a time </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Lockfiles can provide race condition-free solutions"/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/article/2/2015/11/4/Run-only-one-instance-of-a-program-at-a-time/" />
<meta property="og:title" content="Run only one instance of a program at a time" />
<meta property="og:description" content="Lockfiles can provide race condition-free solutions">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2015-11-11T11:11:11Z" />
<meta property="og:image" content="http://localhost:1313/images/author/david-farrell.jpg" />
<meta property="og:article:tag" content="lockfile" />
<meta property="og:article:tag" content="process" />
<meta property="og:article:tag" content="race_condition" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Run only one instance of a program at a time</h1>
              <p class="blog-post-meta">Nov 4, 2015 by
              
              
                
                
                <a href="#author-bio-david-farrell">David Farrell</a>
              
              </p>
              <img alt="" src=""/>
                

<p>Recently I wanted to schedule a Perl app to run every minute on a server, but if an instance of the app was already running, it should exit and do nothing. This is a common problem and I was able to solve it with a lockfile. Let&rsquo;s see how to use lockfiles in Perl.</p>

<h3 id="lockfiles-you-say">Lockfiles you say?</h3>

<p>Most operating systems support file locking - it&rsquo;s an essential tool to prevent multiple processes updating a file at the same time and causing data loss. Processes obtain file locks when they are accessing a file to prevent other processes changing them, and release the file lock when they&rsquo;re done, freeing the file to be used by other processes again.</p>

<p>Programs can use the lock file principle to prevent multiple instances of themselves running at the same time. When the program starts it tries to lock the lockfile, if successful it executes the program, else it exits. When the program process ends, any locks it obtained are removed by the OS. You may have seen lockfiles before, they are usually ordinary files with a <code>.lock</code> extension.</p>

<h3 id="file-locking-in-perl">File locking in Perl</h3>

<p>Perl provides the <a href="https://perldoc.perl.org/functions/flock.html">flock</a> function for file locking. It takes a filehandle and a constant value for the lock type. So to get an exclusive lock on a file, I could do:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">open <span style="color:#66d9ef">my</span> $file, <span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#34;app.lock&#34;</span> <span style="color:#f92672">or</span> die $!;
flock $file, <span style="color:#ae81ff">2</span> <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Unable to lock file $!&#34;</span>;
<span style="color:#75715e"># we have the lock</span></code></pre></div>
<p>This code starts by opening a write filehandle to the file <code>app.lock</code>. If successful, it attempts to get an exclusive lock on the file by calling flock with the number 2. An exclusive lock means no other process can access the file whilst the lock is active. Remembering the constant values for lock types can be a pain, so helpfully the <a href="https://metacpan.org/pod/Fcntl">Fcntl</a> module will export constant names if you ask nicely. I&rsquo;ll update the code to do that:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> Fcntl <span style="color:#e6db74">qw(:flock)</span>;
open <span style="color:#66d9ef">my</span> $file, <span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#34;app.lock&#34;</span> <span style="color:#f92672">or</span> die $!;
flock $file, LOCK_EX <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Unable to lock file $!&#34;</span>;
<span style="color:#75715e"># we have the lock</span></code></pre></div>
<p>This code does the same thing as before but we don&rsquo;t need to remember the constant value for the lock type (LOCK_EX == exclusive lock). Note there is no need to unlock the file - when the program exits, the lock will be removed automatically.</p>

<h3 id="non-blocking-flock">Non-blocking flock</h3>

<p>So far so good but we have a problem. If the file is locked, <code>flock</code> will block and keep our program waiting around until the lock is removed. I want is the program to exit immediately if it can&rsquo;t obtain the lock. The only way to check if a file is locked is with <code>flock</code> though! Fortunately the <code>flock</code> developers had considered this issue, and I can pass an extra argument to indicate I want a non-blocking lock.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> Fcntl <span style="color:#e6db74">qw(:flock)</span>;
open <span style="color:#66d9ef">my</span> $file, <span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#34;app.lock&#34;</span> <span style="color:#f92672">or</span> die $!;
flock $file, LOCK_EX<span style="color:#f92672">|</span>LOCK_NB <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Unable to lock file $!&#34;</span>;
<span style="color:#75715e"># we have the lock</span></code></pre></div>
<p>I&rsquo;ve added <code>|LOCK_NB</code> to the flock arguments and now it will return false immediately if it cannot obtain an exclusive lock.This provides the non-blocking behavior I need.</p>

<h3 id="testing-it-out">Testing it out</h3>

<p>I&rsquo;m going to put this locking code into a quick script so I can test the lock functionality:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/env perl</span>
<span style="color:#66d9ef">use</span> Fcntl <span style="color:#e6db74">qw(:flock)</span>;
open <span style="color:#66d9ef">my</span> $file, <span style="color:#e6db74">&#34;&gt;&#34;</span>, <span style="color:#e6db74">&#34;app.lock&#34;</span> <span style="color:#f92672">or</span> die $!;
flock $file, LOCK_EX<span style="color:#f92672">|</span>LOCK_NB <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Unable to lock file: $!&#34;</span>;

sleep(<span style="color:#ae81ff">60</span>);</code></pre></div>
<p>I&rsquo;ll save the script as <code>sleep60.pl</code> and test it at the terminal:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">$ chmod <span style="color:#ae81ff">700</span> sleep60<span style="color:#f92672">.</span>pl
$ <span style="color:#960050;background-color:#1e0010">./</span>sleep60<span style="color:#f92672">.</span>pl<span style="color:#f92672">&amp;</span>
[<span style="color:#ae81ff">2</span>] <span style="color:#ae81ff">21505</span>
$ <span style="color:#960050;background-color:#1e0010">./</span>sleep60<span style="color:#f92672">.</span>pl
Unable to lock file Resource temporarily unavailable at <span style="color:#f92672">./</span>sleep60<span style="color:#f92672">.</span>pl line <span style="color:#ae81ff">4</span><span style="color:#f92672">.</span></code></pre></div>
<p>Looking good! I tried to run the script twice and the second time, the system printed the expected error message and exited.</p>

<h3 id="avoiding-external-files">Avoiding external files</h3>

<p>Using an external file feels kind-of-dirty. What I&rsquo;d really like to do is tidy up by deleting the lockfile once the program has finished. However unlocking and deleting the file involves extra steps which may introduce a <a href="https://en.wikipedia.org/wiki/Race_condition">race condition</a>. Instead of deleting the file, what if we never created it? One way to do this is to use the <a href="http://perltricks.com/article/24/2013/5/11/Perl-tokens-you-should-know">__DATA__</a> filehandle, like so:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/env perl</span>
<span style="color:#66d9ef">use</span> Fcntl <span style="color:#e6db74">qw(:flock)</span>;
flock DATA, LOCK_EX<span style="color:#f92672">|</span>LOCK_NB <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Unable to lock file $!&#34;</span>;

sleep(<span style="color:#ae81ff">60</span>);
__DATA__</code></pre></div>
<p>This version of the script opens a lock on the <code>DATA</code> filehandle and creates no external files. Mark Jason Dominus <a href="http://perl.plover.com/yak/flock/samples/slide006.html">showed</a> this ingenious trick years ago. Another trick Mark showed was to open the lockfile on the program file itself:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/env perl</span>
<span style="color:#66d9ef">use</span> Fcntl <span style="color:#e6db74">qw(:flock)</span>;
open <span style="color:#66d9ef">our</span> $file, <span style="color:#e6db74">&#39;&lt;&#39;</span>, $0 <span style="color:#f92672">or</span> die $!;
flock $file, LOCK_EX<span style="color:#f92672">|</span>LOCK_NB <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Unable to lock file $!&#34;</span>;

sleep(<span style="color:#ae81ff">60</span>);</code></pre></div>
<p>This frees up <code>DATA</code> and has the added benefit that the code can be exported by a module (by using <code>our</code> instead of <code>my</code>). Note that the <code>open</code> arguments have been changed to use a read-only filehandle to avoid truncating the source code of the program! If you need this behavior, you can implement it yourself as shown above, or use my module <a href="https://metacpan.org/pod/IPC::Lockfile">IPC::Lockfile</a>, which will do it for you. If you need more refined lockfile functionality, have a look at <a href="https://metacpan.org/pod/Sys::RunAlone">Sys::RunAlone</a> which uses the same trick (thanks to <a href="https://metacpan.org/author/BOOK">BooK</a> for the reference). There are also plenty of other options on <a href="https://metacpan.org/search?size=20&amp;q=lockfile&amp;search_type=modules">CPAN</a>.</p>

<p><strong>Update:</strong> <em>added Sys::RunAlone reference - 2015-11-28.</em></p>

<p><br />
<em>This article was originally posted on <a href="http://perltricks.com">PerlTricks.com</a>.</em></p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/apps">apps</a></div>
                
                  <div class="tag"><a href="/tags/lockfile">lockfile</a></div>
                
                  <div class="tag"><a href="/tags/process">process</a></div>
                
                  <div class="tag"><a href="/tags/race_condition">race_condition</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-david-farrell">
  <div class="col-sm-2">
    
    <a href="/authors/david-farrell/"><div class="circle-avatar" style="background-image:url(/images/author/david-farrell.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/david-farrell/"><h3>David Farrell</h3></a>
    <p>David is the editor of Perl.com. An organizer of the <a href="http://www.meetup.com/The-New-York-Perl-Meetup-Group/">New York Perl Meetup</a>, he works for ZipRecruiter as a software developer, and sometimes <a href="https://twitter.com/perltricks">tweets</a> about Perl and Open Source.</p>
    <h5><a href="/authors/david-farrell/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/article/run-only-one-instance-of-a-program-at-a-time.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

