<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Port scanning with Perl, Part II </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Towards building a professional tool"/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/article/188/2015/8/15/Port-scanning-with-Perl--Part-II/" />
<meta property="og:title" content="Port scanning with Perl, Part II" />
<meta property="og:description" content="Towards building a professional tool">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2015-08-08T08:08:08Z" />
<meta property="og:image" content="http://localhost:1313/images/188/thumb_2714AD7A-2EE1-11E5-B064-7C659059EE40.jpeg" />
<meta property="og:article:tag" content="tcp" />
<meta property="og:article:tag" content="icmp" />
<meta property="og:article:tag" content="udp" />
<meta property="og:article:tag" content="nmap" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Port scanning with Perl, Part II</h1>
              <p class="blog-post-meta">Aug 15, 2015 by
              
              
                
                
                <a href="#author-bio-david-farrell">David Farrell</a>
              
              </p>
              <img alt="" src="/images/188/2714AD7A-2EE1-11E5-B064-7C659059EE40.jpeg"/>
                

<p>In <a href="http://perltricks.com/article/183/2015/7/20/Port-scanning-with-Perl">part I</a> of this article, I showed how to develop a basic forking <a href="https://gist.github.com/dnmfarrell/3db321fc11b0d85f729d">port scanner</a> with Perl. In this article, I&rsquo;ll add some enhancements to make this a truly useful tool.</p>

<h3 id="scan-a-range-of-ports">Scan a range of ports</h3>

<p>The first feature I want to add is the ability to scan user-defined port ranges, instead of the default list of named ports. Because I&rsquo;m using <a href="https://metacpan.org/pod/Getopt::Long">Getopt::Long</a> to parse command line arguments, I can add <code>range</code> to the parameter options:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">GetOptions (
  <span style="color:#e6db74">&#39;ip=s&#39;</span>        <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span> <span style="color:#66d9ef">my</span> $target_ip,
  <span style="color:#e6db74">&#39;range=s&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span> <span style="color:#66d9ef">my</span> $port_range,
  <span style="color:#e6db74">&#39;h|help|?&#39;</span>    <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> { pod2usage(<span style="color:#ae81ff">2</span>) },
);</code></pre></div>
<p>The port processing <a href="https://gist.github.com/dnmfarrell/3db321fc11b0d85f729d#file-port_scanner-L53-L57">code</a> becomes:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e"># use named ports if no range was provided</span>
<span style="color:#66d9ef">my</span> @ports <span style="color:#f92672">=</span> shuffle <span style="color:#66d9ef">do</span> {
  <span style="color:#66d9ef">unless</span> ($port_range)
  {
    map { $port_directory{$_}<span style="color:#f92672">-&gt;</span>{port} }
      grep { $port_directory{$_}<span style="color:#f92672">-&gt;</span>{name} <span style="color:#f92672">!~</span> <span style="color:#e6db74">/^unknown$/</span>
             <span style="color:#f92672">&amp;&amp;</span> $port_directory{$_}<span style="color:#f92672">-&gt;</span>{proto} <span style="color:#f92672">eq</span> $protocol } keys %port_directory;
  }
  <span style="color:#66d9ef">else</span>
  {
    <span style="color:#66d9ef">my</span> ($min, $max) <span style="color:#f92672">=</span> $port_range <span style="color:#f92672">=~</span> <span style="color:#e6db74">/([0-9]+)-([0-9]+)/</span>
      <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;port-range must be formatted like this: 100-1000\n&#34;</span>;
    $min<span style="color:#f92672">..</span>$max;
  }
};</code></pre></div>
<p>I check for the presence of the <code>$port_range</code> variable, and if it&rsquo;s present I try to parse the minimum and maximum ports using a regex capture. I like this code pattern:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> ($min, $max) <span style="color:#f92672">=</span> $port_range <span style="color:#f92672">=~</span> <span style="color:#e6db74">/([0-9]+)-([0-9]+)/</span>
      <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;port-range must be formatted like this: 100-1000\n&#34;</span>;</code></pre></div>
<p>Because either the port range will be successfully parsed into <code>$min</code> and <code>$max</code> or an exception with be thrown. By passing a string ending in a newline to <code>die</code>, it won&rsquo;t print out a line reference, which makes for cleaner &ldquo;usage&rdquo; style messages.</p>

<h3 id="tune-processes-and-frequency">Tune processes and frequency</h3>

<p>The simple <a href="https://gist.github.com/dnmfarrell/3db321fc11b0d85f729d">port scanner</a> initiates 50 processes, divides the ports to be scanned evenly between all processes, with each process sending one request per second. There are a few issues with this. Firstly if the user wants to scan all 65,535 ports the program will run for at least 20 minutes, which is quite slow. Secondly, some hosts have dynamic firewalls which will start dropping packets if they detect a port scan, so the user may want to be stealthy and slow down the scan speed <em>further</em>. Ideally then, we should let the user define how many processes to run and how much to delay between each sent packet.</p>

<p>To capture those arguments, I can add <code>procs</code> and <code>delay</code> to <code>GetOptions</code>:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">GetOptions (
  <span style="color:#e6db74">&#39;delay=f&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>(<span style="color:#66d9ef">my</span> $delay <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
  <span style="color:#e6db74">&#39;ip=s&#39;</span>        <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span> <span style="color:#66d9ef">my</span> $target_ip,
  <span style="color:#e6db74">&#39;range=s&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span> <span style="color:#66d9ef">my</span> $port_range,
  <span style="color:#e6db74">&#39;procs=i&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>(<span style="color:#66d9ef">my</span> $procs <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>),
  <span style="color:#e6db74">&#39;h|help|?&#39;</span>    <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> { pod2usage(<span style="color:#ae81ff">2</span>) },
);</code></pre></div>
<p>This code does a few neat things: by using the <code>=i</code> definition, <code>GetOptions</code> will do integer type checking for the number of processors. Likewise <code>=f</code> will enforce a floating-point number type. The other thing this code does is declare and set a default value for the variables within the <code>GetOptions</code> function.</p>

<p>To support <code>sleep</code> for floating point seconds, I need to import the <a href="https://metacpan.org/pod/Time::HiRes">Time::HiRes</a> module (part of the Perl core):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> Time::HiRes <span style="color:#e6db74">&#39;sleep&#39;</span>;</code></pre></div>
<p>Now the forking <a href="https://gist.github.com/dnmfarrell/3db321fc11b0d85f729d#file-port_scanner-L68-L91">code</a> can become:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">for</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">..</span>$procs)
{
  <span style="color:#66d9ef">my</span> @ports_to_scan <span style="color:#f92672">=</span> splice @ports, <span style="color:#ae81ff">0</span>, $batch_size;
  <span style="color:#66d9ef">my</span> $parent <span style="color:#f92672">=</span> fork;
  die <span style="color:#e6db74">&#34;unable to fork!\n&#34;</span> <span style="color:#66d9ef">unless</span> defined ($parent);

  <span style="color:#66d9ef">if</span> ($parent)
  {
    push(@child_pids, $parent);
    <span style="color:#66d9ef">next</span>;
  }

  <span style="color:#75715e"># child waits until the parent signals to continue</span>
  <span style="color:#66d9ef">my</span> $continue <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
  local $SIG{CONT} <span style="color:#f92672">=</span> <span style="color:#66d9ef">sub</span> { $continue <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>};
  <span style="color:#66d9ef">until</span> ($continue) {}

  <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">my</span> $target_port (@ports_to_scan)
  {
    sleep($delay);
    send_packet($protocol, $target_port, $flags);
  }
  exit <span style="color:#ae81ff">0</span>; <span style="color:#75715e"># exit child</span>
}</code></pre></div>
<p>And the scanner will now fork <code>$procs</code> number of processes, and sleep <code>$delay</code> seconds between each sent packet. This should give users the ability to fine-tune the frequency of packets sent and the run time of the scan.</p>

<h3 id="reporting">Reporting</h3>

<p>The simple scanner prints out every scanned port and the port status. This can be too much information - in most cases the user is interested in vulnerable open ports and doesn&rsquo;t care about filtered or closed ones. On the other hand, the output is missing key information that would be required for a security audit: datetime of execution, program version, parameters used, overall runtime etc. So I need to add this information to the output.</p>

<p>To calculate the program runtime duration, and print the start datetime I can use the <a href="https://metacpan.org/pod/Time::Piece">Time::Piece</a> module. The module is part of core Perl so there is no need to install it, plus you can do <a href="http://perltricks.com/article/59/2014/1/10/Solve-almost-any-datetime-need-with-Time--Piece">almost anything</a> with it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> Time::Piece;

<span style="color:#66d9ef">my</span> $start_time <span style="color:#f92672">=</span> localtime;

<span style="color:#f92672">...</span>

<span style="color:#66d9ef">my</span> $end_time <span style="color:#f92672">=</span> localtime;
<span style="color:#66d9ef">my</span> $duration <span style="color:#f92672">=</span> $end_time <span style="color:#f92672">-</span> $start_time;</code></pre></div>
<p>When you import Time::Piece it overrides the localtime and gmtime built in functions to construct Time::Piece objects. Subtracting the start and end times returns a Time::Seconds object which is our runtime duration. Both object types nicely format when printed, so that&rsquo;s all we need to do here. Simple!</p>

<p>I&rsquo;ll add a <code>verbose</code> option to <code>GetOptions</code>. If this is present, we&rsquo;ll print out all port results, else just the open ones:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">GetOptions (
  <span style="color:#e6db74">&#39;delay=f&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>(<span style="color:#66d9ef">my</span> $delay <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
  <span style="color:#e6db74">&#39;ip=s&#39;</span>        <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span> <span style="color:#66d9ef">my</span> $target_ip,
  <span style="color:#e6db74">&#39;range=s&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span> <span style="color:#66d9ef">my</span> $port_range,
  <span style="color:#e6db74">&#39;procs=i&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>(<span style="color:#66d9ef">my</span> $procs <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>),
  <span style="color:#e6db74">&#39;verbose&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span> <span style="color:#66d9ef">my</span> $verbose,
  <span style="color:#e6db74">&#39;h|help|?&#39;</span>    <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> { pod2usage(<span style="color:#ae81ff">2</span>) },
);</code></pre></div>
<p>Note how for boolean parameters no type declaration is given to <code>GetOptions</code> (e.g. no <code>=i</code>). This means that on the command line the user just has to type either <code>--verbose</code> or <code>-v</code> and <code>$verbose</code> will be given a true value.</p>

<p>Instead of printing out port results in the <code>read_packet()</code> <a href="https://gist.github.com/dnmfarrell/3db321fc11b0d85f729d#file-port_scanner-L145">subroutine</a>, I&rsquo;m going to return the port number and status back to the calling code and defer the printing until later. This simple change has a two benefits: it&rsquo;s more flexible: I can add more packet parsing routines to <code>read_packet()</code> without having to add multiple print statements and I can sort the port scan results before printing them. The program can scan ports in a random order but the output should be orderly!</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">for</span> (sort { $a <span style="color:#e6db74">&lt;=&gt;</span> $b } keys %port_scan_results)
{
  printf <span style="color:#e6db74">&#34; %5u %-15s %-40s\n&#34;</span>, $_, $port_scan_results{$_}, ($port_directory{<span style="color:#e6db74">&#34;$_/$protocol&#34;</span>}<span style="color:#f92672">-&gt;</span>{name} <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;&#39;</span>)
    <span style="color:#66d9ef">if</span> $port_scan_results{$_} <span style="color:#f92672">=~</span> <span style="color:#e6db74">/open/</span> <span style="color:#f92672">||</span> $verbose;
}</code></pre></div>
<p>This approach has one downside - the results will not be printed to the terminal until all responses have been received or the packet capture times out. What would be <em>really</em> nice would be to print the sorted results as they are received. For example if we were scanning ports 1 to 100 and had received responses for ports 1 through 10, print those results and wait until we receive a response for port 11. This improvement is left as an exercise for the reader (pull requests welcome!).</p>

<h3 id="support-different-types-of-scan">Support different types of scan</h3>

<p>The simple scanner does a TCP &ldquo;SYN&rdquo; scan. This is a good default, but there are many different <a href="http://nmap.org/book/man-port-scanning-techniques.html">types</a> of port scans we can undertake, which can yield better results against different systems. For example in my testing I&rsquo;ve found the TCP SYN scan relatively useless against Chromebooks and mobile devices.</p>

<p>As with the other updates, I&rsquo;m going to add new parameters to the <code>GetOptions</code> function. I want to capture the protocol to use (e.g. TCP, UDP, ICMP) and any flags that should be added to the sent packet. These two variables should give us enough flexibility to support a variety of scans.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">GetOptions (
  <span style="color:#e6db74">&#39;delay=f&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>(<span style="color:#66d9ef">my</span> $delay <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
  <span style="color:#e6db74">&#39;ip=s&#39;</span>        <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span> <span style="color:#66d9ef">my</span> $target_ip,
  <span style="color:#e6db74">&#39;range=s&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span> <span style="color:#66d9ef">my</span> $port_range,
  <span style="color:#e6db74">&#39;procs=i&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>(<span style="color:#66d9ef">my</span> $procs <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>),
  <span style="color:#e6db74">&#39;type=s&#39;</span>      <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span>(<span style="color:#66d9ef">my</span> $protocol <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;tcp&#39;</span>),
  <span style="color:#e6db74">&#39;flag=s&#39;</span>      <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span> <span style="color:#66d9ef">my</span> @flags,
  <span style="color:#e6db74">&#39;verbose&#39;</span>     <span style="color:#f92672">=&gt;</span> <span style="color:#f92672">\</span> <span style="color:#66d9ef">my</span> $verbose,
  <span style="color:#e6db74">&#39;h|help|?&#39;</span>    <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> { pod2usage(<span style="color:#ae81ff">2</span>) },
);</code></pre></div>
<p>You might be wondering how it&rsquo;s possible to read the <code>flag</code> string parameter into the <code>@flags</code> array. In this scenario, I want to be able to accept one or more flag arguments, so the user can pass them to the port scanner like this:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">$ <span style="color:#960050;background-color:#1e0010">./</span>port_scanner <span style="color:#f92672">-</span>flag fin <span style="color:#f92672">-</span>flag psh <span style="color:#f92672">-</span>flag urg</code></pre></div>
<p>Or more tersely:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">$ <span style="color:#960050;background-color:#1e0010">./</span>port_scanner <span style="color:#f92672">-</span>f fin <span style="color:#f92672">-</span>f psh <span style="color:#f92672">-</span>f urg</code></pre></div>
<p>These values will be captured into <code>@flags</code>. By the way, those three flags are part of a TCP port scanning technique called the &ldquo;Xmas&rdquo; scan. To process the flags I&rsquo;ll use this code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">die <span style="color:#e6db74">&#34;flags are for tcp only!\n&#34;</span> <span style="color:#66d9ef">if</span> $protocol <span style="color:#f92672">ne</span> <span style="color:#e6db74">&#39;tcp&#39;</span> <span style="color:#f92672">&amp;&amp;</span> @flags;
$flags[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;syn&#39;</span> <span style="color:#66d9ef">unless</span> @flags <span style="color:#f92672">||</span> $protocol <span style="color:#f92672">eq</span> <span style="color:#e6db74">&#39;udp&#39;</span>;
<span style="color:#66d9ef">my</span> $flags <span style="color:#f92672">=</span> { map { $_ <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span> } @flags };
$flags <span style="color:#f92672">=</span> {} <span style="color:#66d9ef">if</span> exists $flags<span style="color:#f92672">-&gt;</span>{null};</code></pre></div>
<p>Flags can only be passed for TCP scans, so the first thing thing I&rsquo;m checking here is if we received any flags and the requested protocol is <em>not</em> TCP, which will raise an exception. The code then reads <code>@flags</code> into a hashref, defaulting to SYN if the protocol is TCP and no flags were passed. We also support a special type of scan the &ldquo;null&rdquo; scan where no flags are passed at all.</p>

<p>Now the <a href="https://gist.github.com/dnmfarrell/3db321fc11b0d85f729d#file-port_scanner-L125-L139">send_packet</a> subroutine can be updated to handle different protocols and scans:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">send_packet</span>
{
  <span style="color:#66d9ef">my</span> ($protocol, $target_port, $flags) <span style="color:#f92672">=</span> @_;

  Net::RawIP<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>({ ip <span style="color:#f92672">=&gt;</span> {
                      saddr <span style="color:#f92672">=&gt;</span> $local_ip,
                      daddr <span style="color:#f92672">=&gt;</span> $target_ip,
                    },
                    $protocol <span style="color:#f92672">=&gt;</span> {
                      source <span style="color:#f92672">=&gt;</span> $local_port,
                      dest   <span style="color:#f92672">=&gt;</span> $target_port,
                      %$flags,
                    },
                  })<span style="color:#f92672">-&gt;</span>send;
}</code></pre></div>
<p>The updated subroutine transparently passes the arguments received to <a href="https://metacpan.org/pod/Net::RawIP">Net::RawIP</a>, which handles the details. The remaining ip and port variables are globals and already defined by this point in the code.</p>

<p>The <a href="https://gist.github.com/dnmfarrell/3db321fc11b0d85f729d#file-port_scanner-L145-L171">read_packet</a> subroutine also needs to be updated to parse different packet types:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">read_packet</span>
{
  <span style="color:#66d9ef">my</span> $raw_data <span style="color:#f92672">=</span> shift;
  <span style="color:#66d9ef">my</span> $ip_data <span style="color:#f92672">=</span> NetPacket::Ethernet::strip($raw_data);
  <span style="color:#66d9ef">my</span> $ip_packet <span style="color:#f92672">=</span> NetPacket::IP<span style="color:#f92672">-&gt;</span>decode($ip_data);

  <span style="color:#66d9ef">if</span> ($ip_packet<span style="color:#f92672">-&gt;</span>{proto} <span style="color:#f92672">==</span> <span style="color:#ae81ff">6</span>)
  {
    <span style="color:#66d9ef">my</span> $tcp <span style="color:#f92672">=</span> NetPacket::TCP<span style="color:#f92672">-&gt;</span>decode(NetPacket::IP::strip($ip_data));
    <span style="color:#66d9ef">my</span> $port <span style="color:#f92672">=</span> $tcp<span style="color:#f92672">-&gt;</span>{src_port};

    <span style="color:#66d9ef">if</span> ($tcp<span style="color:#f92672">-&gt;</span>{flags} <span style="color:#f92672">&amp;</span> SYN)
    {
      <span style="color:#66d9ef">return</span> ($port, <span style="color:#e6db74">&#39;open&#39;</span>);
    }
    <span style="color:#66d9ef">elsif</span> ($tcp<span style="color:#f92672">-&gt;</span>{flags} <span style="color:#f92672">&amp;</span> RST)
    {
      <span style="color:#66d9ef">return</span> ($port, <span style="color:#e6db74">&#39;closed&#39;</span>);
    }
    <span style="color:#66d9ef">return</span> ($port, <span style="color:#e6db74">&#39;unknown&#39;</span>);
  }
  <span style="color:#66d9ef">elsif</span> ($ip_packet<span style="color:#f92672">-&gt;</span>{proto} <span style="color:#f92672">==</span> <span style="color:#ae81ff">17</span>)
  {
    <span style="color:#66d9ef">my</span> $udp <span style="color:#f92672">=</span> NetPacket::UDP<span style="color:#f92672">-&gt;</span>decode(NetPacket::IP::strip($ip_data));
    <span style="color:#66d9ef">my</span> $port <span style="color:#f92672">=</span> $udp<span style="color:#f92672">-&gt;</span>{src_port};
    <span style="color:#66d9ef">return</span> ($port, <span style="color:#e6db74">&#39;open&#39;</span>);
  }
  <span style="color:#66d9ef">else</span>
  {
    warn <span style="color:#e6db74">&#34;Received unknown packet protocol: $ip_packet-&gt;{proto}\n&#34;</span>;
  }
}</code></pre></div>
<p>If we receive a TCP packet, the code examines the packet flags to determine the status of the port. A port is considered open if we receive an ACK/SYN response, which can be tested for by checking the presence of the <code>SYN</code> flag. An <code>RST</code> flag indicates the port is closed. Note that to test for presence of the flag we use bitwise <code>&amp;</code> against the flag constants exported by <a href="https://metacpan.org/pod/NetPacket::TCP">NetPacket::TCP</a>.</p>

<p>UDP is a simpler affair as it doesn&rsquo;t support flags. If we receive a UDP datagram, we treat the port as open.</p>

<h4 id="icmp">ICMP</h4>

<p>Even though we&rsquo;re not sending ICMP messages, we may receive them from the target host. Sometimes hosts return an ICMP message of type &ldquo;destination port unreachable&rdquo; instead of replying with a TCP/UDP packet. The ICMP message will include the IP header of the sender&rsquo;s original message, but IP headers do not include destination ports, so how could we determine the destination port from the ICMP response? One way could be to include the destination port in the data portion of the IP packet. Once we receive the ICMP response, we parse out the IP header and extract the destination port from the data component of the message.</p>

<p>That&rsquo;s not all we can do with ICMP responses. An ICMP response can also indicate that a dynamic firewall has started dropping our packets as we&rsquo;ve exceed a rate-limit. It would be nice if an ICMP message was received, the port scanner automatically increased the delay between sending messages. To communicate this update to the sub-processes, we could install a signal handler. In order to &ldquo;see&rdquo; ICMP message responses, the pcap filter would need to be updated to remove the port clause. This introduces a new problem: we may receive messages from the target host that are unrelated to our scan. For now I&rsquo;ve avoided handling ICMP.</p>

<h3 id="running-the-new-port-scanner">Running the new port scanner</h3>

<p>So that&rsquo;s it! The full code can be found <a href="https://github.com/dnmfarrell/Penetration-Testing-With-Perl/blob/master/port_scanner">here</a>. Now let&rsquo;s see some examples of how to run the code:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e"># tcp syn scan of common ports, 100 processes sending packets every 0.25 sec:</span>
$ sudo $<span style="color:#960050;background-color:#1e0010">(</span>which perl) <span style="color:#f92672">-</span>i <span style="color:#ae81ff">192.168.1.5</span> <span style="color:#f92672">-</span>p <span style="color:#ae81ff">100</span> <span style="color:#f92672">-</span>d <span style="color:#ae81ff">0.25</span>

<span style="color:#75715e"># same as before but print all closed and filtered ports too</span>
$ sudo $<span style="color:#960050;background-color:#1e0010">(</span>which perl) <span style="color:#f92672">-</span>i <span style="color:#ae81ff">192.168.1.5</span> <span style="color:#f92672">-</span>p <span style="color:#ae81ff">100</span> <span style="color:#f92672">-</span>d <span style="color:#ae81ff">0.25</span> <span style="color:#f92672">-</span>v

<span style="color:#75715e"># udp scan</span>
$ sudo $<span style="color:#960050;background-color:#1e0010">(</span>which perl) <span style="color:#f92672">-</span>i <span style="color:#ae81ff">192.168.1.5</span> <span style="color:#f92672">-</span>t udp

<span style="color:#75715e"># tcp fin scan</span>
$ sudo $<span style="color:#960050;background-color:#1e0010">(</span>which perl) <span style="color:#f92672">-</span>i <span style="color:#ae81ff">192.168.1.5</span> <span style="color:#f92672">-</span>f fin

<span style="color:#75715e"># tcp null scan</span>
$ sudo $<span style="color:#960050;background-color:#1e0010">(</span>which perl) <span style="color:#f92672">-</span>i <span style="color:#ae81ff">192.168.1.5</span> <span style="color:#f92672">-</span>f null

<span style="color:#75715e"># tcp xmas scan</span>
$ sudo $<span style="color:#960050;background-color:#1e0010">(</span>which perl) <span style="color:#f92672">-</span>i <span style="color:#ae81ff">192.168.1.5</span><span style="color:#f92672">-</span> f fin <span style="color:#f92672">-</span>f psh <span style="color:#f92672">-</span>f urg</code></pre></div>
<h3 id="conclusion">Conclusion</h3>

<p>We&rsquo;ve built something that&rsquo;s beginning to resemble a professional tool: a customizable, high performance TCP/UDP port scanner with useful reporting. By developing our own solution and not relying on tools like nmap, we can achieve a deeper understanding of how networking works and the skills required to scan a host.</p>

<p><br />
<em>This article was originally posted on <a href="http://perltricks.com">PerlTricks.com</a>.</em></p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/security">security</a></div>
                
                  <div class="tag"><a href="/tags/tcp">tcp</a></div>
                
                  <div class="tag"><a href="/tags/icmp">icmp</a></div>
                
                  <div class="tag"><a href="/tags/udp">udp</a></div>
                
                  <div class="tag"><a href="/tags/nmap">nmap</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-david-farrell">
  <div class="col-sm-2">
    
    <a href="/authors/david-farrell/"><div class="circle-avatar" style="background-image:url(/images/author/david-farrell.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/david-farrell/"><h3>David Farrell</h3></a>
    <p>David is the editor of Perl.com. An organizer of the <a href="http://www.meetup.com/The-New-York-Perl-Meetup-Group/">New York Perl Meetup</a>, he works for ZipRecruiter as a software developer, and sometimes <a href="https://twitter.com/perltricks">tweets</a> about Perl and Open Source.</p>
    <h5><a href="/authors/david-farrell/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/article/port-scanning-with-perl--part-ii.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

