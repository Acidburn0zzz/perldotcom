<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Validating untrusted input: numbers </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Common techniques and edge cases"/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/article/validating-untrusted-input-numbers/" />
<meta property="og:title" content="Validating untrusted input: numbers" />
<meta property="og:description" content="Common techniques and edge cases">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2018-12-12T12:12:12Z" />
<meta property="og:image" content="http://localhost:1313/images/author/david-farrell.jpg" />
<meta property="og:article:tag" content="scalar-util" />
<meta property="og:article:tag" content="regexp-common" />
<meta property="og:article:tag" content="dualvar" />
<meta property="og:article:tag" content="taint" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Validating untrusted input: numbers</h1>
              <p class="blog-post-meta">Dec 3, 2018 by
              
              
                
                
                <a href="#author-bio-david-farrell">David Farrell</a>
              
              </p>
              <img alt="" src=""/>
                

<p>Validating untrusted input safely is critical for application security: SQL injection, XSS and malicious file upload are common attacks which succeed because the user&rsquo;s input is not vetted correctly.</p>

<p>Numbers are problematic: negative numbers (&ldquo;the sales price was -$500&rdquo;), very large numbers (&ldquo;my account balance is 9,223,372,036,854,775,807&rdquo;) or not-a-number (&ldquo;rm -rf /&rdquo;) can all wreak havoc if not handled with care.</p>

<p>Fortunately, Perl has robust capabilities for validating input but there are some edge cases to be aware of that make answering &ldquo;is $x a number?&rdquo; more difficult than you might think it would be.</p>

<h2 id="pattern-matching">Pattern matching</h2>

<p>Part of the problem of course, is that numbers come in more varieties than we commonly assume there to be. Regexes are a natural fit for common cases like decimal integer validation: for example <code>/^\d+$/</code> would confirm the input contains only digits. That might be enough for your application but be aware that it doesn&rsquo;t handle all permutations of integers. What if you want to accept negative numbers?</p>

<p>You could update the regex to accept an optional minus:  <code>/^-?\d+$/</code> or use a standardized regex from <a href="https://metacpan.org/pod/Regexp::Common::number">Regexp::Common::number</a>, which also has patterns for matching decimal places, thousands separators and other common-but-tricky things to match.</p>

<p>Large integers may also fail to match <code>\d</code>. Perl has three different ways to store numbers: as native C integers, as 8 byte floating point, or as decimal strings in &ldquo;e&rdquo; notation (see <a href="https://perldoc.perl.org/perlnumber.html">perlnumber</a>). On my machine, Perl stores <code>123456789012345678905</code> as the decimal string <code>1.23456789012346e+20</code>, which doesn&rsquo;t match an integer-only regex. 8 byte floating point and decimal strings are imprecise, so if you need to accept integers larger than your machine architecture (32bit or 64 bit), you should use a module like <a href="https://metacpan.org/pod/Math::BigInt">Math::BigInt</a> instead.</p>

<p>If you have Perl&rsquo;s <a href="https://perldoc.perl.org/perlsec.html">taint mode</a> enabled, regex captures are the correct way to &ldquo;de-taint&rdquo; input, in which case you&rsquo;ll have no choice but to use them.</p>

<h2 id="looks-like-a-number">Looks like a number</h2>

<p>A complementary technique to using a regex is to use the function <code>looks_like_number</code> from <a href="https://metacpan.org/pod/Scalar::Util">Scalar::Util</a>. This is a boolean function which returns true if the variable looks like a number to the Perl interpreter.</p>

<p>Unlike simple regexes, it recognizes negative numbers and decimal strings just fine, but it has its own quirks that you should know about. For example, all of these strings &ldquo;look like numbers&rdquo;:</p>

<pre><code>NaN
-nan
inf
infinity
-infinity
</code></pre>

<p>Uh oh!</p>

<p>The other quirk of <code>looks_like_number</code> exists in older versions of Scalar::Util (up to v1.38, which shipped with Perl 5.20): its return value changes depending on the value of the variable being checked:</p>

<pre><code>$ perl -MScalar::Util=looks_like_number -e 'print looks_like_number($_), &quot;\n&quot; for (1,&quot;5&quot;,&quot;5e60&quot;)'
16842752
1
4
</code></pre>

<p>This is because <code>looks_like_number</code> is returning the Perl interpreter&rsquo;s C function return value which may include a binary ORing of several different flags Perl keeps for each variable (<a href="https://stackoverflow.com/questions/19201234/behavior-of-scalarutillooks-like-number-in-perl/19202153#19202153">stackoverflow</a>).</p>

<p>All of these <em>are</em> true values, so it shouldn&rsquo;t be a problem if you don&rsquo;t write conditions expecting the return value to be 1:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> Scalar::Util <span style="color:#e6db74">&#39;looks_like_number&#39;</span>;

<span style="color:#75715e"># wrong</span>
<span style="color:#66d9ef">if</span> (looks_like_number($foo) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">...</span>

<span style="color:#75715e"># right!</span>
<span style="color:#66d9ef">if</span> (looks_like_number($foo)) <span style="color:#f92672">...</span></code></pre></div>
<h2 id="the-observer-effect">The Observer Effect</h2>

<p>Another edge case in Perl is that the act of observing a scalar&rsquo;s value can change the scalar&rsquo;s type from number to string.</p>

<p>Perl scalars can contain different types like strings, integers and floating point numbers. This is usually convenient: if you need to print a number, you don&rsquo;t have to cast it to a string first because Perl tries to Do the Right Thing™. Scalars are <a href="https://www.effectiveperlprogramming.com/2011/12/create-your-own-dualvars/">dualvars</a>, for efficiency, the Perl interpreter casts the number to a string and stores it in the scalar&rsquo;s struct string slot, so if the scalar is interpolated a second time, Perl doesn&rsquo;t need to cast it to a string again.</p>

<p>A common way this issue manifests itself is when serializing a Perl data structure to JSON. Scalars which contain numbers when stringified, are then serialized to JSON as strings, instead of integers:</p>

<pre><code>$ perl -MJSON -E 'my $n = 1; say encode_json([$n]); say &quot;$n&quot;; say encode_json([$n])'
[1]
1
[&quot;1&quot;]
</code></pre>

<p>Interpolating a number in a string or matching it against a regex both cause the number to string conversion. Depending on your requirements, this might not matter, but if it does, when validating number input, make a local copy of the variable first so that your validation routines don&rsquo;t subtly change the variable type.</p>

<h2 id="combining-techniques">Combining techniques</h2>

<p>Combining these ideas into a sub:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> Scalar::Util <span style="color:#e6db74">&#39;looks_like_number&#39;</span>;

<span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">is_number</span> {
  <span style="color:#66d9ef">my</span> $num <span style="color:#f92672">=</span> shift;
  <span style="color:#66d9ef">return</span> looks_like_number($num) <span style="color:#f92672">&amp;&amp;</span> $num <span style="color:#f92672">!~</span> <span style="color:#e6db74">/inf|nan/i</span>;
}</code></pre></div>
<p>I&rsquo;ve defined the sub <code>is_number</code> as a boolean function which accepts a value and returns true if it looks like a number to Perl, and isn&rsquo;t infinity or not-a-number. It copies the variable and does not change its type. This will work for a wide-range of number types, including the really-large numbers Perl converts to decimal string (of dubious benefit!).</p>

<p>Your application&rsquo;s requirements determine which types of numbers you should accept, just keep in mind that the more varieties of number you accept, the more complicated the validation becomes. If you&rsquo;re familiar with these edge cases however, the task becomes a little easier.</p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/development">development</a></div>
                
                  <div class="tag"><a href="/tags/scalar-util">scalar-util</a></div>
                
                  <div class="tag"><a href="/tags/regexp-common">regexp-common</a></div>
                
                  <div class="tag"><a href="/tags/dualvar">dualvar</a></div>
                
                  <div class="tag"><a href="/tags/taint">taint</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-david-farrell">
  <div class="col-sm-2">
    
    <a href="/authors/david-farrell/"><div class="circle-avatar" style="background-image:url(/images/author/david-farrell.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/david-farrell/"><h3>David Farrell</h3></a>
    <p>David is the editor of Perl.com. An organizer of the <a href="http://www.meetup.com/The-New-York-Perl-Meetup-Group/">New York Perl Meetup</a>, he works for ZipRecruiter as a software developer, and sometimes <a href="https://twitter.com/perltricks">tweets</a> about Perl and Open Source.</p>
    <h5><a href="/authors/david-farrell/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/article/validating-untrusted-input-numbers.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

