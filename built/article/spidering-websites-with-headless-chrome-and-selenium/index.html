<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Spidering websites with Headless Chrome and Selenium </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="How I setup and controlled headless Chrome with Perl"/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/article/spidering-websites-with-headless-chrome-and-selenium/" />
<meta property="og:title" content="Spidering websites with Headless Chrome and Selenium" />
<meta property="og:description" content="How I setup and controlled headless Chrome with Perl">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2019-01-01T01:01:01Z" />
<meta property="og:image" content="http://localhost:1313/images/spidering-websites-with-headless-chrome-and-selenium/thumb_chrome.png" />
<meta property="og:article:tag" content="chrome" />
<meta property="og:article:tag" content="selenium" />
<meta property="og:article:tag" content="chromedriver" />
<meta property="og:article:tag" content="selenium-remote-driver" />
<meta property="og:article:tag" content="headless" />
<meta property="og:article:tag" content="spider" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Spidering websites with Headless Chrome and Selenium</h1>
              <p class="blog-post-meta">Jan 13, 2019 by
              
              
                
                
                <a href="#author-bio-david-farrell">David Farrell</a>
              
              </p>
              <img alt="" src="/images/spidering-websites-with-headless-chrome-and-selenium/chrome.png"/>
                

<p>Over the holidays I was working on a project that needed to download content from different websites. I needed a web spider, but the typical Perl options like <a href="https://metacpan.org/pod/WWW::Mechanize">WWW:Mechanize</a> wouldn&rsquo;t cut it, as with JavaScript controlling the content on many websites, I needed a JavaScript-enabled browser. But browsers consume lots of memory - what to do?</p>

<p>The answer was to use headless Chrome, which works exactly like normal except it has no graphical display, reducing its memory footprint. I can control it using <a href="https://metacpan.org/pod/Selenium::Remote::Driver">Selenium::Remote::Driver</a> and Selenium server. Here&rsquo;s how I did it.</p>

<h2 id="non-perl-setup">Non-Perl Setup</h2>

<p>Obviously I needed to install the Chrome browser. On Linux that usually involves adding the Chrome repo, and then installing the Chrome package. On Fedora it was as easy as:</p>

<pre><code>sudo dnf install fedora-workstation-repositories
sudo dnf config-manager --set-enabled google-chrome
sudo dnf install google-chrome-stable
</code></pre>

<p>I also needed ChromeDriver, which implements WebDriver&rsquo;s wire protocol for Chrome. In other words, it&rsquo;s the means by which Selenium talks with Chrome:</p>

<pre><code>wget https://chromedriver.storage.googleapis.com/2.41/chromedriver_linux64.zip
unzip chromedriver_linux64.zip
</code></pre>

<p>I put it under <code>/usr/bin</code>:</p>

<pre><code>sudo chown root:root chromedriver
sudo chmod 755 chromedriver
sudo mv chromedriver /usr/bin/
</code></pre>

<p>I downloaded Selenium server:</p>

<pre><code>wget https://selenium-release.storage.googleapis.com/3.14/selenium-server-standalone-3.14.0.jar
</code></pre>

<p>This version of Selenium requires Java version 8, which I installed via its package:</p>

<pre><code>sudo dnf install java-1.8.0-openjdk
</code></pre>

<p>Finally I launched Selenium server:</p>

<pre><code>java -Dwebdriver.chrome.driver=/usr/bin/chromedriver -jar selenium-server-standalone-3.14.0.jar
</code></pre>

<p>This must be running in order for Perl to communicate with Chrome using Selenium.</p>

<h2 id="a-basic-spider">A basic spider</h2>

<p>I wrote a basic spider script, here&rsquo;s a simplified version:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/env perl</span>
<span style="color:#66d9ef">use</span> Selenium::Remote::Driver;
<span style="color:#66d9ef">use</span> Encode <span style="color:#e6db74">&#39;encode&#39;</span>;

<span style="color:#66d9ef">my</span> $driver <span style="color:#f92672">=</span> Selenium::Remote::Driver<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>(
  browser_name <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;chrome&#39;</span>,
  extra_capabilities <span style="color:#f92672">=&gt;</span> { chromeOptions <span style="color:#f92672">=&gt;</span> {args <span style="color:#f92672">=&gt;</span> [
    <span style="color:#e6db74">&#39;window-size=1920,1080&#39;</span>,
    <span style="color:#e6db74">&#39;headless&#39;</span>,
  ]}},
);

<span style="color:#66d9ef">my</span> %visited <span style="color:#f92672">=</span> ();
<span style="color:#66d9ef">my</span> $depth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
<span style="color:#66d9ef">my</span> $url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://example.com&#39;</span>;

spider_site($driver, $url, $depth);

$driver<span style="color:#f92672">-&gt;</span>quit();</code></pre></div>
<p>This script initializes a <code>Selenium::Remote::Driver</code> object. Note how it passes options to Chrome: the <code>window-size</code> option is an example of a key-pair option, whereas <code>headless</code> is a boolean. Chrome accepts a <em>lot</em> of <a href="https://peter.sh/experiments/chromium-command-line-switches/">options</a>. Some others which were useful for me:</p>

<ul>
<li><code>allow-running-insecure-content</code> - let Chrome load websites with invalid security certificates</li>
<li><code>disable-infobars</code> - disable the &ldquo;Chrome is being controlled by software&rdquo; notification</li>
<li><code>no-sandbox</code> - disable the sandbox security feature, lets you run headless Chrome as root</li>
</ul>

<p>The script initializes a <code>%visited</code> hash to store URLs the browser visits, to avoid requesting the same URL twice. The <code>$depth</code> variable determines how many levels deep the spider should go: with a value of 1 it will visit all links on the first page it loads, but none after that. The <code>$url</code> variable determines the starting web page to visit.</p>

<p>The <code>spider_site</code> function is recursive:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">spider_site</span> {
  <span style="color:#66d9ef">my</span> ($driver, $url, $depth) <span style="color:#f92672">=</span> @_;
  warn <span style="color:#e6db74">&#34;fetching $url\n&#34;</span>;
  $driver<span style="color:#f92672">-&gt;</span>get($url);
  $visited{$url}<span style="color:#f92672">++</span>;

  <span style="color:#66d9ef">my</span> $text <span style="color:#f92672">=</span> $driver<span style="color:#f92672">-&gt;</span>get_body;
  <span style="color:#66d9ef">print</span> encode(<span style="color:#e6db74">&#39;UTF-8&#39;</span>, $text);

  <span style="color:#66d9ef">if</span> ($depth <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    <span style="color:#66d9ef">my</span> @links <span style="color:#f92672">=</span> $driver<span style="color:#f92672">-&gt;</span>find_elements(<span style="color:#e6db74">&#39;a&#39;</span>, <span style="color:#e6db74">&#39;tag_name&#39;</span>);
    <span style="color:#66d9ef">my</span> @urls <span style="color:#f92672">=</span> ();
    <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">my</span> $l (@links) {
      <span style="color:#66d9ef">my</span> $link_url <span style="color:#f92672">=</span> eval { $l<span style="color:#f92672">-&gt;</span>get_attribute(<span style="color:#e6db74">&#39;href&#39;</span>) };
      push @urls, $link_url <span style="color:#66d9ef">if</span> $link_url;
    }
    <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">my</span> $u (@urls) {
      spider_site($driver, $u, $depth <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#66d9ef">unless</span> ($visited{$u});
    }
  }
}</code></pre></div>
<p>It fetches the given <code>$url</code>, printing the text content of the webpage to STDOUT. It encodes the output before printing it: I found this was necessary to avoid multibyte encoding issues. If the spider hasn&rsquo;t reached full depth, it gets all links on the page, and spiders each one that it hasn&rsquo;t already visited. I wrapped the <code>get_attribute</code> method call in <code>eval</code> because it can fail if the link disappears from the website after it was found.</p>

<h2 id="an-improved-spider">An improved spider</h2>

<p>The spider script shown above is functional but rudimentary. I wrote a more <a href="https://gist.github.com/dnmfarrell/5dde6d3957bf9ae037e170cdb44f75a5">advanced</a> one that has some nice features:</p>

<ul>
<li>Pings Selenium server on startup and quits if it&rsquo;s not responding</li>
<li>Restricts the links followed to those which match the domain of the starting URL to avoid downloading content from unrelated websites</li>
<li>Converts static variables like <code>$depth</code> into command line options</li>
<li>Adds a debugging mode to print out the decisions made by the spider</li>
<li>Accepts a list of URLs instead of just one at a time</li>
<li>Spiders URLs in parallel using <a href="https://metacpan.org/pod/Parallel::ForkManager">Parallel::ForkManager</a></li>
<li>Prints website content as gzipped files to separate content from different starting URLs <em>and</em> save disk space</li>
</ul>

<p>There are other improvements I&rsquo;d like to make, but those were enough to get the job done.</p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/web">web</a></div>
                
                  <div class="tag"><a href="/tags/chrome">chrome</a></div>
                
                  <div class="tag"><a href="/tags/selenium">selenium</a></div>
                
                  <div class="tag"><a href="/tags/chromedriver">chromedriver</a></div>
                
                  <div class="tag"><a href="/tags/selenium-remote-driver">selenium-remote-driver</a></div>
                
                  <div class="tag"><a href="/tags/headless">headless</a></div>
                
                  <div class="tag"><a href="/tags/spider">spider</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-david-farrell">
  <div class="col-sm-2">
    
    <a href="/authors/david-farrell/"><div class="circle-avatar" style="background-image:url(/images/author/david-farrell.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/david-farrell/"><h3>David Farrell</h3></a>
    <p>David is the editor of Perl.com. An organizer of the <a href="http://www.meetup.com/The-New-York-Perl-Meetup-Group/">New York Perl Meetup</a>, he works for ZipRecruiter as a software developer, and sometimes <a href="https://twitter.com/perltricks">tweets</a> about Perl and Open Source.</p>
    <h5><a href="/authors/david-farrell/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/article/spidering-websites-with-headless-chrome-and-selenium.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

