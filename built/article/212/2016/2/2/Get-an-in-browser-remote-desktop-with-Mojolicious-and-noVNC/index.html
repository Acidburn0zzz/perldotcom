<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Get an in-browser remote desktop with Mojolicious and noVNC </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Using Mojolicious as a TCP/WebSocket Bridge"/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/article/212/2016/2/2/Get-an-in-browser-remote-desktop-with-Mojolicious-and-noVNC/" />
<meta property="og:title" content="Get an in-browser remote desktop with Mojolicious and noVNC" />
<meta property="og:description" content="Using Mojolicious as a TCP/WebSocket Bridge">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2016-02-02T02:02:02Z" />
<meta property="og:image" content="http://localhost:1313/images/212/thumb_0156BEFE-C9B2-11E5-A2BB-E80C3AD1818C.jpeg" />
<meta property="og:article:tag" content="mojolicious" />
<meta property="og:article:tag" content="websockets" />
<meta property="og:article:tag" content="novnc" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Get an in-browser remote desktop with Mojolicious and noVNC</h1>
              <p class="blog-post-meta">Feb 2, 2016 by
              
              
                
                
                <a href="#author-bio-joel-berger">Joel Berger</a>
              
              </p>
              <img alt="" src="/images/212/0156BEFE-C9B2-11E5-A2BB-E80C3AD1818C.jpeg"/>
                

<p>While SSH is a staple of remote system administration, sometimes only a GUI will do. Perhaps the remote system doesn&rsquo;t have a terminal environment to connect to; perhaps the target application doesn&rsquo;t present an adequate command line interface; perhaps there is an existing GUI session you need to interact with. There can be all kinds of reasons.</p>

<p>For this purpose, a generic type of remote desktop service called VNC is commonly used. The servers are easy to install, start on seemingly all platforms and lots of hardware has a VNC server embedded for remote administration. Clients are similarly easy to use, but when building a management console in the web, wouldn&rsquo;t it be nice to have the console view right in your browser?</p>

<p>Luckily there is a pure JavaScript VNC client called <a href="https://github.com/kanaka/noVNC">noVNC</a> noVNC listens for VNC traffic over WebSockets, which is convenient for browsers but isn&rsquo;t supported by most VNC servers. To overcome this problem they provide a command-line application called <a href="https://github.com/kanaka/websockify">Websockify</a>.</p>

<p>Websockify is a relay that connects to a TCP connection (the VNC server) and exposes the traffic as a WebSocket stream such that a browser client can listen on. While this does fix the problem it isn&rsquo;t an elegant solution. Each VNC Server needs its own instance of Websockify requiring a separate port. Further you either need to leave these connected at all times in case of a web client or else spawn them on demand and clean them up later.</p>

<h2 id="mojolicious-to-the-rescue">Mojolicious to the Rescue</h2>

<p>Mojolicious has a built-in event-based <a href="http://mojoliciou.us/perldoc/Mojo/IOLoop/Client">TCP Client</a> and native <a href="http://mojolicious.org/perldoc/Mojolicious/Guides/Tutorial#WebSockets">WebSocket</a> handling. If you are already serving your site with Mojolicious, why not let it do the TCP/WebSocket relay work too? Even if you aren&rsquo;t, the on-demand nature of the solution I&rsquo;m going to show would be useful as a stand-alone app for this single purpose versus the websockify application.</p>

<p>Here is a <a href="http://mojolicio.us/perldoc/Mojolicious/Guides/Tutorial">Mojolicious::Lite</a> application which serves the noVNC client when you request a url like <code>/192.168.0.1</code>. When the page loads, the client requests the WebSocket route at <code>/proxy?target=192.168.0.1</code> which establishes the bridge. This example is bundled with my forthcoming wrapper module with a working name of <a href="https://github.com/jberger/Mojo-Websockify/blob/master/ex/client.pl">Mojo::Websockify</a>. The code is remarkably simple:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">use</span> Mojolicious::Lite;

<span style="color:#66d9ef">use</span> Mojo::IOLoop;

websocket <span style="color:#e6db74">&#39;/proxy&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> {
  <span style="color:#66d9ef">my</span> $c <span style="color:#f92672">=</span> shift;
  $c<span style="color:#f92672">-&gt;</span>render_later<span style="color:#f92672">-&gt;</span>on(finish <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> { warn <span style="color:#e6db74">&#39;websocket closing&#39;</span> });

  <span style="color:#66d9ef">my</span> $tx <span style="color:#f92672">=</span> $c<span style="color:#f92672">-&gt;</span>tx;
  $tx<span style="color:#f92672">-&gt;</span>with_protocols(<span style="color:#e6db74">&#39;binary&#39;</span>);

  <span style="color:#66d9ef">my</span> $host <span style="color:#f92672">=</span> $c<span style="color:#f92672">-&gt;</span>param(<span style="color:#e6db74">&#39;target&#39;</span>) <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;127.0.0.1&#39;</span>;
  <span style="color:#66d9ef">my</span> $port <span style="color:#f92672">=</span> $host <span style="color:#f92672">=~</span> <span style="color:#e6db74">s{:(\d+)$}{}</span> ? $1 : <span style="color:#ae81ff">5901</span>;

  Mojo::IOLoop<span style="color:#f92672">-&gt;</span>client(address <span style="color:#f92672">=&gt;</span> $host, port <span style="color:#f92672">=&gt;</span> $port, <span style="color:#66d9ef">sub</span> {
    <span style="color:#66d9ef">my</span> ($loop, $err, $tcp) <span style="color:#f92672">=</span> @_;

    $tx<span style="color:#f92672">-&gt;</span>finish(<span style="color:#ae81ff">4500</span>, <span style="color:#e6db74">&#34;TCP connection error: $err&#34;</span>) <span style="color:#66d9ef">if</span> $err;
    $tcp<span style="color:#f92672">-&gt;</span>on(error <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> { $tx<span style="color:#f92672">-&gt;</span>finish(<span style="color:#ae81ff">4500</span>, <span style="color:#e6db74">&#34;TCP error: $_[1]&#34;</span>) });

    $tcp<span style="color:#f92672">-&gt;</span>on(read <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> {
      <span style="color:#66d9ef">my</span> ($tcp, $bytes) <span style="color:#f92672">=</span> @_;
      $tx<span style="color:#f92672">-&gt;</span>send({binary <span style="color:#f92672">=&gt;</span> $bytes});
    });

    $tx<span style="color:#f92672">-&gt;</span>on(binary <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> {
      <span style="color:#66d9ef">my</span> ($tx, $bytes) <span style="color:#f92672">=</span> @_;
      $tcp<span style="color:#f92672">-&gt;</span>write($bytes);
    });

    $tx<span style="color:#f92672">-&gt;</span>on(finish <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> {
      $tcp<span style="color:#f92672">-&gt;</span>close;
      undef $tcp;
      undef $tx;
    });
  });
};

get <span style="color:#e6db74">&#39;/*target&#39;</span> <span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">sub</span> {
  <span style="color:#66d9ef">my</span> $c <span style="color:#f92672">=</span> shift;
  <span style="color:#66d9ef">my</span> $target <span style="color:#f92672">=</span> $c<span style="color:#f92672">-&gt;</span>stash(<span style="color:#e6db74">&#39;target&#39;</span>);
  <span style="color:#66d9ef">my</span> $url <span style="color:#f92672">=</span> $c<span style="color:#f92672">-&gt;</span>url_for(<span style="color:#e6db74">&#39;proxy&#39;</span>)<span style="color:#f92672">-&gt;</span>query(target <span style="color:#f92672">=&gt;</span> $target);
  $url<span style="color:#f92672">-&gt;</span>path<span style="color:#f92672">-&gt;</span>leading_slash(<span style="color:#ae81ff">0</span>); <span style="color:#75715e"># novnc assumes no leading slash :(</span>
  $c<span style="color:#f92672">-&gt;</span>render(
    vnc  <span style="color:#f92672">=&gt;</span>
    base <span style="color:#f92672">=&gt;</span> $c<span style="color:#f92672">-&gt;</span>tx<span style="color:#f92672">-&gt;</span>req<span style="color:#f92672">-&gt;</span>url<span style="color:#f92672">-&gt;</span>to_abs,
    path <span style="color:#f92672">=&gt;</span> $url,
  );
};

app<span style="color:#f92672">-&gt;</span>start;</code></pre></div>
<p>The <code>get</code> route shown at the bottom and isn&rsquo;t very exciting. It&rsquo;s the frontend route that renders the noVNC client and tells it the WebSocket url.</p>

<p>The <code>websocket</code> route is the more interesting one, which I will explain in detail. After shifting off the controller, we tell the server not to attempt to render a template (<code>render_later</code>), then subscribe to the finish handler. This is actually a hint to the server that we intend to initiate a WebSocket connection later. Typically this is done by either subscribing to one of the message events or else by sending data upon connection, but in this case we won&rsquo;t do either until the TCP connection is established. Then after extracting the target host and port from the query argument we are ready to make the TCP connection.</p>

<p><a href="http://mojolicious.org/perldoc/Mojo/IOLoop#client"><code>Mojo::IOLoop-&gt;client</code></a> simply takes connection arguments and a callback for what to do once connected. We use this callback to establish our relay. The WebSocket protocol reserves all closing statuses below 4000 for internal use, so I&rsquo;ve taken to using the standard HTTP statuses and prepending a 4 to them. Thus when setting up the TCP error handling, either on initially connecting or for subsequent errors, the status passed to the WebSocket <code>finish</code> method is 4500.</p>

<p>The relay itself is the next two method calls. First, when the TCP socket emits a <code>read</code> event, we take its raw bytes and send them (as binary messages) to the WebSocket client. Then when the WebSocket emits a binary frame (i.e. when it receives a binary message) we write that back to the TCP connection. Finally when the Websocket is closed, we also close the TCP connection and cleanup our handlers.</p>

<p>Simple, isn&rsquo;t it?!</p>

<h2 id="additional-notes">Additional Notes</h2>

<p>There are a few things missing. First is that I haven&rsquo;t addressed security in this example. If any part of the stream is publicly available you will want to encrypt the traffic and put the servers behind authentication. Another risk is the issue of &ldquo;back pressure&rdquo; where a stream starts sending floods of data.</p>

<p>You may have noticed I skipped one line, which until a recent version of Chrome wasn&rsquo;t necessary. When the WebSocket connection is first established it calls <code>with_protocols('binary')</code>. Early versions of noVNC also supported sending the TCP traffic as base64 encoded text, since early implementations of WebSockets didn&rsquo;t distinguish between text and binary frame types as the modern ones do. The WebSocket protocol allows the client to request an application-defined &ldquo;sub-protocol&rdquo; which noVNC used to request binary or base64, the latter of which has long since been deprecated and removed. The client still asks for the binary sub-protocol and recent versions of Chrome have started to refuse to connect if the server doesn&rsquo;t indicate that it can handle this request.</p>

<h2 id="shouldn-t-this-be-on-cpan">Shouldn&rsquo;t This Be On CPAN?</h2>

<p>I&rsquo;m hoping to wrap this TCP/WebSocket bridge logic up as a module called <code>Mojo::Websockify</code> and include the noVNC client as an example. It turns out however, that the logic which is simple to show here is remarkably hard to package in a generic, extensible way. For example, you may want to check if the TCP service is already in use via some database-locking table, or to allow remote-takeover of sessions using a message broker between clients. I&rsquo;ll probably just simplify things for the common case and build in some protection for the &ldquo;back pressure&rdquo; problem. In the meantime I hope you have enjoyed seeing how beautifully simple Mojolicious&rsquo; WebSocket and TCP services are.</p>

<p>Happy Perling!</p>

<p><br />
<em>This article was originally posted on <a href="http://perltricks.com">PerlTricks.com</a>.</em></p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/web">web</a></div>
                
                  <div class="tag"><a href="/tags/mojolicious">mojolicious</a></div>
                
                  <div class="tag"><a href="/tags/websockets">websockets</a></div>
                
                  <div class="tag"><a href="/tags/novnc">novnc</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-joel-berger">
  <div class="col-sm-2">
    
    <a href="/authors/joel-berger/"><div class="circle-avatar" style="background-image:url(/images/author/joel-berger.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/joel-berger/"><h3>Joel Berger</h3></a>
    <p>Joel Berger is a scientist and Perl programmer. A core contributor to the Mojolicious web framework, he <a href="http://blogs.perl.org/users/joel_berger/">blogs</a> frequently and can be found on <a href="https://twitter.com/joelaberger">Twitter</a>.</p>
    <h5><a href="/authors/joel-berger/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/article/get-an-in-browser-remote-desktop-with-mojolicious-and-novnc.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

