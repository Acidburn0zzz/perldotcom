<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Observing Coronavirus Pandemic with Raku </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Using the Raku programming language to process and display statistical data"/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/article/observing-coronavirus-with-raku/" />
<meta property="og:title" content="Observing Coronavirus Pandemic with Raku" />
<meta property="og:description" content="Using the Raku programming language to process and display statistical data">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2020-04-04T04:04:04Z" />
<meta property="og:image" content="http://localhost:1313/images/author/andrew-shitov.jpg" />
<meta property="og:article:tag" content="covid-19" />
<meta property="og:article:tag" content="data-processing" />
<meta property="og:article:tag" content="csv" />
<meta property="og:article:tag" content="johns-hopkins" />
<meta property="og:article:tag" content="perl6" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Observing Coronavirus Pandemic with Raku</h1>
              <p class="blog-post-meta">Apr 2, 2020 by
              
              
                
                
                <a href="#author-bio-andrew-shitov">Andrew Shitov</a>
              
              </p>
              <img alt="" src=""/>
                

<p>Every few years a new unknown virus pops up and starts spreading around the globe. This year, the situation with COVID-19 is different not only because of the nature of the virus but also because of the Internet. Whilst we have instant access to new information (which is often alarmist in tone) we also have the ability to access data for ourselves.</p>

<p>Johns Hopkins University Center for Systems Science and Engineering synthesizes COVID-19 data from different sources, and displays it on their <a href="https://gisanddata.maps.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6">online dashboard</a>. They also publish daily updates in CSV files on <a href="https://github.com/CSSEGISandData/COVID-19">GitHub</a>.</p>

<p>I decided to ingest their CSV data and display it using different visualizations to reduce panic and provide a way to quickly see real numbers and trends. The result is the website <a href="https://covid.observer">covid.observer</a>. The source files are available in the GitHub <a href="https://github.com/ash/covid.observer">repository</a>.</p>

<p>For years Perl has been known for BioPerl. Let’s see what Raku can bring to society as its great at manipulating text data. The heart of the site is a Raku program and a few modules that parse data and create static HTML pages.</p>

<p><br />
<img src="/images/observing-coronavirus-with-raku/covid-observer.png" alt="covid-observer" />
<br />
</p>

<p>I&rsquo;m going to show you a few of the most useful features that Raku offers to developers.</p>

<h2 id="the-main-function">The <code>MAIN</code> function</h2>

<p>The program works in three modes: parsing population data, getting updates from the COVID raw data, and generating HTML files. Raku gives us a very handy way to process command line arguments by defining different variants of the <code>MAIN</code> function. Each variant is mapped to different command line parameters, and Raku automatically dispatches to the matched variant, which helps me to run the program in the desired mode.</p>

<p>Here are the variants:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">multi <span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">MAIN</span>(&#39;population&#39;) {
    <span style="color:#f92672">.</span> <span style="color:#f92672">.</span> <span style="color:#f92672">.</span>
}

multi <span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">MAIN</span>(&#39;fetch&#39;) {
    <span style="color:#f92672">.</span> <span style="color:#f92672">.</span> <span style="color:#f92672">.</span>
}

multi <span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">MAIN</span>(&#39;generate&#39;) {
    <span style="color:#f92672">.</span> <span style="color:#f92672">.</span> <span style="color:#f92672">.</span>
}</code></pre></div>
<p>We don’t need to parse the command-line options ourselves, nor use any modules such as <a href="https://metacpan.org/pod/Getopt::Long">Getopt::Long</a> to do it for us. Moreover, Raku emits &ldquo;usage&rdquo; help text if the program is run with incorrect or missing arguments:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ ./covid.raku
Usage:
  ./covid.raku population
  ./covid.raku fetch
  ./covid.raku generate</code></pre></div>
<p>Salve J. Nilsen <a href="https://github.com/ash/covid.observer/pull/5">proposed to add</a> another <code>MAIN</code> function that prints the SQL commands for initializing the database. This example shows how how to define Boolean flags for command line options:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">multi <span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">MAIN</span>(&#39;setup&#39;, Bool :$force=False, Bool :$verbose=False) {
    <span style="color:#f92672">.</span> <span style="color:#f92672">.</span> <span style="color:#f92672">.</span>
}</code></pre></div>
<p>Note the <code>:</code> before the parameter name. We’ll see it again later.</p>

<p>An additional POD comment can be added before each version of the function to print a better usage description, for example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#| Fetch the latest data and rebuild the database</span>
multi <span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">MAIN</span>(&#39;fetch&#39;) {
    <span style="color:#f92672">.</span> <span style="color:#f92672">.</span> <span style="color:#f92672">.</span>
}</code></pre></div>
<p>Now the program prints a more helpful usage message:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Usage:
  ./covid.raku population -- Parse population CSV files
  ./covid.raku fetch -- Fetch the latest data and rebuild the database
  ./covid.raku generate -- Generate the website</code></pre></div>
<h2 id="reduction-operators">Reduction operators</h2>

<p>Reduction operators are really useful. Let me remind you what a reduction operator is. It&rsquo;s actually a meta-operator: an infix operator surrounded by square brackets.</p>

<p>In the program the reduction operator is widely used for computing totals across the data sets (e.g. for the World, or across Chinese provinces). Let us examine a few cases of increasing complexity:</p>

<p>First there’s a simple hash, and we need to add up its values:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> %data <span style="color:#f92672">=</span>
    IT <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">59_138</span>,
    CN <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">81_397</span>,
    ES <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">28_768</span>;

<span style="color:#66d9ef">my</span> $total <span style="color:#f92672">=</span> [<span style="color:#f92672">+</span>] %data<span style="color:#f92672">.</span>values;
say $total; <span style="color:#75715e"># 169303</span></code></pre></div>
<p>This is the classic use case for the reduction operator. What I <a href="https://andrewshitov.com/2020/03/16/a-couple-of-syntax-sweets-in-raku/">noticed</a> during the work is that the <code>[-]</code> construct helps when you need to reduce some value by a few other values:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> %data <span style="color:#f92672">=</span>
    confirmed <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">100</span>,
    failed    <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1</span>,
    recovered <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">70</span>;

<span style="color:#66d9ef">my</span> $active <span style="color:#f92672">=</span> [<span style="color:#f92672">-</span>] %data<span style="color:#f92672">&lt;</span>confirmed recovered failed<span style="color:#f92672">&gt;</span>;
say <span style="color:#e6db74">&#34;$active active cases&#34;</span>;</code></pre></div>
<p>Using a hash slice in the form of <code>%h&lt;a b c&gt;</code> also helps to make the code more compact. Compare this with the straightforward approach:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> $active <span style="color:#f92672">=</span> %data<span style="color:#e6db74">&lt;confirmed&gt;</span> <span style="color:#f92672">-</span> %data<span style="color:#e6db74">&lt;failed&gt;</span> <span style="color:#f92672">-</span> %data<span style="color:#e6db74">&lt;recovered&gt;</span>;</code></pre></div>
<h2 id="filtering-data">Filtering data</h2>

<p>For our second case, the hash values are not scalars but hashes themselves. The <code>&gt;&gt;</code> hyperoperator can be used to extract deeply located data. Let me demonstrate this on a simplified data fragment:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> %data <span style="color:#f92672">=</span>
    IT <span style="color:#f92672">=&gt;</span> {
        confirmed <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">59_138</span>,
        population <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">61</span>, <span style="color:#75715e"># millions</span>
    },
    CN <span style="color:#f92672">=&gt;</span> {
        confirmed <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">81_397</span>,
        population <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">1434</span>
    },
    ES <span style="color:#f92672">=&gt;</span> {
        confirmed <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">28_768</span>,
        population <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">47</span>,
    };

<span style="color:#66d9ef">my</span> $total <span style="color:#f92672">=</span> [<span style="color:#f92672">+</span>] %data<span style="color:#f92672">.</span>values<span style="color:#f92672">&gt;&gt;</span><span style="color:#e6db74">&lt;confirmed&gt;</span>;
say $total; <span style="color:#75715e"># 169303</span></code></pre></div>
<p>An alternative and cleaner way is using the <code>map</code> method to access the data:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> $total2 <span style="color:#f92672">=</span> [<span style="color:#f92672">+</span>] %data<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>map: <span style="color:#f92672">*</span><span style="color:#e6db74">&lt;confirmed&gt;</span>;
say $total2; <span style="color:#75715e"># 169303</span></code></pre></div>
<p>Finally, to exclude a country from the results, you can <code>grep</code> the keys in-place:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> %x <span style="color:#f92672">=</span> %data<span style="color:#f92672">.</span>grep: <span style="color:#f92672">*.</span>key <span style="color:#f92672">ne</span> <span style="color:#e6db74">&#39;CN&#39;</span>;
<span style="color:#66d9ef">my</span> $excl2 <span style="color:#f92672">=</span> [<span style="color:#f92672">+</span>] %x<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>map: <span style="color:#f92672">*</span><span style="color:#e6db74">&lt;confirmed&gt;</span>;
say $excl2; <span style="color:#75715e"># 87906</span></code></pre></div>
<p>Notice that calling the hash&rsquo;s <code>grep</code> method is much handier than trying to loop over the keys and filter them:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> $excluding<span style="color:#f92672">-</span>china <span style="color:#f92672">=</span>
    [<span style="color:#f92672">+</span>] %data{%data<span style="color:#f92672">.</span>keys<span style="color:#f92672">.</span>grep: <span style="color:#f92672">*</span> <span style="color:#f92672">ne</span> <span style="color:#e6db74">&#39;CN&#39;</span>}<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>map: <span style="color:#f92672">*</span><span style="color:#e6db74">&lt;confirmed&gt;</span>;
say $excluding<span style="color:#f92672">-</span>china; <span style="color:#75715e"># 87906</span></code></pre></div>
<h2 id="hyper-operators">Hyper operators</h2>

<p>In the previous section I showed how to apply the same action to each element of a list using <code>&gt;&gt;</code>. Now let us take a look at a real example of how I used the hyper operator <code>&gt;&gt;-&gt;&gt;</code> to compute the deltas of number series:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> @confirmed <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">40</span>, <span style="color:#ae81ff">70</span>, <span style="color:#ae81ff">150</span>;
<span style="color:#66d9ef">my</span> @delta <span style="color:#f92672">=</span> @confirmed[<span style="color:#ae81ff">1</span><span style="color:#f92672">..*</span>] <span style="color:#f92672">&gt;&gt;-&gt;&gt;</span> @confirmed;
say @delta; <span style="color:#75715e"># [10 20 30 80]</span></code></pre></div>
<p>The array contains a series of values for the given period of time. The task is to compute how many new cases happen in each day. Instead of using a loop, it is possible to simply ‘subtract‘ an array from itself but shifted by one element.</p>

<p>The <code>&gt;&gt;-&gt;&gt;</code> operator takes two data series: the slice <code>@confirmed[1..*]</code> of the original data without the first element, and the original <code>@confirmed</code> array. For a given binary operator (<code>-</code> in this example), you can construct four hyper operators: <code>&gt;&gt;-&lt;&lt;</code>, <code>&gt;&gt;-&gt;&gt;</code>, <code>&lt;&lt;-&gt;&gt;</code>, <code>&lt;&lt;-&lt;&lt;</code>. The chosen form allows us to ignore the extra item at the end of <code>@confirmed</code> when it is applied against <code>@confirmed[1..*]</code>.</p>

<h2 id="junctions">Junctions</h2>

<p>Let me demonstrate a way of using the junction operator <code>|</code> which I discovered recently. It chooses the ending for the given ordinal number:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">for</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">..</span><span style="color:#ae81ff">31</span> <span style="color:#f92672">-&gt;</span> $day {
    <span style="color:#66d9ef">my</span> $ending <span style="color:#f92672">=</span> <span style="color:#66d9ef">do</span> given $day {
        when <span style="color:#ae81ff">1</span><span style="color:#f92672">|</span><span style="color:#ae81ff">21</span><span style="color:#f92672">|</span><span style="color:#ae81ff">31</span> {<span style="color:#e6db74">&#39;st&#39;</span>}
        when <span style="color:#ae81ff">2</span><span style="color:#f92672">|</span><span style="color:#ae81ff">22</span>    {<span style="color:#e6db74">&#39;nd&#39;</span>}
        when <span style="color:#ae81ff">3</span><span style="color:#f92672">|</span><span style="color:#ae81ff">23</span>    {<span style="color:#e6db74">&#39;rd&#39;</span>}
        default      {<span style="color:#e6db74">&#39;th&#39;</span>}
    }

    say <span style="color:#e6db74">&#34;$day$ending&#34;</span>;
}</code></pre></div>
<p>The <code>when</code> blocks catch the corresponding numbers that need special endings. Junctions such as <code>1|21|31</code> are more elegant than a regular expression or a chain of comparisons.</p>

<h2 id="optional-and-named-parameters">Optional and named parameters</h2>

<p>Parameter processing is simple in Raku. This function accepts two positional hash parameters:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">chart</span>-daily(%countries, %totals) {
    <span style="color:#f92672">.</span> <span style="color:#f92672">.</span> <span style="color:#f92672">.</span>
}</code></pre></div>
<p>I can easily add optional named parameters:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">sub</span> <span style="color:#a6e22e">chart</span>-daily(%countries, %totals, :$cc?, :$cont?, :$exclude?) {
   <span style="color:#f92672">.</span> <span style="color:#f92672">.</span> <span style="color:#f92672">.</span>
}</code></pre></div>
<p>A colon before the name makes the parameter named, and the question mark makes it optional. I am using this to modify the behavior of the same statistical function for aggregating data over the whole World, the continents, or to exclude a single country or a region:</p>

<p>Generating data for the whole World:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">chart<span style="color:#f92672">-</span>daily(%countries, %per<span style="color:#f92672">-</span>day);</code></pre></div>
<p>For a single country:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> $cc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;CN&#39;</span>;
chart<span style="color:#f92672">-</span>daily(%countries, %per<span style="color:#f92672">-</span>day, :$cc);</code></pre></div>
<p>For a continent:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> $cont <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Europe&#39;</span>;
chart<span style="color:#f92672">-</span>daily(%countries, %per<span style="color:#f92672">-</span>day, :$cont);</code></pre></div>
<p>World data excluding China:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">chart<span style="color:#f92672">-</span>daily(%countries, %per<span style="color:#f92672">-</span>day, exclude <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;CN&#39;</span>);</code></pre></div>
<p>Getting data for China without its most affected province:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl">chart<span style="color:#f92672">-</span>daily(%countries, %per<span style="color:#f92672">-</span>day, cc <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;CN&#39;</span>, exclude <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#39;CN/HB&#39;</span>);</code></pre></div>
<h2 id="a-built-in-template-engine">A built-in template engine</h2>

<p>The project generates more than 200 HTML files, so templating is an important part of it. Fortunately Raku has a great out-of-the-box templating mechanism, which is much more powerful than simple variable interpolation.</p>

<p>A minimal example is substituting variables:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">return</span> qq:to<span style="color:#e6db74">/HTML/</span>;
    <span style="color:#f92672">&lt;</span>div id<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;countries-list&#34;</span><span style="color:#f92672">&gt;</span>
        $html
    <span style="color:#e6db74">&lt;/div&gt;</span>
    HTML</code></pre></div>
<p>By the way, notice that Raku lets you keep the indentation of a multi-line string by simply indenting its closing symbol. No extra spaces at the beginning of the lines will appear in the result.</p>

<p>A more exciting thing is that you can embed Raku code blocks into strings, and those blocks can contain any logic you need to make a right decision somewhere in the middle of the template:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#66d9ef">my</span> $content <span style="color:#f92672">=</span> qq:to<span style="color:#e6db74">/HTML/</span>;
    <span style="color:#e6db74">&lt;h1&gt;</span>Coronavirus in {$country<span style="color:#f92672">-</span>name}<span style="color:#e6db74">&lt;/h1&gt;</span>

    <span style="color:#f92672">&lt;</span>div class<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;affected&#34;</span><span style="color:#f92672">&gt;</span>
        {
            <span style="color:#66d9ef">if</span> $chart2data<span style="color:#e6db74">&lt;confirmed&gt;</span> {
                <span style="color:#e6db74">&#39;Affected 1 of every &#39;</span> <span style="color:#f92672">~</span>
                    fmtnum((<span style="color:#ae81ff">1_000_000</span> <span style="color:#f92672">*</span> $population <span style="color:#f92672">/</span>
                        $chart2data<span style="color:#e6db74">&lt;confirmed&gt;</span>)<span style="color:#f92672">.</span>round())
            }
            <span style="color:#66d9ef">else</span> {
                <span style="color:#e6db74">&#39;Nobody affected&#39;</span>
            }
        }
    <span style="color:#e6db74">&lt;/div&gt;</span>
    HTML</code></pre></div>
<p>Here, the string builds itself depending on data. For each generated country, the string ’chooses‘ which phrase to embed and how to format the number. The <code>if</code> block is a relatively big chunk of Raku code that generates a string, which is used in place of the whole block in curly braces. Thus, inside this embedded code block you can freely manipulate data from the outside code.</p>

<h2 id="afterword">Afterword</h2>

<p>I must say that it is quite exciting to use Raku for a real project. As you can see from the examples, many of its ‘strange‘ features demonstrate how useful they are in different circumstances. Examine the code in the <a href="https://github.com/ash/covid.observer">GitHub repository</a> and follow the updates about the site <a href="https://andrewshitov.com/category/covid-19/">on my blog</a>.</p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/raku">raku</a></div>
                
                  <div class="tag"><a href="/tags/covid-19">covid-19</a></div>
                
                  <div class="tag"><a href="/tags/data-processing">data-processing</a></div>
                
                  <div class="tag"><a href="/tags/csv">csv</a></div>
                
                  <div class="tag"><a href="/tags/johns-hopkins">johns-hopkins</a></div>
                
                  <div class="tag"><a href="/tags/perl6">perl6</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-andrew-shitov">
  <div class="col-sm-2">
    
    <a href="/authors/andrew-shitov/"><div class="circle-avatar" style="background-image:url(/images/author/andrew-shitov.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/andrew-shitov/"><h3>Andrew Shitov</h3></a>
    <p>Andrew is a Perl 6 and Raku enthusiast since around 2000, an author of <a href="https://andrewshitov.com/2020/01/29/my-open-perl-6-and-raku-books/">a number of books</a>, and the organiser or a lot of <a href="http://yapcrussia.org/">Perl and Raku events</a>, including three <a href="https://perlcon.eu/about">annual European conferences</a>. Currently working on his new book <em><a href="https://andrewshitov.com/creating-a-compiler-with-raku/">Creating a Compiler with Raku</a></em>.</p>
    <h5><a href="/authors/andrew-shitov/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/article/observing-coronavirus-with-raku.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

