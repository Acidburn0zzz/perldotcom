<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> Fork yeah! Part 2 </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="More concurrency patterns with fork"/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/article/fork-yeah-part-2/" />
<meta property="og:title" content="Fork yeah! Part 2" />
<meta property="og:description" content="More concurrency patterns with fork">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2019-04-04T04:04:04Z" />
<meta property="og:image" content="http://localhost:1313/images/fork-yeah-part-2/thumb_forkyeah-2.png" />
<meta property="og:article:tag" content="fork" />
<meta property="og:article:tag" content="concurrency" />
<meta property="og:article:tag" content="waitpid" />
<meta property="og:article:tag" content="posix" />
<meta property="og:article:tag" content="wnohang" />
<meta property="og:article:tag" content="wuntraced" />
<meta property="og:article:tag" content="wifstopped" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">Fork yeah! Part 2</h1>
              <p class="blog-post-meta">Apr 27, 2019 by
              
              
                
                
                <a href="#author-bio-david-farrell">David Farrell</a>
              
              </p>
              <img alt="" src="/images/fork-yeah-part-2/forkyeah-2.png"/>
                

<p>In <a href="/article/fork-yeah-/">part one</a> of this article I described how to use Perl&rsquo;s <code>fork</code> function to write concurrent programs. Here are a couple of other ways.</p>

<h2 id="wnohang">WNOHANG</h2>

<p>Usually <code>waitpid</code> is a blocking call which returns when a child process exits:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/perl</span>

<span style="color:#66d9ef">my</span> $pid <span style="color:#f92672">=</span> fork;

<span style="color:#66d9ef">if</span> ($pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
  sleep <span style="color:#ae81ff">1</span>;
  exit;
}

waitpid $pid, <span style="color:#ae81ff">0</span>;</code></pre></div>
<p>In this example the second argument to <code>waitpid</code> is 0, which is the flags <a href="https://perldoc.perl.org/functions/waitpid.html">argument</a>. But what if we wanted to do additional processing in the parent process, whilst still occasionally checking for reaped children?</p>

<p>The <a href="https://metacpan.org/pod/POSIX">POSIX</a> module includes the <code>WNOHANG</code> constant which makes the <code>waitpid</code> call non-blocking. Instead it returns immediately with an integer:</p>

<ul>
<li>-1 indicates no child process exists for that process id, or none at all if pid of -1 was supplied</li>
<li>0 indicates there is a child process but it has not changed state yet</li>
<li>2-32768 is the pid of the child process which exited (it will never be 1 - that&rsquo;s <a href="https://en.wikipedia.org/wiki/Init">init</a>)</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/perl</span>
<span style="color:#66d9ef">use</span> POSIX <span style="color:#e6db74">&#39;WNOHANG&#39;</span>;

<span style="color:#66d9ef">my</span> $pid <span style="color:#f92672">=</span> fork;

<span style="color:#66d9ef">if</span> ($pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
  sleep <span style="color:#ae81ff">1</span>;
  exit;
}

<span style="color:#66d9ef">my</span> $kid;
<span style="color:#66d9ef">do</span> {
  <span style="color:#75715e"># do additional processing</span>
  sleep <span style="color:#ae81ff">1</span>;

  $kid <span style="color:#f92672">=</span> waitpid <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, WNOHANG;
} <span style="color:#66d9ef">while</span> ($kid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>);</code></pre></div>
<p>I&rsquo;ve changed the code to wait for the child to exit in a <code>do</code> <code>while</code> loop, each iteration calling <code>waitpid</code> with <code>WNOHANG</code> to allow me to undertake any additional processing I want to in the body of the <code>do</code> block. Without <code>WNOHANG</code>, this would loop once per reaped child; with it, I can still collect exiting child processes, but the loop may iterate thousands of times in the meantime.</p>

<h2 id="wuntraced">WUNTRACED</h2>

<p>The POSIX module provides <a href="https://metacpan.org/pod/POSIX#WAIT">waitpid</a> constants and macros. The other constant is <code>WUNTRACED</code> which causes <code>waitpid</code> to return if the child process is stopped (but not exited).</p>

<p>The parent can then take appropriate action: it might record the stopped process somewhere, or choose to resume the child by sending it a continue signal (SIGCONT):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/perl</span>
<span style="color:#66d9ef">use</span> POSIX <span style="color:#e6db74">&#39;:sys_wait_h&#39;</span>;
$SIG{INT} <span style="color:#f92672">=</span> <span style="color:#66d9ef">sub</span> { exit };

<span style="color:#66d9ef">my</span> $pid <span style="color:#f92672">=</span> fork;

<span style="color:#66d9ef">if</span> ($pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
  <span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;child going to sleep\n&#34;</span>;
    sleep <span style="color:#ae81ff">10</span>;
  }
}

<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;child PID: $pid\n&#34;</span>;
<span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
  <span style="color:#66d9ef">my</span> $kid <span style="color:#f92672">=</span> waitpid $pid, WUNTRACED;

  <span style="color:#66d9ef">if</span> (WIFSTOPPED(${<span style="color:#f92672">^</span>CHILD_ERROR_NATIVE})) {
    <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;sending SIGCONT to child\n&#34;</span>;
    kill <span style="color:#e6db74">&#39;CONT&#39;</span>, $kid;
  }
  <span style="color:#66d9ef">else</span> {
    exit;
  }
}</code></pre></div>
<p>I&rsquo;ve used the group <code>sys_wait_h</code> to import multiple symbols from the POSIX module. This time, both child and parent are in infinite while loops. If I pause the child by sending it SIGSTOP, <code>waitpid</code> will return. The parent tests whether the child was stopped with the macro <code>WIFSTOPPED</code>, if so it sends SIGCONT to the child via <code>kill</code>, resuming it.</p>

<p>Running the script as <code>wuntraced.pl</code>:</p>

<pre><code>$ ./wuntraced.pl
child PID: 15013
child going to sleep
</code></pre>

<p>In another terminal I send SIGSTOP to the child:</p>

<pre><code>kill -s STOP 15013
</code></pre>

<p>And the parent resumes the child:</p>

<pre><code>sending SIGCONT to child
child going to sleep
</code></pre>

<p>Both processes keep running until I send SIGINT to the child:</p>

<pre><code>$ kill -s INT 15013
</code></pre>

<h2 id="combining-constants">Combining Constants</h2>

<p>WNOHANG and WUNTRACED are not mutually exclusive: I can change waitpid&rsquo;s behavior by combining both constants into a single flag value with binary or (<code>|</code>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-perl" data-lang="perl"><span style="color:#75715e">#!/usr/bin/perl</span>
<span style="color:#66d9ef">use</span> Data::Dumper <span style="color:#e6db74">&#39;Dumper&#39;</span>;
<span style="color:#66d9ef">use</span> POSIX <span style="color:#e6db74">&#39;:sys_wait_h&#39;</span>;

$SIG{INT} <span style="color:#f92672">=</span> <span style="color:#66d9ef">sub</span> { exit };
<span style="color:#66d9ef">my</span> %pids;

<span style="color:#66d9ef">for</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">..</span><span style="color:#ae81ff">3</span>) {
  <span style="color:#66d9ef">my</span> $pid <span style="color:#f92672">=</span> fork;
  <span style="color:#66d9ef">if</span> ($pid <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>) {
    sleep <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">while</span> <span style="color:#ae81ff">1</span>;
  }
  <span style="color:#66d9ef">else</span> {
    $pids{$pid} <span style="color:#f92672">=</span> {
      duration <span style="color:#f92672">=&gt;</span> undef,
      started  <span style="color:#f92672">=&gt;</span> time,
      stops    <span style="color:#f92672">=&gt;</span> <span style="color:#ae81ff">0</span>,
    };
  }
}

<span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>) {
  <span style="color:#66d9ef">my</span> $kid <span style="color:#f92672">=</span> waitpid <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, WNOHANG <span style="color:#f92672">|</span> WUNTRACED;

  <span style="color:#75715e"># do additional processing</span>
  <span style="color:#66d9ef">print</span> Dumper(<span style="color:#f92672">\</span>%pids);
  sleep <span style="color:#ae81ff">3</span>;

  <span style="color:#66d9ef">if</span> (WIFSTOPPED(${<span style="color:#f92672">^</span>CHILD_ERROR_NATIVE})) {
    $pids{$kid}<span style="color:#f92672">-&gt;</span>{stops}<span style="color:#f92672">++</span>;
    kill <span style="color:#e6db74">&#39;CONT&#39;</span>, $kid;
  }
  <span style="color:#66d9ef">elsif</span> ($kid <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) {
    <span style="color:#66d9ef">my</span> $exit_time <span style="color:#f92672">=</span> time;
    $pids{$kid}<span style="color:#f92672">-&gt;</span>{duration} <span style="color:#f92672">=</span> $exit_time <span style="color:#f92672">-</span> $pids{$kid}<span style="color:#f92672">-&gt;</span>{started};
  }
  <span style="color:#66d9ef">elsif</span> ($kid <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
    exit;
  }
}</code></pre></div>
<p>This code forks 3 children which run forever, and the parent tracks statistics for each child: the start time, duration and number of times it received SIGSTOP. The parent will resume any stopped child with SIGCONT. The parent prints the stats every 3 seconds, and exits when all the children have exited.</p>

<p>Running this code, I can play around by sending SIGSTOP and SIGINT to different child processes and watch the stats update. Although this is a simple example, by using <code>WNOHANG</code> and <code>WUNTRACED</code> you can see how they change the parent process&rsquo;s role from a passive observer to a supervisor which can actively manage its sub-processes.</p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/development">development</a></div>
                
                  <div class="tag"><a href="/tags/fork">fork</a></div>
                
                  <div class="tag"><a href="/tags/concurrency">concurrency</a></div>
                
                  <div class="tag"><a href="/tags/waitpid">waitpid</a></div>
                
                  <div class="tag"><a href="/tags/posix">posix</a></div>
                
                  <div class="tag"><a href="/tags/wnohang">wnohang</a></div>
                
                  <div class="tag"><a href="/tags/wuntraced">wuntraced</a></div>
                
                  <div class="tag"><a href="/tags/wifstopped">wifstopped</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-david-farrell">
  <div class="col-sm-2">
    
    <a href="/authors/david-farrell/"><div class="circle-avatar" style="background-image:url(/images/author/david-farrell.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/david-farrell/"><h3>David Farrell</h3></a>
    <p>David is the editor of Perl.com. An organizer of the <a href="http://www.meetup.com/The-New-York-Perl-Meetup-Group/">New York Perl Meetup</a>, he works for ZipRecruiter as a software developer, and sometimes <a href="https://twitter.com/perltricks">tweets</a> about Perl and Open Source.</p>
    <h5><a href="/authors/david-farrell/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/article/fork-yeah-part-2.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

