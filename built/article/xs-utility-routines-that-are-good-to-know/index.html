<!DOCTYPE html>
<html lang="en-us">
  <head>
  <title> XS utility routines that are good to know </title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="XS functions you&#39;ll use again and again"/>
  <meta name="robots" content="index, follow">
  <meta name="google-site-verification" content="TZowffo_LX2mmsw2DbeNNbukCMnIOA8T-6CMJPiYllI" />

<meta property="twitter:card" content="summary">
<meta property="twitter:site" content="@PerlFoundation">
<meta property="og:url" content="http://localhost:1313/article/xs-utility-routines-that-are-good-to-know/" />
<meta property="og:title" content="XS utility routines that are good to know" />
<meta property="og:description" content="XS functions you&#39;ll use again and again">
<meta property="og:site_name" content="Perl.com" />

<meta property="og:type" content="article" />
<meta property="og:article:published_time" content="2018-04-04T04:04:04Z" />
<meta property="og:image" content="http://localhost:1313/images/xs-utility-routines-that-are-good-to-know/thumb_plumbing-tools.jpg" />
<meta property="og:article:tag" content="xs" />
<meta property="og:article:tag" content="utf8" />
<meta property="og:article:tag" content="libpostal" />
<meta property="og:article:tag" content="tie" />
<meta property="og:article:tag" content="boot" />


  <link rel="icon" href="/favicon.ico">
  <link href="/article/index.xml" rel="alternate" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/article/index.xml" rel="feed" type="application/rss+xml" title="Perl.com - programming news, code and culture" />
  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="/css/perldotcom.css"/>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-50555-22', 'auto');
ga('create', 'UA-85734801-2', 'auto', 'editor');
ga('send', 'pageview');
ga('editor.send', 'pageview');
</script>

</head>
<body>

<div class="container-fluid full-wdith antonio">
 <div class="row">
  <div class="navbar-inverse" style="border-radius:none !important" role="navigation">
    <div class="container-fluid">
      <ul class="nav navbar-nav pull-right follow">
          <li>MORE:</li>
          <li><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a><li>
          <li><a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a><li>
          <li><a href="/article/index.xml" />
              <img src="/images/site/rss_20.png" alt="rss"></a></li>
          <li><a href="https://github.com/tpf/perldotcom" />
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></li>
      </ul>
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
          <a class="navbar-nav" href="/">
            <div class="header-logo">Perl.com</div>
          </a>
      </div>
      <div class="navbar-collapse collapse">
        <ul class="nav navbar-nav">
          <li><a href="/about">
              <div class="circle">
                <img src="/images/site/perl-camel.png" alt="" />
              </div>
                  &nbsp;&nbsp;ABOUT</a>
          </li>
          <li><a href="/authors">
              <div class="circle">
                  <span class="glyphicon glyphicon-user txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;AUTHORS</a>
          </li>
          <li><a href="/categories">
              <div class="circle">
                  <span class="glyphicon glyphicon-folder-open txt-blue-major" aria-hidden="true"></span>
              </div>
                  &nbsp;&nbsp;CATEGORIES</a>
          </li>
          <li><a href="/tags">
              <div class="circle">
                <span class="txt-blue-major" aria-hidden="true"><strong>#</strong></span>
              </div>
                  &nbsp;&nbsp;TAGS</a>
          </li>
          <li>
            <form class="search" name="ddg" action="https://duckduckgo.com/" method="get">
              <input type="text" name ="q" placeholder="SEARCH" />
              <input type="hidden" value="perl.com" name="sites" />
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
 </div>
</div>


  <section id="content" role="main">
    <section class="entry-content">
      <div class="container">
        <div class="row">
          <div class="col-md-9">
            <div class="row">
              <article class="fulltext">
              <h1 class="blog-post-title">XS utility routines that are good to know</h1>
              <p class="blog-post-meta">Apr 30, 2018 by
              
              
                
                
                <a href="#author-bio-david-farrell">David Farrell</a>
              
              </p>
              <img alt="" src="/images/xs-utility-routines-that-are-good-to-know/plumbing-tools.jpg"/>
                

<p>In the previous <a href="/article/writing-your-own-xs-functions/">tutorial</a>, we learned how to write our own functions in XS, how to process multiple arguments, and return different values, including <code>undef</code>.</p>

<p>In this tutorial I&rsquo;m going to cover some useful routines for common cases you&rsquo;ll encounter when programming in XS. One that you&rsquo;ve already seen is <code>SvOK</code> which can tell you if a scalar is defined or not. Here are the new areas I&rsquo;ll discuss:</p>

<ul>
<li>Scheduling XS code to run at startup</li>
<li>Handling tied variables</li>
<li>Unicode tools</li>
</ul>

<p>When writing XS code, these are things you&rsquo;ll often want to be aware of, and know how to handle.</p>

<h3 id="module-code">Module Code</h3>

<p>As before, we&rsquo;ll define the module code to load our XS. This is all that&rsquo;s required:</p>

<pre><code>package XS::Tutorial::Three;
require XSLoader;

XSLoader::load();
1;
</code></pre>

<p>That should be saved as <code>lib/XS/Tutorial/Three.pm</code>.</p>

<h3 id="xs-code">XS Code</h3>

<p>The top of the XS file will look similar to the previous chapter:</p>

<pre><code>#define PERL_NO_GET_CONTEXT // we'll define thread context if necessary (faster)
#include &quot;EXTERN.h&quot;         // globals/constant import locations
#include &quot;perl.h&quot;           // Perl symbols, structures and constants definition
#include &quot;XSUB.h&quot;           // xsubpp functions and macros

MODULE = XS::Tutorial::Three  PACKAGE = XS::Tutorial::Three
PROTOTYPES: ENABLE
</code></pre>

<p>Remember to append any XS code after the <code>PROTOTYPES</code> line. This should be saved as <code>lib/XS/Tutorial/Three.xs</code>.</p>

<h3 id="scheduling-xs-code-to-run-at-startup">Scheduling XS code to run at startup</h3>

<p>Sometimes you&rsquo;ll need to run some code before your XS functions can work. For example, <a href="https://github.com/openvenues/libpostal">libpostal</a> has startup routines which populate data structures that must be called before the library can be used.</p>

<p>You could code this in a &ldquo;lazy&rdquo; way, that is, inside the XS function, check to see if the init code has been run, and if not, run it before executing the rest of the function code.</p>

<p>However XS offers another way to do it by using the <code>BOOT</code> keyword. Any C code included below the keyword, will be executed during the startup process:</p>

<pre><code>BOOT:
printf(&quot;We're starting up!\n&quot;);
</code></pre>

<p>The boot section is terminated by the first empty line after the keyword.</p>

<h3 id="handling-tied-variables">Handling tied variables</h3>

<p>Tied variables are special variables that execute custom code when they are interacted with. But you never use them, so why worry about them? The
thing is if you&rsquo;re writing code to be used by others, you can&rsquo;t be sure that a caller won&rsquo;t pass a tied variable to one of your XS functions. And unlike
regular Perl, XS does <strong>not</strong> execute tied code automatically.</p>

<p>XS does provide <a href="https://perldoc.perl.org/perlapi.html#Magical-Functions">functions</a> for working with tied variables though. One you&rsquo;ll see in a lot of XS code is <code>SvGETMAGIC</code>. Imagine your function is passed a tied variable; it&rsquo;s value will be undefined in XS, until you call <code>mg_get</code> (&ldquo;magic get&rdquo;) on it, which calls <code>FETCH</code>.</p>

<p>Unfortunately, <code>mg_get</code> can only be called on tied scalars so you don&rsquo;t want to call it on a regular scalar. That&rsquo;s where <code>SvGETMAGIC</code> comes in: if the scalar is
tied, it will call <code>mg_get</code>, if not, nothing will happen.</p>

<p>Here&rsquo;s how you might use it:</p>

<pre><code>SV*
get_tied_value(SV *foo)

PPCODE:
  /* call FETCH() if it's a tied variable to populate the sv */
  SvGETMAGIC(foo);
  PUSHs(sv_2mortal(foo));
</code></pre>

<p>This code declares an XS function called <code>get_tied_value</code>, which accepts a scalar variable, and calls <code>SvGETMAGIC</code> on it, returning the value, by pushing it onto the stack.</p>

<h4 id="magic">Magic?</h4>

<p>You might be wondering why functions dealing with tied variables are named &ldquo;magic&rdquo; or &ldquo;mg&rdquo;. The reason is that tied behavior for each variable is implemented via a pointer to a <a href="https://perldoc.perl.org/perlguts.html#Magic-Virtual-Tables">magic virtual table</a> which is a structure containing function pointers to the tied behavior.</p>

<p>Often the Perl C API will provide <code>mg</code> (&ldquo;magic&rdquo;) and <code>nomg</code> (&ldquo;non magic&rdquo;) variants of functions, so you can decide if you want to trigger the tied behavior.</p>

<h3 id="utf-8-tools">UTF-8 tools</h3>

<p>Perl has loads of tools for managing UTF-8 encoded text, but with XS you&rsquo;re working in C, which does not. Start thinking about basic types like <code>char</code>
and common assumptions in C code, and you&rsquo;ll realize that multibyte characters can wreak havoc unless you handle them correctly.</p>

<p>Fortunately, the Perl C API does provide <a href="https://perldoc.perl.org/perlapi.html#Unicode-Support">functions</a> for managing UTF-8 data that
can help. Here are a couple of examples.</p>

<p>Perl scalars have a UTF-8 flag, which is turned on when the scalar contains decoded UTF-8 data. We can detect it with <code>SvUTF8</code>:</p>

<pre><code>SV*
is_utf8(SV *foo)
PPCODE:
  /* if the UTF-8 flag is set return 1 &quot;true&quot; */
  if (SvUTF8(foo)) {
    PUSHs(sv_2mortal(newSViv(1)));
  }
  /* else return undef &quot;false&quot; */
  else {
    PUSHs(sv_newmortal());
  }
</code></pre>

<p>This declares an XS function called <code>is_utf8</code> which accepts a scalar and returns true if the UTF-8 flag is set, or false if it isn&rsquo;t.</p>

<p>Imagine you have some C code that only works with ASCII text, that is, single byte characters. You can detect incoming scalars that have the UTF-8 flag turned on
with <code>SvUTF8</code>, but what do you do about ones that have the flag?</p>

<p>You could <code>croak</code> immediately, throwing an exception. Or you could try to <em>downgrade</em> the scalar to be non UTF-8 as the string may be marked as UTF-8 but only contain ASCII compatible characters (decimal values 0-127).</p>

<pre><code>SV*
is_downgradeable(SV *foo)
PPCODE:
  /* if the UTF-8 flag is set and the scalar is not downgrade-able return
     undef */
  if (SvUTF8(foo) &amp;&amp; !sv_utf8_downgrade(foo, TRUE)) {
    PUSHs(sv_newmortal());
  }
  /* else return 1 */
  else {
    PUSHs(sv_2mortal(newSViv(1)));
  }
</code></pre>

<p>This function returns false if the scalar contains data that is not downgrade-able to ASCII, otherwise it returns true. It does that by using the <code>sv_utf8_downgrade</code> function, which accepts the scalar and a boolean value indicating if it&rsquo;s ok to fail. As the second argument is <code>TRUE</code>, the function simply returns false if the scalar is not downgrade-able (otherwise it would <code>croak</code>).</p>

<h3 id="references">References</h3>

<ul>
<li>Parts <a href="/article/getting-started-with-xs/">one</a> and <a href="/article/writing-your-own-xs-functions/">two</a> in this series contain the background information necessary to understand this one</li>
<li>This series is also on CPAN (<a href="https://metacpan.org/pod/XS::Tutorial">XS::Tutorial</a>) complete with all the code</li>
<li>The <a href="https://perldoc.perl.org/perlxs.html#The-BOOT%3a-Keyword">BOOT</a> keyword</li>
<li>Tied variable <a href="https://perldoc.perl.org/perlapi.html#Magical-Functions">functions</a> and the <a href="https://perldoc.perl.org/perlguts.html#Magic-Virtual-Tables">magic virtual table</a></li>
<li><a href="https://perldoc.perl.org/perlapi.html#Unicode-Support">Perl UTF-8 functions</a></li>
</ul>

<p><br />
Cover image &copy; <a href="https://pixabay.com/en/plumbing-pipe-wrench-plumber-840835/">Steve Buissinne</a></p>

              </article>
              <p><strong>Tags</strong></p>
              <div class="tags">
                <div class="category"><a href="/categories/tutorials">tutorials</a></div>
                
                  <div class="tag"><a href="/tags/xs">xs</a></div>
                
                  <div class="tag"><a href="/tags/utf8">utf8</a></div>
                
                  <div class="tag"><a href="/tags/libpostal">libpostal</a></div>
                
                  <div class="tag"><a href="/tags/tie">tie</a></div>
                
                  <div class="tag"><a href="/tags/boot">boot</a></div>
                
              </div>
            </div>
            
              
                
<div class="row" id="author-bio-david-farrell">
  <div class="col-sm-2">
    
    <a href="/authors/david-farrell/"><div class="circle-avatar" style="background-image:url(/images/author/david-farrell.jpg)"></div></a>
  </div>
  <div class="col-sm-10">
    <a href="/authors/david-farrell/"><h3>David Farrell</h3></a>
    <p>David is the editor of Perl.com. An organizer of the <a href="http://www.meetup.com/The-New-York-Perl-Meetup-Group/">New York Perl Meetup</a>, he works for ZipRecruiter as a software developer, and sometimes <a href="https://twitter.com/perltricks">tweets</a> about Perl and Open Source.</p>
    <h5><a href="/authors/david-farrell/">Browse their articles</a></h5>
  </div>
</div>

            
            <div class="row">
              <h3>Feedback</h3>
              <p>Something wrong with this article? Help us out by opening an issue or pull request on <a href="https://github.com/tpf/perldotcom/blob/master/content/article/xs-utility-routines-that-are-good-to-know.md">GitHub</a></p>
            </div>
          </div>
          <div class="col-md-3">
            <div class="latest-sidebar">

  <div class="row">
    <div class="col-sm-12 centering">
      <span style="font-size:1.8em" class="antonio txt-blue-major">OUR LATEST ARTICLES</span>
    </div>
  </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/the-perl-admbassador-curtis-poe/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/the-perl-ambassador-curtis-poe/curtis-poe.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>The Perl Ambassador: Curtis &#39;Ovid&#39; Poe</h6>
          <p style="line-height:1"><small>The person behind the news of Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/a-tour-with-net-ftp/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/a-tour-with-net-ftp/thumb_kidyes.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>A tour with Net::FTP</h6>
          <p style="line-height:1"><small>How to write an FTP client in Perl</small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/shortcode_test/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/author/brian-d-foy.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>shortcode_test</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/listen-to-larry-wall-s-state-of-the-onion-2000-on-youtube/thumb_larry-wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Listen to Larry Wall&#39;s State of the Onion 2000 on YouTube</h6>
          <p style="line-height:1"><small></small></p>
      </div>
        </a>
    </div>
  
    
    
    <div class="row">
        <a href="http://localhost:1313/article/announcing-perl-7/">
      <div class="col-sm-3">
        <div class="circle-avatar" style="background-image:url(/images/announcing-perl-7/thumb_seven_on_blue_wall.jpg)"></div>
      </div>
      <div class="col-sm-9">
          <h6>Announcing Perl 7</h6>
          <p style="line-height:1"><small>Perl 5 with modern defaults</small></p>
      </div>
        </a>
    </div>
  
</div>
<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
  <script async src="/widget/toplinks/toplinks.js" type="text/javascript"></script>
    <div id="toplinks"></div>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <a class="twitter-timeline" data-height="640" data-dnt="true" data-theme="dark" href="https://twitter.com/perlfoundation?ref_src=twsrc%5Etfw">Tweets by perlfoundation</a> <script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
</div>

<div class="row" style="margin-top:20px">
  <div class="col-sm-12 centering">
    <script src="https://www.reddit.com/r/perl/hot/.embed?limit=10&t=all" type="text/javascript"></script>
  </div>
</div>



          </div>
        </div>
      </div>
    </section>
  </section>
<script>
 
var tables, i;
tables = document.getElementsByTagName('table');
for (i=0;i<tables.length;i++) {
  tables[i].className = 'table table-striped';
}
</script>
<div class="push"></div>
<div class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
        <h5>Site Map</h5>
        <ul>
        <li><a href="/">Home</a></li>
        <hr>
        <li><a href="/about">About</a></li>
        <hr>
        <li><a href="/authors">Authors</a></li>
        <hr>
        <li><a href="/categories">Categories</a></li>
        <hr>
        <li><a href="/tags">Tags</a></li>
        <hr>
        </ul>
      </div>
      <div class="col-md-3">
        <h5>Contact Us</h5>
        <p>To get in touch, send an email to: perl.com-editor@perl.org</p>
        <p><a href="https://perl.org">
              <img src="/images/site/perl-onion_20.png" alt="Perl Onion"></a>
          <a href="https://twitter.com/intent/follow?screen_name=perlfoundation">
              <img src="/images/site/twitter_20.png" alt="twitter"></a>
          <a href="/index.xml" /><img src="/images/site/rss_20.png" alt="rss"></a>
          <a href="https://github.com/tpf/perldotcom">
              <img src="/images/site/github_light_20.png" alt="GitHub logo"></a></p>
      </div>
      <div class="col-md-2">
          <h5>License</h5>
          <p>This work is licensed under a <a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/">Creative Commons Attribution-NonCommercial 3.0 Unported License</a>.</p>
          <p><a rel="license" href="https://creativecommons.org/licenses/by-nc/3.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc/3.0/88x31.png" /></a></p>
      </div>
      <div class="col-md-5">
          <h5>Legal</h5>
          <p>Perl.com and the authors make no representations with respect to the accuracy or completeness of the contents of all work on this website and specifically disclaim all warranties, including without limitation warranties of fitness for a particular purpose. The information published on this website may not be suitable for every situation. All work on this website is provided with the understanding that Perl.com and the authors are not engaged in rendering professional services. Neither Perl.com nor the authors shall be liable for damages arising herefrom.</p>
      </div>
    </div>
  </div>
</div>
<script src="/javascript/jquery.min.js"></script>
<script src="/javascript/bootstrap.min.js"></script>
<script data-no-instant>document.write('<script src="/livereload.js?port=1313&mindelay=10"></' + 'script>')</script></body>
</html>

